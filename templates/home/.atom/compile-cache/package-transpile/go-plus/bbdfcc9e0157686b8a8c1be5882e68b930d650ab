Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Executor = undefined;

var _atom = require('atom');

var _child_process = require('child_process');

var _environment = require('./environment');

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _utils = require('../utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Executor {

  constructor(getConsole) {
    this.getConsole = getConsole;
  }

  dispose() {}

  execSync(command, args = [], options) {
    const opt = this.ensureOptions(options);
    const done = (0, _child_process.spawnSync)(command, args, opt);

    let code = done.status;
    let stdout = '';
    if (done.stdout && done.stdout.length > 0) {
      stdout = done.stdout;
    }
    let stderr = '';
    if (done.stderr && done.stderr.length > 0) {
      stderr = done.stderr;
    }

    let err = done.error;
    if (err) {
      if (err.code) {
        switch (err.code) {
          case 'ENOENT':
            code = 127;
            break;
          case 'ENOTCONN':
            // https://github.com/iojs/io.js/pull/1214
            err = null;
            code = 0;
            break;
        }
      }
    }

    return { exitcode: code, stdout: stdout, stderr: stderr, error: err };
  }

  exec(command, args = [], options) {
    return new Promise(resolve => {
      const opt = this.ensureOptions(options);
      if (!args) {
        args = [];
      }

      let verbose = false;
      if (process.env.GOPLUSDEV || atom.config.get('go-plus.devMode')) {
        verbose = true; // Warning, this will get very verbose when typing
      }
      if (verbose) {
        console.log('executing: ' + command + ' ' + args.join(' ')); // eslint-disable-line no-console
      }

      let stdout = '';
      let stderr = '';
      const stdoutFn = data => {
        stdout += data;
      };
      const stderrFn = data => {
        stderr += data;
      };

      let timeoutId;
      const exitFn = code => {
        if (timeoutId) {
          clearTimeout(timeoutId);
        }
        if (verbose) {
          /* eslint-disable no-console */
          console.log('exited with code: ' + code);
          console.log('stderr: ' + stderr);
          console.log('stdout: ' + stdout);
          /* eslint-enable no-console */
        }
        if (stderr) {
          const nonexistentcommand = "'" + command + "' is not recognized as an internal or external command,operable program or batch file.";
          if (stderr.replace(/\r?\n|\r/g, '') === nonexistentcommand) {
            resolve({
              error: {
                code: 3025,
                errno: 'ENOENT',
                message: 'spawn ' + command + ' ENOENT',
                path: command
              },
              exitcode: 127,
              stdout: stdout,
              stderr: stderr
            });
            return;
          }
        }

        if (code !== 0) {
          const console = this.getConsole();
          if (console) {
            console.error(`${command} ${args.join(' ')} failed with exit code ${code}.`);
            console.warn(`${command} stderr: ${stderr}`);
          }
        }
        resolve({
          error: null,
          exitcode: code,
          stdout: stdout,
          stderr: stderr
        });
      };

      const bufferedprocess = new _atom.BufferedProcess({
        command: command,
        args: args,
        options: opt,
        stdout: stdoutFn,
        stderr: stderrFn,
        exit: exitFn
      });

      if (options.timeout && options.timeout > 0) {
        timeoutId = setTimeout(() => {
          bufferedprocess.kill();
          resolve({
            error: null,
            exitcode: 124,
            stdout: stdout,
            stderr: stderr
          });
        }, options.timeout);
      }
      bufferedprocess.onWillThrowError(err => {
        let e = err;
        if (err) {
          if (err.handle) {
            err.handle();
          }
          if (err.error) {
            e = err.error;
          }
        }
        resolve({
          error: e,
          exitcode: 127,
          stdout: stdout,
          stderr: stderr
        });
      });

      if (opt.input && opt.input.length > 0) {
        bufferedprocess.process.stdin.end(opt.input);
      }
    });
  }

  getOptions(kind = 'file', editor) {
    const result = this.getDefaultOptions(kind, editor);
    return this.ensureOptions(result);
  }

  ensureOptions(options) {
    if (!options.timeout) {
      options.timeout = 10000;
    }
    options.encoding = 'utf8';
    if (!options.env) {
      options.env = (0, _environment.getenvironment)();
    }
    if (options.cwd && options.cwd.length > 0) {
      try {
        options.cwd = _fsExtra2.default.realpathSync(options.cwd);
      } catch (e) {
        if (e.handle) {
          e.handle();
        }
        console.log(e); // eslint-disable-line no-console
      }
    }
    return options;
  }

  getDefaultOptions(key = 'file', editor) {
    let options = {};
    switch (key) {
      case 'file':
        {
          let file = editor && editor.getPath();
          if (file) {
            options.cwd = _path2.default.dirname(file);
          }
          if (!options.cwd) {
            const p = (0, _utils.projectPath)();
            if (p) {
              options.cwd = p;
            }
          }
          break;
        }
      case 'project':
        {
          const p = (0, _utils.projectPath)();
          if (p) {
            options.cwd = p;
          }
          break;
        }
      default:
        throw new Error('Unknown executor option "' + key + '"');
    }
    return options;
  }
}

exports.Executor = Executor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV4ZWN1dG9yLmpzIl0sIm5hbWVzIjpbIkV4ZWN1dG9yIiwiY29uc3RydWN0b3IiLCJnZXRDb25zb2xlIiwiZGlzcG9zZSIsImV4ZWNTeW5jIiwiY29tbWFuZCIsImFyZ3MiLCJvcHRpb25zIiwib3B0IiwiZW5zdXJlT3B0aW9ucyIsImRvbmUiLCJjb2RlIiwic3RhdHVzIiwic3Rkb3V0IiwibGVuZ3RoIiwic3RkZXJyIiwiZXJyIiwiZXJyb3IiLCJleGl0Y29kZSIsImV4ZWMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInZlcmJvc2UiLCJwcm9jZXNzIiwiZW52IiwiR09QTFVTREVWIiwiYXRvbSIsImNvbmZpZyIsImdldCIsImNvbnNvbGUiLCJsb2ciLCJqb2luIiwic3Rkb3V0Rm4iLCJkYXRhIiwic3RkZXJyRm4iLCJ0aW1lb3V0SWQiLCJleGl0Rm4iLCJjbGVhclRpbWVvdXQiLCJub25leGlzdGVudGNvbW1hbmQiLCJyZXBsYWNlIiwiZXJybm8iLCJtZXNzYWdlIiwicGF0aCIsIndhcm4iLCJidWZmZXJlZHByb2Nlc3MiLCJCdWZmZXJlZFByb2Nlc3MiLCJleGl0IiwidGltZW91dCIsInNldFRpbWVvdXQiLCJraWxsIiwib25XaWxsVGhyb3dFcnJvciIsImUiLCJoYW5kbGUiLCJpbnB1dCIsInN0ZGluIiwiZW5kIiwiZ2V0T3B0aW9ucyIsImtpbmQiLCJlZGl0b3IiLCJyZXN1bHQiLCJnZXREZWZhdWx0T3B0aW9ucyIsImVuY29kaW5nIiwiY3dkIiwiZnMiLCJyZWFscGF0aFN5bmMiLCJrZXkiLCJmaWxlIiwiZ2V0UGF0aCIsImRpcm5hbWUiLCJwIiwiRXJyb3IiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBc0JBLE1BQU1BLFFBQU4sQ0FBZTs7QUFHYkMsY0FBWUMsVUFBWixFQUEyQztBQUN6QyxTQUFLQSxVQUFMLEdBQWtCQSxVQUFsQjtBQUNEOztBQUVEQyxZQUFVLENBQUU7O0FBRVpD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Q0FFRSxPQUFPWCxDQUFQLEVBQVU7QUFDVixZQUFJQSxFQUFFQyxNQUFOLEVBQWM7QUFDWkQsWUFBRUMsTUFBRjtBQUNEO0FBQ0R2QixnQkFBUUMsR0FBUixDQUFZcUIsQ0FBWixFQUpVLENBSUs7QUFDaEI7QUFDRjtBQUNELFdBQU81QyxPQUFQO0FBQ0Q7O0FBRURxRCxvQkFDRUssTUFBMEIsTUFENUIsRUFFRVAsTUFGRixFQUdtQjtBQUNqQixRQUFJbkQsVUFBVSxFQUFkO0FBQ0EsWUFBUTBELEdBQVI7QUFDRSxXQUFLLE1BQUw7QUFBYTtBQUNYLGNBQUlDLE9BQU9SLFVBQVVBLE9BQU9TLE9BQVAsRUFBckI7QUFDQSxjQUFJRCxJQUFKLEVBQVU7QUFDUjNELG9CQUFRdUQsR0FBUixHQUFjcEIsZUFBSzBCLE9BQUwsQ0FBYUYsSUFBYixDQUFkO0FBQ0Q7QUFDRCxjQUFJLENBQUMzRCxRQUFRdUQsR0FBYixFQUFrQjtBQUNoQixrQkFBTU8sSUFBSSx5QkFBVjtBQUNBLGdCQUFJQSxDQUFKLEVBQU87QUFDTDlELHNCQUFRdUQsR0FBUixHQUFjTyxDQUFkO0FBQ0Q7QUFDRjtBQUNEO0FBQ0Q7QUFDRCxXQUFLLFNBQUw7QUFBZ0I7QUFDZCxnQkFBTUEsSUFBSSx5QkFBVjtBQUNBLGNBQUlBLENBQUosRUFBTztBQUNMOUQsb0JBQVF1RCxHQUFSLEdBQWNPLENBQWQ7QUFDRDtBQUNEO0FBQ0Q7QUFDRDtBQUNFLGNBQU0sSUFBSUMsS0FBSixDQUFVLDhCQUE4QkwsR0FBOUIsR0FBb0MsR0FBOUMsQ0FBTjtBQXRCSjtBQXdCQSxXQUFPMUQsT0FBUDtBQUNEO0FBbE9ZOztRQXFPTlAsUSxHQUFBQSxRIiwiZmlsZSI6ImV4ZWN1dG9yLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL215dWdhLy5hdG9tL3BhY2thZ2VzL2dvLXBsdXMvbGliL2NvbmZpZyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7IEJ1ZmZlcmVkUHJvY2VzcyB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBzcGF3blN5bmMgfSBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0IHsgZ2V0ZW52aXJvbm1lbnQgfSBmcm9tICcuL2Vudmlyb25tZW50J1xuaW1wb3J0IGZzIGZyb20gJ2ZzLWV4dHJhJ1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCB7IHByb2plY3RQYXRoIH0gZnJvbSAnLi4vdXRpbHMnXG5cbmV4cG9ydCB0eXBlIEV4ZWN1dG9yT3B0aW9ucyA9IHtcbiAgdGltZW91dD86IG51bWJlcixcbiAgZW5jb2Rpbmc/OiBzdHJpbmcsXG4gIGVudj86IHsgW3N0cmluZ106ID9zdHJpbmcgfSxcbiAgY3dkPzogc3RyaW5nLFxuICBpbnB1dD86IHN0cmluZ1xufVxuXG5leHBvcnQgdHlwZSBFeGVjUmVzdWx0ID0ge1xuICBlcnJvcjogP3tcbiAgICBjb2RlOiBudW1iZXIsXG4gICAgZXJybm8/OiBzdHJpbmcsXG4gICAgbWVzc2FnZT86IHN0cmluZyxcbiAgICBwYXRoOiBzdHJpbmdcbiAgfSxcbiAgZXhpdGNvZGU6IG51bWJlcixcbiAgc3Rkb3V0OiBzdHJpbmcgfCBCdWZmZXIsXG4gIHN0ZGVycjogc3RyaW5nIHwgQnVmZmVyXG59XG5cbmNsYXNzIEV4ZWN1dG9yIHtcbiAgZ2V0Q29uc29sZTogKCkgPT4gP0NvbnNvbGVBcGlcblxuICBjb25zdHJ1Y3RvcihnZXRDb25zb2xlOiAoKSA9PiA/Q29uc29sZUFwaSkge1xuICAgIHRoaXMuZ2V0Q29uc29sZSA9IGdldENvbnNvbGVcbiAgfVxuXG4gIGRpc3Bvc2UoKSB7fVxuXG4gIGV4ZWNTeW5jKFxuICAgIGNvbW1hbmQ6IHN0cmluZyxcbiAgICBhcmdzPzogQXJyYXk8c3RyaW5nPiA9IFtdLFxuICAgIG9wdGlvbnM6IEV4ZWN1dG9yT3B0aW9uc1xuICApOiBFeGVjUmVzdWx0IHtcbiAgICBjb25zdCBvcHQ6IGFueSA9IHRoaXMuZW5zdXJlT3B0aW9ucyhvcHRpb25zKVxuICAgIGNvbnN0IGRvbmUgPSBzcGF3blN5bmMoY29tbWFuZCwgYXJncywgb3B0KVxuXG4gICAgbGV0IGNvZGUgPSBkb25lLnN0YXR1c1xuICAgIGxldCBzdGRvdXQgPSAnJ1xuICAgIGlmIChkb25lLnN0ZG91dCAmJiBkb25lLnN0ZG91dC5sZW5ndGggPiAwKSB7XG4gICAgICBzdGRvdXQgPSBkb25lLnN0ZG91dFxuICAgIH1cbiAgICBsZXQgc3RkZXJyID0gJydcbiAgICBpZiAoZG9uZS5zdGRlcnIgJiYgZG9uZS5zdGRlcnIubGVuZ3RoID4gMCkge1xuICAgICAgc3RkZXJyID0gZG9uZS5zdGRlcnJcbiAgICB9XG5cbiAgICBsZXQgZXJyOiBhbnkgPSBkb25lLmVycm9yXG4gICAgaWYgKGVycikge1xuICAgICAgaWYgKGVyci5jb2RlKSB7XG4gICAgICAgIHN3aXRjaCAoZXJyLmNvZGUpIHtcbiAgICAgICAgICBjYXNlICdFTk9FTlQnOlxuICAgICAgICAgICAgY29kZSA9IDEyN1xuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICBjYXNlICdFTk9UQ09OTic6IC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9pb2pzL2lvLmpzL3B1bGwvMTIxNFxuICAgICAgICAgICAgZXJyID0gbnVsbFxuICAgICAgICAgICAgY29kZSA9IDBcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4geyBleGl0Y29kZTogY29kZSwgc3Rkb3V0OiBzdGRvdXQsIHN0ZGVycjogc3RkZXJyLCBlcnJvcjogZXJyIH1cbiAgfVxuXG4gIGV4ZWMoXG4gICAgY29tbWFuZDogc3RyaW5nLFxuICAgIGFyZ3M6IEFycmF5PHN0cmluZz4gPSBbXSxcbiAgICBvcHRpb25zOiBFeGVjdXRvck9wdGlvbnNcbiAgKTogUHJvbWlzZTxFeGVjUmVzdWx0PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgY29uc3Qgb3B0OiBhbnkgPSB0aGlzLmVuc3VyZU9wdGlvbnMob3B0aW9ucylcbiAgICAgIGlmICghYXJncykge1xuICAgICAgICBhcmdzID0gW11cbiAgICAgIH1cblxuICAgICAgbGV0IHZlcmJvc2UgPSBmYWxzZVxuICAgICAgaWYgKHByb2Nlc3MuZW52LkdPUExVU0RFViB8fCBhdG9tLmNvbmZpZy5nZXQoJ2dvLXBsdXMuZGV2TW9kZScpKSB7XG4gICAgICAgIHZlcmJvc2UgPSB0cnVlIC8vIFdhcm5pbmcsIHRoaXMgd2lsbCBnZXQgdmVyeSB2ZXJib3NlIHdoZW4gdHlwaW5nXG4gICAgICB9XG4gICAgICBpZiAodmVyYm9zZSkge1xuICAgICAgICBjb25zb2xlLmxvZygnZXhlY3V0aW5nOiAnICsgY29tbWFuZCArICcgJyArIGFyZ3Muam9pbignICcpKSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgICAgIH1cblxuICAgICAgbGV0IHN0ZG91dCA9ICcnXG4gICAgICBsZXQgc3RkZXJyID0gJydcbiAgICAgIGNvbnN0IHN0ZG91dEZuID0gZGF0YSA9PiB7XG4gICAgICAgIHN0ZG91dCArPSBkYXRhXG4gICAgICB9XG4gICAgICBjb25zdCBzdGRlcnJGbiA9IGRhdGEgPT4ge1xuICAgICAgICBzdGRlcnIgKz0gZGF0YVxuICAgICAgfVxuXG4gICAgICBsZXQgdGltZW91dElkOiBUaW1lb3V0SURcbiAgICAgIGNvbnN0IGV4aXRGbiA9IGNvZGUgPT4ge1xuICAgICAgICBpZiAodGltZW91dElkKSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZClcbiAgICAgICAgfVxuICAgICAgICBpZiAodmVyYm9zZSkge1xuICAgICAgICAgIC8qIGVzbGludC1kaXNhYmxlIG5vLWNvbnNvbGUgKi9cbiAgICAgICAgICBjb25zb2xlLmxvZygnZXhpdGVkIHdpdGggY29kZTogJyArIGNvZGUpXG4gICAgICAgICAgY29uc29sZS5sb2coJ3N0ZGVycjogJyArIHN0ZGVycilcbiAgICAgICAgICBjb25zb2xlLmxvZygnc3Rkb3V0OiAnICsgc3Rkb3V0KVxuICAgICAgICAgIC8qIGVzbGludC1lbmFibGUgbm8tY29uc29sZSAqL1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdGRlcnIpIHtcbiAgICAgICAgICBjb25zdCBub25leGlzdGVudGNvbW1hbmQgPVxuICAgICAgICAgICAgXCInXCIgK1xuICAgICAgICAgICAgY29tbWFuZCArXG4gICAgICAgICAgICBcIicgaXMgbm90IHJlY29nbml6ZWQgYXMgYW4gaW50ZXJuYWwgb3IgZXh0ZXJuYWwgY29tbWFuZCxvcGVyYWJsZSBwcm9ncmFtIG9yIGJhdGNoIGZpbGUuXCJcbiAgICAgICAgICBpZiAoc3RkZXJyLnJlcGxhY2UoL1xccj9cXG58XFxyL2csICcnKSA9PT0gbm9uZXhpc3RlbnRjb21tYW5kKSB7XG4gICAgICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICAgICAgICBjb2RlOiAzMDI1LFxuICAgICAgICAgICAgICAgIGVycm5vOiAnRU5PRU5UJyxcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnc3Bhd24gJyArIGNvbW1hbmQgKyAnIEVOT0VOVCcsXG4gICAgICAgICAgICAgICAgcGF0aDogY29tbWFuZFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICBleGl0Y29kZTogMTI3LFxuICAgICAgICAgICAgICBzdGRvdXQ6IHN0ZG91dCxcbiAgICAgICAgICAgICAgc3RkZXJyOiBzdGRlcnJcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29kZSAhPT0gMCkge1xuICAgICAgICAgIGNvbnN0IGNvbnNvbGUgPSB0aGlzLmdldENvbnNvbGUoKVxuICAgICAgICAgIGlmIChjb25zb2xlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICAgICAgICBgJHtjb21tYW5kfSAke2FyZ3Muam9pbignICcpfSBmYWlsZWQgd2l0aCBleGl0IGNvZGUgJHtjb2RlfS5gXG4gICAgICAgICAgICApXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYCR7Y29tbWFuZH0gc3RkZXJyOiAke3N0ZGVycn1gKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgICBleGl0Y29kZTogY29kZSxcbiAgICAgICAgICBzdGRvdXQ6IHN0ZG91dCxcbiAgICAgICAgICBzdGRlcnI6IHN0ZGVyclxuICAgICAgICB9KVxuICAgICAgfVxuXG4gICAgICBjb25zdCBidWZmZXJlZHByb2Nlc3MgPSBuZXcgQnVmZmVyZWRQcm9jZXNzKHtcbiAgICAgICAgY29tbWFuZDogY29tbWFuZCxcbiAgICAgICAgYXJnczogYXJncyxcbiAgICAgICAgb3B0aW9uczogb3B0LFxuICAgICAgICBzdGRvdXQ6IHN0ZG91dEZuLFxuICAgICAgICBzdGRlcnI6IHN0ZGVyckZuLFxuICAgICAgICBleGl0OiBleGl0Rm5cbiAgICAgIH0pXG5cbiAgICAgIGlmIChvcHRpb25zLnRpbWVvdXQgJiYgb3B0aW9ucy50aW1lb3V0ID4gMCkge1xuICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICBidWZmZXJlZHByb2Nlc3Mua2lsbCgpXG4gICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgICAgIGV4aXRjb2RlOiAxMjQsXG4gICAgICAgICAgICBzdGRvdXQ6IHN0ZG91dCxcbiAgICAgICAgICAgIHN0ZGVycjogc3RkZXJyXG4gICAgICAgICAgfSlcbiAgICAgICAgfSwgb3B0aW9ucy50aW1lb3V0KVxuICAgICAgfVxuICAgICAgYnVmZmVyZWRwcm9jZXNzLm9uV2lsbFRocm93RXJyb3IoZXJyID0+IHtcbiAgICAgICAgbGV0IGUgPSBlcnJcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIGlmIChlcnIuaGFuZGxlKSB7XG4gICAgICAgICAgICBlcnIuaGFuZGxlKClcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKGVyci5lcnJvcikge1xuICAgICAgICAgICAgZSA9IGVyci5lcnJvclxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXNvbHZlKHtcbiAgICAgICAgICBlcnJvcjogZSxcbiAgICAgICAgICBleGl0Y29kZTogMTI3LFxuICAgICAgICAgIHN0ZG91dDogc3Rkb3V0LFxuICAgICAgICAgIHN0ZGVycjogc3RkZXJyXG4gICAgICAgIH0pXG4gICAgICB9KVxuXG4gICAgICBpZiAob3B0LmlucHV0ICYmIG9wdC5pbnB1dC5sZW5ndGggPiAwKSB7XG4gICAgICAgIGJ1ZmZlcmVkcHJvY2Vzcy5wcm9jZXNzLnN0ZGluLmVuZChvcHQuaW5wdXQpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldE9wdGlvbnMoXG4gICAga2luZDogJ2ZpbGUnIHwgJ3Byb2plY3QnID0gJ2ZpbGUnLFxuICAgIGVkaXRvcj86ID9hdG9tJFRleHRFZGl0b3JcbiAgKTogRXhlY3V0b3JPcHRpb25zIHtcbiAgICBjb25zdCByZXN1bHQ6IEV4ZWN1dG9yT3B0aW9ucyA9IHRoaXMuZ2V0RGVmYXVsdE9wdGlvbnMoa2luZCwgZWRpdG9yKVxuICAgIHJldHVybiB0aGlzLmVuc3VyZU9wdGlvbnMocmVzdWx0KVxuICB9XG5cbiAgZW5zdXJlT3B0aW9ucyhvcHRpb25zOiBFeGVjdXRvck9wdGlvbnMpOiBFeGVjdXRvck9wdGlvbnMge1xuICAgIGlmICghb3B0aW9ucy50aW1lb3V0KSB7XG4gICAgICBvcHRpb25zLnRpbWVvdXQgPSAxMDAwMFxuICAgIH1cbiAgICBvcHRpb25zLmVuY29kaW5nID0gJ3V0ZjgnXG4gICAgaWYgKCFvcHRpb25zLmVudikge1xuICAgICAgb3B0aW9ucy5lbnYgPSBnZXRlbnZpcm9ubWVudCgpXG4gICAgfVxuICAgIGlmIChvcHRpb25zLmN3ZCAmJiBvcHRpb25zLmN3ZC5sZW5ndGggPiAwKSB7XG4gICAgICB0cnkge1xuICAgICAgICBvcHRpb25zLmN3ZCA9IGZzLnJlYWxwYXRoU3luYyhvcHRpb25zLmN3ZClcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgaWYgKGUuaGFuZGxlKSB7XG4gICAgICAgICAgZS5oYW5kbGUoKVxuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKGUpIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb3B0aW9uc1xuICB9XG5cbiAgZ2V0RGVmYXVsdE9wdGlvbnMoXG4gICAga2V5OiAnZmlsZScgfCAncHJvamVjdCcgPSAnZmlsZScsXG4gICAgZWRpdG9yPzogP2F0b20kVGV4dEVkaXRvclxuICApOiBFeGVjdXRvck9wdGlvbnMge1xuICAgIGxldCBvcHRpb25zID0ge31cbiAgICBzd2l0Y2ggKGtleSkge1xuICAgICAgY2FzZSAnZmlsZSc6IHtcbiAgICAgICAgbGV0IGZpbGUgPSBlZGl0b3IgJiYgZWRpdG9yLmdldFBhdGgoKVxuICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgIG9wdGlvbnMuY3dkID0gcGF0aC5kaXJuYW1lKGZpbGUpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFvcHRpb25zLmN3ZCkge1xuICAgICAgICAgIGNvbnN0IHAgPSBwcm9qZWN0UGF0aCgpXG4gICAgICAgICAgaWYgKHApIHtcbiAgICAgICAgICAgIG9wdGlvbnMuY3dkID0gcFxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgICAgY2FzZSAncHJvamVjdCc6IHtcbiAgICAgICAgY29uc3QgcCA9IHByb2plY3RQYXRoKClcbiAgICAgICAgaWYgKHApIHtcbiAgICAgICAgICBvcHRpb25zLmN3ZCA9IHBcbiAgICAgICAgfVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmtub3duIGV4ZWN1dG9yIG9wdGlvbiBcIicgKyBrZXkgKyAnXCInKVxuICAgIH1cbiAgICByZXR1cm4gb3B0aW9uc1xuICB9XG59XG5cbmV4cG9ydCB7IEV4ZWN1dG9yIH1cbiJdfQ==