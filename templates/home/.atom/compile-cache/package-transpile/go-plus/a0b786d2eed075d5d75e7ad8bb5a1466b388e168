Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Orchestrator = undefined;

var _atom = require('atom');

var _utils = require('./utils');

class Orchestrator {

  constructor() {
    this.subscriptions = new _atom.CompositeDisposable();
    this.willSaveCallbacks = new Set();
    this.didSaveCallbacks = new Map();
    this.subscribeToEvents();
  }

  dispose() {
    this.subscriptions.dispose();

    this.willSaveCallbacks.clear();
    this.didSaveCallbacks.clear();
  }

  // Register a task to be run by the orchestrator at the appropriate time.
  //
  // Type should be one of 'willSave' or 'didSave'; didSave is the default. The
  // distinction is only present to allow formatting to occur at the appropriate
  // time.
  //
  // willSave callbacks:
  //     These callbacks are invoked synchronously in the order they are registered.
  //     They should have the form `bool callback(editor)`, and should return true
  //     to indicate success so that the callback chain can continue.  A non-true
  //     return value will prevent subsequent callbacks from executing.
  //
  // didSave callbacks:
  //     These callbacks should have the form `Promise callback(editor, path)`.
  //     The resulting promise should resolve to indicate success so that the chain
  //     can continue.  A promise that is rejected will prevent future callbacks
  //     from executing.
  //
  // Register returns a disposable that can be used to unsubscribe the callback.
  register(name, callback, type = 'didSave') {
    if (typeof callback !== 'function') {
      throw new Error('callback must be a function');
    }
    if (type !== 'didSave' && type !== 'willSave') {
      throw new Error('type must be a willSave or didSave');
    }
    if (type === 'willSave') {
      const cb = callback;
      this.willSaveCallbacks.add(cb);
      return new _atom.Disposable(() => {
        if (this.willSaveCallbacks) {
          this.willSaveCallbacks.delete(cb);
        }
      });
    }

    const cb = callback;
    this.didSaveCallbacks.set(name, cb);
    return new _atom.Disposable(() => {
      if (this.didSaveCallbacks) {
        this.didSaveCallbacks.delete(name);
      }
    });
  }

  subscribeToEvents() {
    this.subscriptions.add(atom.workspace.observeTextEditors(editor => {
      if (!(0, _utils.isValidEditor)(editor)) {
        return;
      }
      // subscribe to buffer will-save events:
      const buffer = editor.getBuffer();
      const bufferWillSaveSubscription = buffer.onWillSave(() => {
        this.bufferWillSave(editor);
      });

      // subscribe to buffer did-save events:
      const editorDidSaveSubscription = editor.onDidSave(evt => {
        this.editorDidSave(editor, evt.path).catch(() => {});
      });

      // subscribe to editor destroyed events:
      const editorDestroySubscription = editor.onDidDestroy(() => {
        bufferWillSaveSubscription.dispose();
        editorDestroySubscription.dispose();
        editorDidSaveSubscription.dispose();
        this.subscriptions.remove(bufferWillSaveSubscription);
        this.subscriptions.remove(editorDidSaveSubscription);
        this.subscriptions.remove(editorDestroySubscription);
      });

      // add all subscriptions
      this.subscriptions.add(bufferWillSaveSubscription);
      this.subscriptions.add(editorDidSaveSubscription);
      this.subscriptions.add(editorDestroySubscription);
    }));
  }

  bufferWillSave(editor) {
    for (const cb of this.willSaveCallbacks) {
      const succeeded = cb(editor);
      if (succeeded !== true) {
        break;
      }
    }
  }

  editorDidSave(editor, path) {
    return Array.from(this.didSaveCallbacks.entries()).reduce((p, [, func]) => p.then(() => func(editor, path) || Promise.resolve()), Promise.resolve());
  }
}

exports.Orchestrator = Orchestrator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm9yY2hlc3RyYXRvci5qcyJdLCJuYW1lcyI6WyJPcmNoZXN0cmF0b3IiLCJjb25zdHJ1Y3RvciIsInN1YnNjcmlwdGlvbnMiLCJDb21wb3NpdGVEaXNwb3NhYmxlIiwid2lsbFNhdmVDYWxsYmFja3MiLCJTZXQiLCJkaWRTYXZlQ2FsbGJhY2tzIiwiTWFwIiwic3Vic2NyaWJlVG9FdmVudHMiLCJkaXNwb3NlIiwiY2xlYXIiLCJyZWdpc3RlciIsIm5hbWUiLCJjYWxsYmFjayIsInR5cGUiLCJFcnJvciIsImNiIiwiYWRkIiwiRGlzcG9zYWJsZSIsImRlbGV0ZSIsInNldCIsImF0b20iLCJ3b3Jrc3BhY2UiLCJvYnNlcnZlVGV4dEVkaXRvcnMiLCJlZGl0b3IiLCJidWZmZXIiLCJnZXRCdWZmZXIiLCJidWZmZXJXaWxsU2F2ZVN1YnNjcmlwdGlvbiIsIm9uV2lsbFNhdmUiLCJidWZmZXJXaWxsU2F2ZSIsImVkaXRvckRpZFNhdmVTdWJzY3JpcHRpb24iLCJvbkRpZFNhdmUiLCJldnQiLCJlZGl0b3JEaWRTYXZlIiwicGF0aCIsImNhdGNoIiwiZWRpdG9yRGVzdHJveVN1YnNjcmlwdGlvbiIsIm9uRGlkRGVzdHJveSIsInJlbW92ZSIsInN1Y2NlZWRlZCIsIkFycmF5IiwiZnJvbSIsImVudHJpZXMiLCJyZWR1Y2UiLCJwIiwiZnVuYyIsInRoZW4iLCJQcm9taXNlIiwicmVzb2x2ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7QUFDQTs7QUFRQSxNQUFNQSxZQUFOLENBQW1COztBQUtqQkMsZ0JBQWM7QUFDWixTQUFLQyxhQUFMLEdBQXFCLElBQUlDLHlCQUFKLEVBQXJCO0FBQ0EsU0FBS0MsaUJBQUwsR0FBeUIsSUFBSUMsR0FBSixFQUF6QjtBQUNBLFNBQUtDLGdCQUFMLEdBQXdCLElBQUlDLEdBQUosRUFBeEI7QUFDQSxTQUFLQyxpQkFBTDtBQUNEOztBQUVEQyxZQUFVO0FBQ1IsU0FBS1AsYUFBTCxDQUFtQk8sT0FBbkI7O0FBRUEsU0FBS0wsaUJBQUws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QUFFRE4sZ0JBQWNULE1BQWQsRUFBa0NVLElBQWxDLEVBQStEO0FBQzdELFdBQU9NLE1BQU1DLElBQU4sQ0FBVyxLQUFLbkMsZ0JBQUwsQ0FBc0JvQyxPQUF0QixFQUFYLEVBQTRDQyxNQUE1QyxDQUNMLENBQUNDLENBQUQsRUFBSSxHQUFHQyxJQUFILENBQUosS0FBaUJELEVBQUVFLElBQUYsQ0FBTyxNQUFNRCxLQUFLckIsTUFBTCxFQUFhVSxJQUFiLEtBQXNCYSxRQUFRQyxPQUFSLEVBQW5DLENBRFosRUFFTEQsUUFBUUMsT0FBUixFQUZLLENBQVA7QUFJRDtBQWpIZ0I7O1FBb0hWaEQsWSxHQUFBQSxZIiwiZmlsZSI6Im9yY2hlc3RyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS9teXVnYS8uYXRvbS9wYWNrYWdlcy9nby1wbHVzL2xpYiIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgaXNWYWxpZEVkaXRvciB9IGZyb20gJy4vdXRpbHMnXG5cbnR5cGUgV2lsbFNhdmVDYWxsYmFjayA9IFRleHRFZGl0b3IgPT4gYm9vbGVhblxudHlwZSBEaWRTYXZlQ2FsbGJhY2sgPSAoVGV4dEVkaXRvciwgc3RyaW5nKSA9PiA/UHJvbWlzZTxhbnk+XG5cbmV4cG9ydCB0eXBlIENhbGxiYWNrS2luZCA9ICd3aWxsU2F2ZScgfCAnZGlkU2F2ZSdcbmV4cG9ydCB0eXBlIENhbGxiYWNrID0gV2lsbFNhdmVDYWxsYmFjayB8IERpZFNhdmVDYWxsYmFja1xuXG5jbGFzcyBPcmNoZXN0cmF0b3Ige1xuICBzdWJzY3JpcHRpb25zOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIHdpbGxTYXZlQ2FsbGJhY2tzOiBTZXQ8V2lsbFNhdmVDYWxsYmFjaz5cbiAgZGlkU2F2ZUNhbGxiYWNrczogTWFwPHN0cmluZywgRGlkU2F2ZUNhbGxiYWNrPlxuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLndpbGxTYXZlQ2FsbGJhY2tzID0gbmV3IFNldCgpXG4gICAgdGhpcy5kaWRTYXZlQ2FsbGJhY2tzID0gbmV3IE1hcCgpXG4gICAgdGhpcy5zdWJzY3JpYmVUb0V2ZW50cygpXG4gIH1cblxuICBkaXNwb3NlKCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5kaXNwb3NlKClcblxuICAgIHRoaXMud2lsbFNhdmVDYWxsYmFja3MuY2xlYXIoKVxuICAgIHRoaXMuZGlkU2F2ZUNhbGxiYWNrcy5jbGVhcigpXG4gIH1cblxuICAvLyBSZWdpc3RlciBhIHRhc2sgdG8gYmUgcnVuIGJ5IHRoZSBvcmNoZXN0cmF0b3IgYXQgdGhlIGFwcHJvcHJpYXRlIHRpbWUuXG4gIC8vXG4gIC8vIFR5cGUgc2hvdWxkIGJlIG9uZSBvZiAnd2lsbFNhdmUnIG9yICdkaWRTYXZlJzsgZGlkU2F2ZSBpcyB0aGUgZGVmYXVsdC4gVGhlXG4gIC8vIGRpc3RpbmN0aW9uIGlzIG9ubHkgcHJlc2VudCB0byBhbGxvdyBmb3JtYXR0aW5nIHRvIG9jY3VyIGF0IHRoZSBhcHByb3ByaWF0ZVxuICAvLyB0aW1lLlxuICAvL1xuICAvLyB3aWxsU2F2ZSBjYWxsYmFja3M6XG4gIC8vICAgICBUaGVzZSBjYWxsYmFja3MgYXJlIGludm9rZWQgc3luY2hyb25vdXNseSBpbiB0aGUgb3JkZXIgdGhleSBhcmUgcmVnaXN0ZXJlZC5cbiAgLy8gICAgIFRoZXkgc2hvdWxkIGhhdmUgdGhlIGZvcm0gYGJvb2wgY2FsbGJhY2soZWRpdG9yKWAsIGFuZCBzaG91bGQgcmV0dXJuIHRydWVcbiAgLy8gICAgIHRvIGluZGljYXRlIHN1Y2Nlc3Mgc28gdGhhdCB0aGUgY2FsbGJhY2sgY2hhaW4gY2FuIGNvbnRpbnVlLiAgQSBub24tdHJ1ZVxuICAvLyAgICAgcmV0dXJuIHZhbHVlIHdpbGwgcHJldmVudCBzdWJzZXF1ZW50IGNhbGxiYWNrcyBmcm9tIGV4ZWN1dGluZy5cbiAgLy9cbiAgLy8gZGlkU2F2ZSBjYWxsYmFja3M6XG4gIC8vICAgICBUaGVzZSBjYWxsYmFja3Mgc2hvdWxkIGhhdmUgdGhlIGZvcm0gYFByb21pc2UgY2FsbGJhY2soZWRpdG9yLCBwYXRoKWAuXG4gIC8vICAgICBUaGUgcmVzdWx0aW5nIHByb21pc2Ugc2hvdWxkIHJlc29sdmUgdG8gaW5kaWNhdGUgc3VjY2VzcyBzbyB0aGF0IHRoZSBjaGFpblxuICAvLyAgICAgY2FuIGNvbnRpbnVlLiAgQSBwcm9taXNlIHRoYXQgaXMgcmVqZWN0ZWQgd2lsbCBwcmV2ZW50IGZ1dHVyZSBjYWxsYmFja3NcbiAgLy8gICAgIGZyb20gZXhlY3V0aW5nLlxuICAvL1xuICAvLyBSZWdpc3RlciByZXR1cm5zIGEgZGlzcG9zYWJsZSB0aGF0IGNhbiBiZSB1c2VkIHRvIHVuc3Vic2NyaWJlIHRoZSBjYWxsYmFjay5cbiAgcmVnaXN0ZXIobmFtZTogc3RyaW5nLCBjYWxsYmFjazogQ2FsbGJhY2ssIHR5cGU6IENhbGxiYWNrS2luZCA9ICdkaWRTYXZlJykge1xuICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignY2FsbGJhY2sgbXVzdCBiZSBhIGZ1bmN0aW9uJylcbiAgICB9XG4gICAgaWYgKHR5cGUgIT09ICdkaWRTYXZlJyAmJiB0eXBlICE9PSAnd2lsbFNhdmUnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3R5cGUgbXVzdCBiZSBhIHdpbGxTYXZlIG9yIGRpZFNhdmUnKVxuICAgIH1cbiAgICBpZiAodHlwZSA9PT0gJ3dpbGxTYXZlJykge1xuICAgICAgY29uc3QgY2I6IFdpbGxTYXZlQ2FsbGJhY2sgPSAoKGNhbGxiYWNrOiBhbnkpOiBXaWxsU2F2ZUNhbGxiYWNrKVxuICAgICAgdGhpcy53aWxsU2F2ZUNhbGxiYWNrcy5hZGQoY2IpXG4gICAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy53aWxsU2F2ZUNhbGxiYWNrcykge1xuICAgICAgICAgIHRoaXMud2lsbFNhdmVDYWxsYmFja3MuZGVsZXRlKGNiKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cblxuICAgIGNvbnN0IGNiOiBEaWRTYXZlQ2FsbGJhY2sgPSAoKGNhbGxiYWNrOiBhbnkpOiBEaWRTYXZlQ2FsbGJhY2spXG4gICAgdGhpcy5kaWRTYXZlQ2FsbGJhY2tzLnNldChuYW1lLCBjYilcbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgaWYgKHRoaXMuZGlkU2F2ZUNhbGxiYWNrcykge1xuICAgICAgICB0aGlzLmRpZFNhdmVDYWxsYmFja3MuZGVsZXRlKG5hbWUpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIHN1YnNjcmliZVRvRXZlbnRzKCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoXG4gICAgICBhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoZWRpdG9yID0+IHtcbiAgICAgICAgaWYgKCFpc1ZhbGlkRWRpdG9yKGVkaXRvcikpIHtcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgICAvLyBzdWJzY3JpYmUgdG8gYnVmZmVyIHdpbGwtc2F2ZSBldmVudHM6XG4gICAgICAgIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKVxuICAgICAgICBjb25zdCBidWZmZXJXaWxsU2F2ZVN1YnNjcmlwdGlvbiA9IGJ1ZmZlci5vbldpbGxTYXZlKCgpID0+IHtcbiAgICAgICAgICB0aGlzLmJ1ZmZlcldpbGxTYXZlKGVkaXRvcilcbiAgICAgICAgfSlcblxuICAgICAgICAvLyBzdWJzY3JpYmUgdG8gYnVmZmVyIGRpZC1zYXZlIGV2ZW50czpcbiAgICAgICAgY29uc3QgZWRpdG9yRGlkU2F2ZVN1YnNjcmlwdGlvbiA9IGVkaXRvci5vbkRpZFNhdmUoZXZ0ID0+IHtcbiAgICAgICAgICB0aGlzLmVkaXRvckRpZFNhdmUoZWRpdG9yLCBldnQucGF0aCkuY2F0Y2goKCkgPT4ge30pXG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gc3Vic2NyaWJlIHRvIGVkaXRvciBkZXN0cm95ZWQgZXZlbnRzOlxuICAgICAgICBjb25zdCBlZGl0b3JEZXN0cm95U3Vic2NyaXB0aW9uID0gZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgICAgYnVmZmVyV2lsbFNhdmVTdWJzY3JpcHRpb24uZGlzcG9zZSgpXG4gICAgICAgICAgZWRpdG9yRGVzdHJveVN1YnNjcmlwdGlvbi5kaXNwb3NlKClcbiAgICAgICAgICBlZGl0b3JEaWRTYXZlU3Vic2NyaXB0aW9uLmRpc3Bvc2UoKVxuICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5yZW1vdmUoYnVmZmVyV2lsbFNhdmVTdWJzY3JpcHRpb24pXG4gICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnJlbW92ZShlZGl0b3JEaWRTYXZlU3Vic2NyaXB0aW9uKVxuICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5yZW1vdmUoZWRpdG9yRGVzdHJveVN1YnNjcmlwdGlvbilcbiAgICAgICAgfSlcblxuICAgICAgICAvLyBhZGQgYWxsIHN1YnNjcmlwdGlvbnNcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChidWZmZXJXaWxsU2F2ZVN1YnNjcmlwdGlvbilcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChlZGl0b3JEaWRTYXZlU3Vic2NyaXB0aW9uKVxuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKGVkaXRvckRlc3Ryb3lTdWJzY3JpcHRpb24pXG4gICAgICB9KVxuICAgIClcbiAgfVxuXG4gIGJ1ZmZlcldpbGxTYXZlKGVkaXRvcjogVGV4dEVkaXRvcikge1xuICAgIGZvciAoY29uc3QgY2Igb2YgdGhpcy53aWxsU2F2ZUNhbGxiYWNrcykge1xuICAgICAgY29uc3Qgc3VjY2VlZGVkID0gY2IoZWRpdG9yKVxuICAgICAgaWYgKHN1Y2NlZWRlZCAhPT0gdHJ1ZSkge1xuICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGVkaXRvckRpZFNhdmUoZWRpdG9yOiBUZXh0RWRpdG9yLCBwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmRpZFNhdmVDYWxsYmFja3MuZW50cmllcygpKS5yZWR1Y2UoXG4gICAgICAocCwgWywgZnVuY10pID0+IHAudGhlbigoKSA9PiBmdW5jKGVkaXRvciwgcGF0aCkgfHwgUHJvbWlzZS5yZXNvbHZlKCkpLFxuICAgICAgUHJvbWlzZS5yZXNvbHZlKClcbiAgICApXG4gIH1cbn1cblxuZXhwb3J0IHsgT3JjaGVzdHJhdG9yIH1cbiJdfQ==