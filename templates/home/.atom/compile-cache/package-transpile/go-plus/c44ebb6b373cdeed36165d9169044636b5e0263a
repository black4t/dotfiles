Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.GetManager = undefined;

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _atom = require('atom');

var _simpleDialog = require('./../simple-dialog');

var _promise = require('./../promise');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class GetManager {

  constructor(goconfig, outputFunc, busySignal) {
    this.goconfig = goconfig;
    this.outputFunc = outputFunc;
    this.busySignal = busySignal;
    this.packages = new Map();
    this.onDidUpdateTools = new Set();
    this.subscriptions = new _atom.CompositeDisposable();
    this.subscriptions.add(atom.commands.add(atom.views.getView(atom.workspace), 'golang:get-package', () => this.getPackage()));
    this.subscriptions.add(atom.commands.add(atom.views.getView(atom.workspace), 'golang:update-tools', event => {
      this.outputFunc().update({
        output: 'Updating tools...',
        exitcode: 1
      });
      let filter = [];
      if (event && event.detail && Array.isArray(event.detail)) {
        filter = event.detail;
      }
      this.updateTools(filter);
    }));
  }

  getSelectedText() {
    const editor = atom.workspace.getActiveTextEditor();
    if (!editor) {
      return '';
    }
    const selections = editor.getSelections();
    if (!selections || selections.length < 1) {
      return '';
    }

    return selections[0].getText();
  }

  register(importPath, callback) {
    if (!importPath || !importPath.length) {
      return new _atom.Disposable();
    }
    let count = 1;
    if (this.packages && this.packages.has(importPath)) {
      count = this.packages.get(importPath) + 1;
    }
    if (this.packages) {
      this.packages.set(importPath, count);
    }

    if (callback && this.onDidUpdateTools && !this.onDidUpdateTools.has(callback)) {
      this.onDidUpdateTools.add(callback);
    }

    return new _atom.Disposable(() => {
      if (!this.packages) {
        return;
      }
      const count = this.packages.get(importPath) || 0;
      if (count === 1) {
        this.packages.delete(importPath);
      } else if (count > 1) {
        this.packages.set(importPath, count - 1);
      }
      if (callback && this.onDidUpdateTools && this.onDidUpdateTools.has(callback)) {
        this.onDidUpdateTools.delete(callback);
      }
    });
  }

  async updateTools(filter) {
    if (!this.packages || this.packages.size === 0) {
      return { success: false, result: null, results: null };
    }

    let packs = [...this.packages.keys()];
    if (filter && Array.isArray(filter) && filter.length > 0) {
      packs = filter;
    }
    const bs = this.busySignal();
    const getPromise = this.performGet(packs);
    const p = bs ? bs.reportBusyWhile('Updating Go Tools', () => getPromise) : getPromise;
    const outcome = await p;
    if (this.onDidUpdateTools) {
      for (const cb of this.onDidUpdateTools) {
        cb(outcome, packs);
      }
    }
    return outcome;
  }

  // Shows a dialog which can be used to perform `go get -u {pack}`. Optionally
  // populates the dialog with the selected text from the active editor.
  getPackage() {
    const selectedText = this.getSelectedText();
    const dialog = new _simpleDialog.SimpleDialog({
      prompt: 'Which Go Package Would You Like To Get?',
      initialValue: selectedText,
      onConfirm: pkg => {
        this.performGet(pkg).then(outcome => outcome && outcome.result && outcome.result.execResult && this.displayResult(pkg, outcome.result.execResult)).catch(e => console.log(e)); // eslint-disable-line no-console
      }
    });
    dialog.attach();
  }

  displayResult(pack, r) {
    if (r.error) {
      if (r.error.code === 'ENOENT') {
        atom.notifications.addError('Missing Go Tool', {
          detail: 'The go tool is required to perform a get. Please ensure you have a go runtime installed: http://golang.org.',
          dismissable: true
        });
      } else {
        atom.notifications.addError('Error Getting Package', {
          detail: r.error && r.error.message ? r.error.message : '',
          dismissable: true
        });
      }
      return;
    }
    const stderr = r.stderr instanceof Buffer ? r.stderr.toString() : r.stderr;
    const stdout = r.stdout instanceof Buffer ? r.stdout.toString() : r.stdout;

    if (r.exitcode !== 0 || stderr && stderr.trim() !== '') {
      const message = stderr.trim() + '\r\n' + stdout.trim();
      atom.notifications.addWarning('Error Getting Package', {
        detail: message.trim(),
        dismissable: true
      });
      return;
    }

    atom.notifications.addSuccess('go get -u ' + pack);
  }

  // Runs `go get -u {pack}`.
  async performGet(pack) {
    if (typeof pack === 'string') {
      pack = [pack];
    }

    const packages = pack.filter(p => p.length > 0);
    if (pack.length === 0 || !this.goconfig || !this.goconfig.locator) {
      return { success: false, result: null, results: null };
    }
    const cmd = await this.goconfig.locator.findTool('go');
    if (!cmd) {
      atom.notifications.addError('Missing Go Tool', {
        detail: 'The go tool is required to perform a get. Please ensure you have a go runtime installed: http://golang.org.',
        dismissable: true
      });
      return { success: false, result: null, results: null };
    }

    const executorOptions = this.goconfig.executor.getOptions('project');
    const timeout = atom.config.get('go-plus.get.timeout');
    if (typeof timeout === 'number') {
      executorOptions.timeout = timeout;
    }

    // disable Go 1.11 modules, so that updating tools does not inadvertently
    // add new dependencies to the user's project
    executorOptions.env = _extends({}, executorOptions.env, {
      GO111MODULE: 'off'
    });

    let getOutput = '';
    const promises = packages.map(pkg => async () => {
      const args = ['get', '-u', pkg];
      getOutput += '$ go ' + args.join(' ') + _os2.default.EOL;
      this.outputFunc().update({ output: getOutput });
      const r = await this.goconfig.executor.exec(cmd, args, executorOptions);
      const result = {
        execResult: r,
        cmd,
        pack: pkg,
        args: args
      };
      const stdout = r.stdout instanceof Buffer ? r.stdout.toString() : r.stdout;
      const stderr = r.stderr instanceof Buffer ? r.stderr.toString() : r.stderr;

      if (stderr && stderr.length) {
        getOutput += stderr + _os2.default.EOL;
      }
      if (stdout && stdout.length) {
        getOutput += stdout + _os2.default.EOL;
      }
      this.outputFunc().update({
        output: getOutput
      });

      return result;
    });

    const results = await (0, _promise.promiseWaterfall)(promises);
    if (!results || results.length < 1) {
      return { success: false, result: null, results: null };
    }
    let success = true;
    for (const r of results) {
      const er = r.execResult;
      const stderr = er.stderr instanceof Buffer ? er.stderr.toString() : er.stderr;
      if (er.error || er.exitcode !== 0 || stderr && stderr.trim() !== '') {
        success = false;
        break;
      }
    }
    return { success: success, result: results[0], results: results };
  }

  // Creates a notification that can be used to run `go get -u {options.packagePath}`.
  // * `options` (required) {Object}
  //   * `name` (required) {String} e.g. go-plus
  //   * `packageName` (required) {String} e.g. goimports
  //   * `packagePath` (required) {String} e.g. golang.org/x/tools/cmd/goimports
  //   * `type` (required) {String} one of 'missing' or 'outdated' (used to customize the prompt)
  async get(options) {
    if (!options || !options.name || !options.packageName || !options.packagePath || !options.type) {
      return null;
    }
    if (!['missing', 'outdated'].includes(options.type)) {
      return null;
    }

    const detail = options.type === 'outdated' ? `An update is available for the ${options.packageName} tool.  This is used by the ${options.name} package.` : `The ${options.name} package uses the ${options.packageName} tool, but it cannot be found.`;

    const p = new Promise(resolve => {
      let wasClicked = false;
      const notification = atom.notifications.addInfo('Go Get', {
        dismissable: true,
        icon: 'cloud-download',
        detail: detail,
        description: 'Would you like to run `go get -u` [`' + options.packagePath + '`](http://' + options.packagePath + ')?',
        buttons: [{
          text: 'Run Go Get',
          onDidClick: async () => {
            wasClicked = true;
            notification.dismiss();
            const outcome = await this.performGet(options.packagePath);
            if (outcome && outcome.result && outcome.result.execResult) this.displayResult(options.packagePath, outcome.result.execResult);
            resolve(outcome);
          }
        }]
      });
      notification.onDidDismiss(() => {
        if (!wasClicked) {
          resolve(null);
        }
      });
    });
    return await p;
  }

  dispose() {
    if (this.subscriptions) {
      this.subscriptions.dispose();
    }
    this.packages.clear();
    this.onDidUpdateTools.clear();
  }
}
exports.GetManager = GetManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdldC1tYW5hZ2VyLmpzIl0sIm5hbWVzIjpbIkdldE1hbmFnZXIiLCJjb25zdHJ1Y3RvciIsImdvY29uZmlnIiwib3V0cHV0RnVuYyIsImJ1c3lTaWduYWwiLCJwYWNrYWdlcyIsIk1hcCIsIm9uRGlkVXBkYXRlVG9vbHMiLCJTZXQiLCJzdWJzY3JpcHRpb25zIiwiQ29tcG9zaXRlRGlzcG9zYWJsZSIsImFkZCIsImF0b20iLCJjb21tYW5kcyIsInZpZXdzIiwiZ2V0VmlldyIsIndvcmtzcGFjZSIsImdldFBhY2thZ2UiLCJldmVudCIsInVwZGF0ZSIsIm91dHB1dCIsImV4aXRjb2RlIiwiZmlsdGVyIiwiZGV0YWlsIiwiQXJyYXkiLCJpc0FycmF5IiwidXBkYXRlVG9vbHMiLCJnZXRTZWxlY3RlZFRleHQiLCJlZGl0b3IiLCJnZXRBY3RpdmVUZXh0RWRpdG9yIiwic2VsZWN0aW9ucyIsImdldFNlbGVjdGlvbnMiLCJsZW5ndGgiLCJnZXRUZXh0IiwicmVnaXN0ZXIiLCJpbXBvcnRQYXRoIiwiY2FsbGJhY2siLCJEaXNwb3NhYmxlIiwiY291bnQiLCJoYXMiLCJnZXQiLCJzZXQiLCJkZWxldGUiLCJzaXplIiwic3VjY2VzcyIsInJlc3VsdCIsInJlc3VsdHMiLCJwYWNrcyIsImtleXMiLCJicyIsImdldFByb21pc2UiLCJwZXJmb3JtR2V0IiwicCIsInJlcG9ydEJ1c3lXaGlsZSIsIm91dGNvbWUiLCJjYiIsInNlbGVjdGVkVGV4dCIsImRpYWxvZyIsIlNpbXBsZURpYWxvZyIsInByb21wdCIsImluaXRpYWxWYWx1ZSIsIm9uQ29uZmlybSIsInBrZyIsInRoZW4iLCJleGVjUmVzdWx0IiwiZGlzcGxheVJlc3VsdCIsImNhdGNoIiwiZSIsImNvbnNvbGUiLCJsb2ciLCJhdHRhY2giLCJwYWNrIiwiciIsImVycm9yIiwiY29kZSIsIm5vdGlmaWNhdGlvbnMiLCJhZGRFcnJvciIsImRpc21pc3NhYmxlIiwibWVzc2FnZSIsInN0ZGVyciIsIkJ1ZmZlciIsInRvU3RyaW5nIiwic3Rkb3V0IiwidHJpbSIsImFkZFdhcm5pbmciLCJhZGRTdWNjZXNzIiwibG9jYXRvciIsImNtZCIsImZpbmRUb29sIiwiZXhlY3V0b3JPcHRpb25zIiwiZXhlY3V0b3IiLCJnZXRPcHRpb25zIiwidGltZW91dCIsImNvbmZpZyIsImVudiIsIkdPMTExTU9EVUxFIiwiZ2V0T3V0cHV0IiwicHJvbWlzZXMiLCJtYXAiLCJhcmdzIiwiam9pbiIsIm9zIiwiRU9MIiwiZXhlYyIsImVyIiwib3B0aW9ucyIsIm5hbWUiLCJwYWNrYWdlTmFtZSIsInBhY2thZ2VQYXRoIiwidHlwZSIsImluY2x1ZGVzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJ3YXNDbGlja2VkIiwibm90aWZpY2F0aW9uIiwiYWRkSW5mbyIsImljb24iLCJkZXNjcmlwdGlvbiIsImJ1dHRvbnMiLCJ0ZXh0Iiwib25EaWRDbGljayIsImRpc21pc3MiLCJvbkRpZERpc21pc3MiLCJkaXNwb3NlIiwiY2xlYXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBeUJBLE1BQU1BLFVBQU4sQ0FBaUI7O0FBUWZDLGNBQ0VDLFFBREYsRUFFRUMsVUFGRixFQUdFQyxVQUhGLEVBSUU7QUFDQSxTQUFLRixRQUFMLEdBQWdCQSxRQUFoQjtBQUNBLFNBQUtDLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0MsVUFBTCxHQUFrQkEsVUFBbEI7QUFDQSxTQUFLQyxRQUFMLEdBQWdCLElBQUlDLEdBQUosRUFBaEI7QUFDQSxTQUFLQyxnQkFBTCxHQUF3QixJQUFJQyxHQUFKLEVBQXhCO0FBQ0EsU0FBS0MsYUFBTCxHQUFxQixJQUFJQyx5QkFBSixFQUFyQjtBQUNBLFNBQUtELGFBQUwsQ0FBbUJFLEdBQW5CLENBQ0VDLEtBQUtDLFFBQUwsQ0FBY0YsR0FBZCxDQUNFQyxLQUFLRSxLQUFMLENBQVdDLE9BQVgsQ0FBbUJILEtBQUtJLFNBQXhCLENBREYsRUFFRSxvQkFGRixFQUdFLE1BQU0sS0FBS0MsVUFB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QUFwQztBQXFDQSxXQUFPLE1BQU01RCxDQUFiO0FBQ0Q7O0FBRUR1RSxZQUFVO0FBQ1IsUUFBSSxLQUFLbEgsYUFBVCxFQUF3QjtBQUN0QixXQUFLQSxhQUFMLENBQW1Ca0gsT0FBbkI7QUFDRDtBQUNELFNBQUt0SCxRQUFMLENBQWN1SCxLQUFkO0FBQ0EsU0FBS3JILGdCQUFMLENBQXNCcUgsS0FBdEI7QUFDRDtBQTlVYztRQWdWUjVILFUsR0FBQUEsVSIsImZpbGUiOiJnZXQtbWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS9teXVnYS8uYXRvbS9wYWNrYWdlcy9nby1wbHVzL2xpYi9nZXQiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgb3MgZnJvbSAnb3MnXG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlLCBEaXNwb3NhYmxlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IFNpbXBsZURpYWxvZyB9IGZyb20gJy4vLi4vc2ltcGxlLWRpYWxvZydcbmltcG9ydCB7IHByb21pc2VXYXRlcmZhbGwgfSBmcm9tICcuLy4uL3Byb21pc2UnXG5pbXBvcnQgdHlwZSB7IEdvQ29uZmlnIH0gZnJvbSAnLi8uLi9jb25maWcvc2VydmljZSdcbmltcG9ydCB0eXBlIHsgRXhlY1Jlc3VsdCB9IGZyb20gJy4vLi4vY29uZmlnL2V4ZWN1dG9yJ1xuaW1wb3J0IHR5cGUgeyBPdXRwdXRNYW5hZ2VyIH0gZnJvbSAnLi8uLi9vdXRwdXQtbWFuYWdlcidcblxudHlwZSBHZXRSZXN1bHQgPSB7XG4gIGV4ZWNSZXN1bHQ6IEV4ZWNSZXN1bHQsXG4gIGNtZDogc3RyaW5nLFxuICBwYWNrOiBzdHJpbmcsXG4gIGFyZ3M6IEFycmF5PHN0cmluZz5cbn1cblxuZXhwb3J0IHR5cGUgTXVsdGlHZXRSZXN1bHQgPSB7XG4gIHN1Y2Nlc3M6IGJvb2xlYW4sXG4gIHJlc3VsdDogP0dldFJlc3VsdCxcbiAgcmVzdWx0czogP0FycmF5PEdldFJlc3VsdD5cbn1cblxuZXhwb3J0IHR5cGUgSW50ZXJhY3RpdmVHZXRPcHRpb25zID0ge1xuICBuYW1lOiBzdHJpbmcsXG4gIHBhY2thZ2VOYW1lOiBzdHJpbmcsXG4gIHBhY2thZ2VQYXRoOiBzdHJpbmcsXG4gIHR5cGU6ICdtaXNzaW5nJyB8ICdvdXRkYXRlZCdcbn1cblxuY2xhc3MgR2V0TWFuYWdlciB7XG4gIGdvY29uZmlnOiBHb0NvbmZpZ1xuICBvdXRwdXRGdW5jOiAoKSA9PiBPdXRwdXRNYW5hZ2VyXG4gIGJ1c3lTaWduYWw6ICgpID0+ID9CdXN5U2lnbmFsU2VydmljZVxuICBwYWNrYWdlczogTWFwPHN0cmluZywgbnVtYmVyPlxuICBvbkRpZFVwZGF0ZVRvb2xzOiBTZXQ8KE11bHRpR2V0UmVzdWx0LCBBcnJheTxzdHJpbmc+KSA9PiB2b2lkPlxuICBzdWJzY3JpcHRpb25zOiBDb21wb3NpdGVEaXNwb3NhYmxlXG5cbiAgY29uc3RydWN0b3IoXG4gICAgZ29jb25maWc6IEdvQ29uZmlnLFxuICAgIG91dHB1dEZ1bmM6ICgpID0+IE91dHB1dE1hbmFnZXIsXG4gICAgYnVzeVNpZ25hbDogKCkgPT4gP0J1c3lTaWduYWxTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuZ29jb25maWcgPSBnb2NvbmZpZ1xuICAgIHRoaXMub3V0cHV0RnVuYyA9IG91dHB1dEZ1bmNcbiAgICB0aGlzLmJ1c3lTaWduYWwgPSBidXN5U2lnbmFsXG4gICAgdGhpcy5wYWNrYWdlcyA9IG5ldyBNYXAoKVxuICAgIHRoaXMub25EaWRVcGRhdGVUb29scyA9IG5ldyBTZXQoKVxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKFxuICAgICAgYXRvbS5jb21tYW5kcy5hZGQoXG4gICAgICAgIGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSksXG4gICAgICAgICdnb2xhbmc6Z2V0LXBhY2thZ2UnLFxuICAgICAgICAoKSA9PiB0aGlzLmdldFBhY2thZ2UoKVxuICAgICAgKVxuICAgIClcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKFxuICAgICAgYXRvbS5jb21tYW5kcy5hZGQoXG4gICAgICAgIGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSksXG4gICAgICAgICdnb2xhbmc6dXBkYXRlLXRvb2xzJyxcbiAgICAgICAgZXZlbnQgPT4ge1xuICAgICAgICAgIHRoaXMub3V0cHV0RnVuYygpLnVwZGF0ZSh7XG4gICAgICAgICAgICBvdXRwdXQ6ICdVcGRhdGluZyB0b29scy4uLicsXG4gICAgICAgICAgICBleGl0Y29kZTogMVxuICAgICAgICAgIH0pXG4gICAgICAgICAgbGV0IGZpbHRlciA9IFtdXG4gICAgICAgICAgaWYgKGV2ZW50ICYmIGV2ZW50LmRldGFpbCAmJiBBcnJheS5pc0FycmF5KGV2ZW50LmRldGFpbCkpIHtcbiAgICAgICAgICAgIGZpbHRlciA9IGV2ZW50LmRldGFpbFxuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnVwZGF0ZVRvb2xzKGZpbHRlcilcbiAgICAgICAgfVxuICAgICAgKVxuICAgIClcbiAgfVxuXG4gIGdldFNlbGVjdGVkVGV4dCgpIHtcbiAgICBjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKClcbiAgICBpZiAoIWVkaXRvcikge1xuICAgICAgcmV0dXJuICcnXG4gICAgfVxuICAgIGNvbnN0IHNlbGVjdGlvbnMgPSBlZGl0b3IuZ2V0U2VsZWN0aW9ucygpXG4gICAgaWYgKCFzZWxlY3Rpb25zIHx8IHNlbGVjdGlvbnMubGVuZ3RoIDwgMSkge1xuICAgICAgcmV0dXJuICcnXG4gICAgfVxuXG4gICAgcmV0dXJuIHNlbGVjdGlvbnNbMF0uZ2V0VGV4dCgpXG4gIH1cblxuICByZWdpc3RlcihcbiAgICBpbXBvcnRQYXRoOiBzdHJpbmcsXG4gICAgY2FsbGJhY2s6ID8oTXVsdGlHZXRSZXN1bHQsIEFycmF5PHN0cmluZz4pID0+IHZvaWRcbiAgKTogRGlzcG9zYWJsZSB7XG4gICAgaWYgKCFpbXBvcnRQYXRoIHx8ICFpbXBvcnRQYXRoLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKClcbiAgICB9XG4gICAgbGV0IGNvdW50ID0gMVxuICAgIGlmICh0aGlzLnBhY2thZ2VzICYmIHRoaXMucGFja2FnZXMuaGFzKGltcG9ydFBhdGgpKSB7XG4gICAgICBjb3VudCA9IHRoaXMucGFja2FnZXMuZ2V0KGltcG9ydFBhdGgpICsgMVxuICAgIH1cbiAgICBpZiAodGhpcy5wYWNrYWdlcykge1xuICAgICAgdGhpcy5wYWNrYWdlcy5zZXQoaW1wb3J0UGF0aCwgY291bnQpXG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgY2FsbGJhY2sgJiZcbiAgICAgIHRoaXMub25EaWRVcGRhdGVUb29scyAmJlxuICAgICAgIXRoaXMub25EaWRVcGRhdGVUb29scy5oYXMoY2FsbGJhY2spXG4gICAgKSB7XG4gICAgICB0aGlzLm9uRGlkVXBkYXRlVG9vbHMuYWRkKGNhbGxiYWNrKVxuICAgIH1cblxuICAgIHJldHVybiBuZXcgRGlzcG9zYWJsZSgoKSA9PiB7XG4gICAgICBpZiAoIXRoaXMucGFja2FnZXMpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBjb25zdCBjb3VudCA9IHRoaXMucGFja2FnZXMuZ2V0KGltcG9ydFBhdGgpIHx8IDBcbiAgICAgIGlmIChjb3VudCA9PT0gMSkge1xuICAgICAgICB0aGlzLnBhY2thZ2VzLmRlbGV0ZShpbXBvcnRQYXRoKVxuICAgICAgfSBlbHNlIGlmIChjb3VudCA+IDEpIHtcbiAgICAgICAgdGhpcy5wYWNrYWdlcy5zZXQoaW1wb3J0UGF0aCwgY291bnQgLSAxKVxuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBjYWxsYmFjayAmJlxuICAgICAgICB0aGlzLm9uRGlkVXBkYXRlVG9vbHMgJiZcbiAgICAgICAgdGhpcy5vbkRpZFVwZGF0ZVRvb2xzLmhhcyhjYWxsYmFjaylcbiAgICAgICkge1xuICAgICAgICB0aGlzLm9uRGlkVXBkYXRlVG9vbHMuZGVsZXRlKGNhbGxiYWNrKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBhc3luYyB1cGRhdGVUb29scyhmaWx0ZXI6IEFycmF5PHN0cmluZz4pOiBQcm9taXNlPE11bHRpR2V0UmVzdWx0PiB7XG4gICAgaWYgKCF0aGlzLnBhY2thZ2VzIHx8IHRoaXMucGFja2FnZXMuc2l6ZSA9PT0gMCkge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlc3VsdDogbnVsbCwgcmVzdWx0czogbnVsbCB9XG4gICAgfVxuXG4gICAgbGV0IHBhY2tzID0gWy4uLnRoaXMucGFja2FnZXMua2V5cygpXVxuICAgIGlmIChmaWx0ZXIgJiYgQXJyYXkuaXNBcnJheShmaWx0ZXIpICYmIGZpbHRlci5sZW5ndGggPiAwKSB7XG4gICAgICBwYWNrcyA9IGZpbHRlclxuICAgIH1cbiAgICBjb25zdCBicyA9IHRoaXMuYnVzeVNpZ25hbCgpXG4gICAgY29uc3QgZ2V0UHJvbWlzZSA9IHRoaXMucGVyZm9ybUdldChwYWNrcylcbiAgICBjb25zdCBwID0gYnNcbiAgICAgID8gYnMucmVwb3J0QnVzeVdoaWxlKCdVcGRhdGluZyBHbyBUb29scycsICgpID0+IGdldFByb21pc2UpXG4gICAgICA6IGdldFByb21pc2VcbiAgICBjb25zdCBvdXRjb21lID0gYXdhaXQgcFxuICAgIGlmICh0aGlzLm9uRGlkVXBkYXRlVG9vbHMpIHtcbiAgICAgIGZvciAoY29uc3QgY2Igb2YgdGhpcy5vbkRpZFVwZGF0ZVRvb2xzKSB7XG4gICAgICAgIGNiKG91dGNvbWUsIHBhY2tzKVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb3V0Y29tZVxuICB9XG5cbiAgLy8gU2hvd3MgYSBkaWFsb2cgd2hpY2ggY2FuIGJlIHVzZWQgdG8gcGVyZm9ybSBgZ28gZ2V0IC11IHtwYWNrfWAuIE9wdGlvbmFsbHlcbiAgLy8gcG9wdWxhdGVzIHRoZSBkaWFsb2cgd2l0aCB0aGUgc2VsZWN0ZWQgdGV4dCBmcm9tIHRoZSBhY3RpdmUgZWRpdG9yLlxuICBnZXRQYWNrYWdlKCkge1xuICAgIGNvbnN0IHNlbGVjdGVkVGV4dCA9IHRoaXMuZ2V0U2VsZWN0ZWRUZXh0KClcbiAgICBjb25zdCBkaWFsb2cgPSBuZXcgU2ltcGxlRGlhbG9nKHtcbiAgICAgIHByb21wdDogJ1doaWNoIEdvIFBhY2thZ2UgV291bGQgWW91IExpa2UgVG8gR2V0PycsXG4gICAgICBpbml0aWFsVmFsdWU6IHNlbGVjdGVkVGV4dCxcbiAgICAgIG9uQ29uZmlybTogcGtnID0+IHtcbiAgICAgICAgdGhpcy5wZXJmb3JtR2V0KHBrZylcbiAgICAgICAgICAudGhlbihcbiAgICAgICAgICAgIG91dGNvbWUgPT5cbiAgICAgICAgICAgICAgb3V0Y29tZSAmJlxuICAgICAgICAgICAgICBvdXRjb21lLnJlc3VsdCAmJlxuICAgICAgICAgICAgICBvdXRjb21lLnJlc3VsdC5leGVjUmVzdWx0ICYmXG4gICAgICAgICAgICAgIHRoaXMuZGlzcGxheVJlc3VsdChwa2csIG91dGNvbWUucmVzdWx0LmV4ZWNSZXN1bHQpXG4gICAgICAgICAgKVxuICAgICAgICAgIC5jYXRjaChlID0+IGNvbnNvbGUubG9nKGUpKSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgICAgIH1cbiAgICB9KVxuICAgIGRpYWxvZy5hdHRhY2goKVxuICB9XG5cbiAgZGlzcGxheVJlc3VsdChwYWNrOiBzdHJpbmcsIHI6IEV4ZWNSZXN1bHQpIHtcbiAgICBpZiAoci5lcnJvcikge1xuICAgICAgaWYgKHIuZXJyb3IuY29kZSA9PT0gJ0VOT0VOVCcpIHtcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKCdNaXNzaW5nIEdvIFRvb2wnLCB7XG4gICAgICAgICAgZGV0YWlsOlxuICAgICAgICAgICAgJ1RoZSBnbyB0b29sIGlzIHJlcXVpcmVkIHRvIHBlcmZvcm0gYSBnZXQuIFBsZWFzZSBlbnN1cmUgeW91IGhhdmUgYSBnbyBydW50aW1lIGluc3RhbGxlZDogaHR0cDovL2dvbGFuZy5vcmcuJyxcbiAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKCdFcnJvciBHZXR0aW5nIFBhY2thZ2UnLCB7XG4gICAgICAgICAgZGV0YWlsOiByLmVycm9yICYmIHIuZXJyb3IubWVzc2FnZSA/IHIuZXJyb3IubWVzc2FnZSA6ICcnLFxuICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3Qgc3RkZXJyID0gci5zdGRlcnIgaW5zdGFuY2VvZiBCdWZmZXIgPyByLnN0ZGVyci50b1N0cmluZygpIDogci5zdGRlcnJcbiAgICBjb25zdCBzdGRvdXQgPSByLnN0ZG91dCBpbnN0YW5jZW9mIEJ1ZmZlciA/IHIuc3Rkb3V0LnRvU3RyaW5nKCkgOiByLnN0ZG91dFxuXG4gICAgaWYgKHIuZXhpdGNvZGUgIT09IDAgfHwgKHN0ZGVyciAmJiBzdGRlcnIudHJpbSgpICE9PSAnJykpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBzdGRlcnIudHJpbSgpICsgJ1xcclxcbicgKyBzdGRvdXQudHJpbSgpXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZygnRXJyb3IgR2V0dGluZyBQYWNrYWdlJywge1xuICAgICAgICBkZXRhaWw6IG1lc3NhZ2UudHJpbSgpLFxuICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZVxuICAgICAgfSlcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRTdWNjZXNzKCdnbyBnZXQgLXUgJyArIHBhY2spXG4gIH1cblxuICAvLyBSdW5zIGBnbyBnZXQgLXUge3BhY2t9YC5cbiAgYXN5bmMgcGVyZm9ybUdldChwYWNrOiBzdHJpbmcgfCBBcnJheTxzdHJpbmc+KTogUHJvbWlzZTxNdWx0aUdldFJlc3VsdD4ge1xuICAgIGlmICh0eXBlb2YgcGFjayA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHBhY2sgPSBbcGFja11cbiAgICB9XG5cbiAgICBjb25zdCBwYWNrYWdlczogQXJyYXk8c3RyaW5nPiA9IHBhY2suZmlsdGVyKHAgPT4gcC5sZW5ndGggPiAwKVxuICAgIGlmIChwYWNrLmxlbmd0aCA9PT0gMCB8fCAhdGhpcy5nb2NvbmZpZyB8fCAhdGhpcy5nb2NvbmZpZy5sb2NhdG9yKSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVzdWx0OiBudWxsLCByZXN1bHRzOiBudWxsIH1cbiAgICB9XG4gICAgY29uc3QgY21kID0gYXdhaXQgdGhpcy5nb2NvbmZpZy5sb2NhdG9yLmZpbmRUb29sKCdnbycpXG4gICAgaWYgKCFjbWQpIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcignTWlzc2luZyBHbyBUb29sJywge1xuICAgICAgICBkZXRhaWw6XG4gICAgICAgICAgJ1RoZSBnbyB0b29sIGlzIHJlcXVpcmVkIHRvIHBlcmZvcm0gYSBnZXQuIFBsZWFzZSBlbnN1cmUgeW91IGhhdmUgYSBnbyBydW50aW1lIGluc3RhbGxlZDogaHR0cDovL2dvbGFuZy5vcmcuJyxcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWVcbiAgICAgIH0pXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVzdWx0OiBudWxsLCByZXN1bHRzOiBudWxsIH1cbiAgICB9XG5cbiAgICBjb25zdCBleGVjdXRvck9wdGlvbnMgPSB0aGlzLmdvY29uZmlnLmV4ZWN1dG9yLmdldE9wdGlvbnMoJ3Byb2plY3QnKVxuICAgIGNvbnN0IHRpbWVvdXQgPSBhdG9tLmNvbmZpZy5nZXQoJ2dvLXBsdXMuZ2V0LnRpbWVvdXQnKVxuICAgIGlmICh0eXBlb2YgdGltZW91dCA9PT0gJ251bWJlcicpIHtcbiAgICAgIGV4ZWN1dG9yT3B0aW9ucy50aW1lb3V0ID0gdGltZW91dFxuICAgIH1cblxuICAgIC8vIGRpc2FibGUgR28gMS4xMSBtb2R1bGVzLCBzbyB0aGF0IHVwZGF0aW5nIHRvb2xzIGRvZXMgbm90IGluYWR2ZXJ0ZW50bHlcbiAgICAvLyBhZGQgbmV3IGRlcGVuZGVuY2llcyB0byB0aGUgdXNlcidzIHByb2plY3RcbiAgICBleGVjdXRvck9wdGlvbnMuZW52ID0ge1xuICAgICAgLi4uZXhlY3V0b3JPcHRpb25zLmVudixcbiAgICAgIEdPMTExTU9EVUxFOiAnb2ZmJ1xuICAgIH1cblxuICAgIGxldCBnZXRPdXRwdXQgPSAnJ1xuICAgIGNvbnN0IHByb21pc2VzOiBBcnJheTwoKSA9PiBQcm9taXNlPEdldFJlc3VsdD4+ID0gcGFja2FnZXMubWFwKFxuICAgICAgcGtnID0+IGFzeW5jICgpOiBQcm9taXNlPEdldFJlc3VsdD4gPT4ge1xuICAgICAgICBjb25zdCBhcmdzID0gWydnZXQnLCAnLXUnLCBwa2ddXG4gICAgICAgIGdldE91dHB1dCArPSAnJCBnbyAnICsgYXJncy5qb2luKCcgJykgKyBvcy5FT0xcbiAgICAgICAgdGhpcy5vdXRwdXRGdW5jKCkudXBkYXRlKHsgb3V0cHV0OiBnZXRPdXRwdXQgfSlcbiAgICAgICAgY29uc3QgciA9IGF3YWl0IHRoaXMuZ29jb25maWcuZXhlY3V0b3IuZXhlYyhjbWQsIGFyZ3MsIGV4ZWN1dG9yT3B0aW9ucylcbiAgICAgICAgY29uc3QgcmVzdWx0OiBHZXRSZXN1bHQgPSB7XG4gICAgICAgICAgZXhlY1Jlc3VsdDogcixcbiAgICAgICAgICBjbWQsXG4gICAgICAgICAgcGFjazogcGtnLFxuICAgICAgICAgIGFyZ3M6IGFyZ3NcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzdGRvdXQgPVxuICAgICAgICAgIHIuc3Rkb3V0IGluc3RhbmNlb2YgQnVmZmVyID8gci5zdGRvdXQudG9TdHJpbmcoKSA6IHIuc3Rkb3V0XG4gICAgICAgIGNvbnN0IHN0ZGVyciA9XG4gICAgICAgICAgci5zdGRlcnIgaW5zdGFuY2VvZiBCdWZmZXIgPyByLnN0ZGVyci50b1N0cmluZygpIDogci5zdGRlcnJcblxuICAgICAgICBpZiAoc3RkZXJyICYmIHN0ZGVyci5sZW5ndGgpIHtcbiAgICAgICAgICBnZXRPdXRwdXQgKz0gc3RkZXJyICsgb3MuRU9MXG4gICAgICAgIH1cbiAgICAgICAgaWYgKHN0ZG91dCAmJiBzdGRvdXQubGVuZ3RoKSB7XG4gICAgICAgICAgZ2V0T3V0cHV0ICs9IHN0ZG91dCArIG9zLkVPTFxuICAgICAgICB9XG4gICAgICAgIHRoaXMub3V0cHV0RnVuYygpLnVwZGF0ZSh7XG4gICAgICAgICAgb3V0cHV0OiBnZXRPdXRwdXRcbiAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4gcmVzdWx0XG4gICAgICB9XG4gICAgKVxuXG4gICAgY29uc3QgcmVzdWx0czogQXJyYXk8R2V0UmVzdWx0PiA9IGF3YWl0IHByb21pc2VXYXRlcmZhbGwocHJvbWlzZXMpXG4gICAgaWYgKCFyZXN1bHRzIHx8IHJlc3VsdHMubGVuZ3RoIDwgMSkge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlc3VsdDogbnVsbCwgcmVzdWx0czogbnVsbCB9XG4gICAgfVxuICAgIGxldCBzdWNjZXNzID0gdHJ1ZVxuICAgIGZvciAoY29uc3QgciBvZiByZXN1bHRzKSB7XG4gICAgICBjb25zdCBlciA9IHIuZXhlY1Jlc3VsdFxuICAgICAgY29uc3Qgc3RkZXJyID1cbiAgICAgICAgZXIuc3RkZXJyIGluc3RhbmNlb2YgQnVmZmVyID8gZXIuc3RkZXJyLnRvU3RyaW5nKCkgOiBlci5zdGRlcnJcbiAgICAgIGlmIChlci5lcnJvciB8fCBlci5leGl0Y29kZSAhPT0gMCB8fCAoc3RkZXJyICYmIHN0ZGVyci50cmltKCkgIT09ICcnKSkge1xuICAgICAgICBzdWNjZXNzID0gZmFsc2VcbiAgICAgICAgYnJlYWtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHsgc3VjY2Vzczogc3VjY2VzcywgcmVzdWx0OiByZXN1bHRzWzBdLCByZXN1bHRzOiByZXN1bHRzIH1cbiAgfVxuXG4gIC8vIENyZWF0ZXMgYSBub3RpZmljYXRpb24gdGhhdCBjYW4gYmUgdXNlZCB0byBydW4gYGdvIGdldCAtdSB7b3B0aW9ucy5wYWNrYWdlUGF0aH1gLlxuICAvLyAqIGBvcHRpb25zYCAocmVxdWlyZWQpIHtPYmplY3R9XG4gIC8vICAgKiBgbmFtZWAgKHJlcXVpcmVkKSB7U3RyaW5nfSBlLmcuIGdvLXBsdXNcbiAgLy8gICAqIGBwYWNrYWdlTmFtZWAgKHJlcXVpcmVkKSB7U3RyaW5nfSBlLmcuIGdvaW1wb3J0c1xuICAvLyAgICogYHBhY2thZ2VQYXRoYCAocmVxdWlyZWQpIHtTdHJpbmd9IGUuZy4gZ29sYW5nLm9yZy94L3Rvb2xzL2NtZC9nb2ltcG9ydHNcbiAgLy8gICAqIGB0eXBlYCAocmVxdWlyZWQpIHtTdHJpbmd9IG9uZSBvZiAnbWlzc2luZycgb3IgJ291dGRhdGVkJyAodXNlZCB0byBjdXN0b21pemUgdGhlIHByb21wdClcbiAgYXN5bmMgZ2V0KG9wdGlvbnM6IEludGVyYWN0aXZlR2V0T3B0aW9ucyk6IFByb21pc2U8P011bHRpR2V0UmVzdWx0PiB7XG4gICAgaWYgKFxuICAgICAgIW9wdGlvbnMgfHxcbiAgICAgICFvcHRpb25zLm5hbWUgfHxcbiAgICAgICFvcHRpb25zLnBhY2thZ2VOYW1lIHx8XG4gICAgICAhb3B0aW9ucy5wYWNrYWdlUGF0aCB8fFxuICAgICAgIW9wdGlvbnMudHlwZVxuICAgICkge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG4gICAgaWYgKCFbJ21pc3NpbmcnLCAnb3V0ZGF0ZWQnXS5pbmNsdWRlcyhvcHRpb25zLnR5cGUpKSB7XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cblxuICAgIGNvbnN0IGRldGFpbCA9XG4gICAgICBvcHRpb25zLnR5cGUgPT09ICdvdXRkYXRlZCdcbiAgICAgICAgPyBgQW4gdXBkYXRlIGlzIGF2YWlsYWJsZSBmb3IgdGhlICR7XG4gICAgICAgICAgICBvcHRpb25zLnBhY2thZ2VOYW1lXG4gICAgICAgICAgfSB0b29sLiAgVGhpcyBpcyB1c2VkIGJ5IHRoZSAke29wdGlvbnMubmFtZX0gcGFja2FnZS5gXG4gICAgICAgIDogYFRoZSAke29wdGlvbnMubmFtZX0gcGFja2FnZSB1c2VzIHRoZSAke1xuICAgICAgICAgICAgb3B0aW9ucy5wYWNrYWdlTmFtZVxuICAgICAgICAgIH0gdG9vbCwgYnV0IGl0IGNhbm5vdCBiZSBmb3VuZC5gXG5cbiAgICBjb25zdCBwOiBQcm9taXNlPD9NdWx0aUdldFJlc3VsdD4gPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIGxldCB3YXNDbGlja2VkID0gZmFsc2VcbiAgICAgIGNvbnN0IG5vdGlmaWNhdGlvbiA9IGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKCdHbyBHZXQnLCB7XG4gICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgICBpY29uOiAnY2xvdWQtZG93bmxvYWQnLFxuICAgICAgICBkZXRhaWw6IGRldGFpbCxcbiAgICAgICAgZGVzY3JpcHRpb246XG4gICAgICAgICAgJ1dvdWxkIHlvdSBsaWtlIHRvIHJ1biBgZ28gZ2V0IC11YCBbYCcgK1xuICAgICAgICAgIG9wdGlvbnMucGFja2FnZVBhdGggK1xuICAgICAgICAgICdgXShodHRwOi8vJyArXG4gICAgICAgICAgb3B0aW9ucy5wYWNrYWdlUGF0aCArXG4gICAgICAgICAgJyk/JyxcbiAgICAgICAgYnV0dG9uczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHRleHQ6ICdSdW4gR28gR2V0JyxcbiAgICAgICAgICAgIG9uRGlkQ2xpY2s6IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgd2FzQ2xpY2tlZCA9IHRydWVcbiAgICAgICAgICAgICAgbm90aWZpY2F0aW9uLmRpc21pc3MoKVxuICAgICAgICAgICAgICBjb25zdCBvdXRjb21lOiBNdWx0aUdldFJlc3VsdCA9IGF3YWl0IHRoaXMucGVyZm9ybUdldChcbiAgICAgICAgICAgICAgICBvcHRpb25zLnBhY2thZ2VQYXRoXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgaWYgKG91dGNvbWUgJiYgb3V0Y29tZS5yZXN1bHQgJiYgb3V0Y29tZS5yZXN1bHQuZXhlY1Jlc3VsdClcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3BsYXlSZXN1bHQoXG4gICAgICAgICAgICAgICAgICBvcHRpb25zLnBhY2thZ2VQYXRoLFxuICAgICAgICAgICAgICAgICAgb3V0Y29tZS5yZXN1bHQuZXhlY1Jlc3VsdFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgcmVzb2x2ZShvdXRjb21lKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgXVxuICAgICAgfSlcbiAgICAgIG5vdGlmaWNhdGlvbi5vbkRpZERpc21pc3MoKCkgPT4ge1xuICAgICAgICBpZiAoIXdhc0NsaWNrZWQpIHtcbiAgICAgICAgICByZXNvbHZlKG51bGwpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgICByZXR1cm4gYXdhaXQgcFxuICB9XG5cbiAgZGlzcG9zZSgpIHtcbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25zKSB7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZGlzcG9zZSgpXG4gICAgfVxuICAgIHRoaXMucGFja2FnZXMuY2xlYXIoKVxuICAgIHRoaXMub25EaWRVcGRhdGVUb29scy5jbGVhcigpXG4gIH1cbn1cbmV4cG9ydCB7IEdldE1hbmFnZXIgfVxuIl19