Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Godoc = undefined;

var _atom = require('atom');

var _godocPanel = require('./godoc-panel');

var _utils = require('../utils');

var _guruUtils = require('../guru-utils');

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Godoc {

  constructor(goconfig) {
    this.priority = 2;
    this.grammarScopes = ['source.go', 'go'];
    this.providerName = 'go-plus';

    this.goconfig = goconfig;
    this.subscriptions = new _atom.CompositeDisposable();
    this.panelModel = new _godocPanel.GodocPanel();
    this.subscriptions.add(this.panelModel);
    this.subscriptions.add(atom.commands.add('atom-text-editor', 'golang:showdoc', () => this.commandInvoked()));
    this.methodRegexp = /(?:^func \(\w+ \**)(\w+)/;
  }

  async commandInvoked() {
    const editor = atom.workspace.getActiveTextEditor();
    if (!editor) {
      return { success: false, result: null };
    }
    this.panelModel.updateMessage('Generating documentation...');
    const doc = await this.doc(editor, editor.getCursorBufferPosition());
    if (!doc) {
      return { success: false, result: null };
    }

    if (doc.decl.startsWith('package')) {
      // older versions of gogetdoc didn't populate the import property
      // for packages - prompt user to update
      if (!doc.import || !doc.import.length) {
        this.promptForToolsUpdate();
      } else {
        doc.gddo = 'https://godoc.org/' + doc.import;
      }
    } else {
      const typ = this.declIsMethod(doc.decl);
      if (typ) {
        doc.gddo = 'https://godoc.org/' + doc.import + '#' + typ + '.' + doc.name;
      } else {
        doc.gddo = 'https://godoc.org/' + doc.import + '#' + doc.name;
      }
    }
    this.panelModel.updateContent(doc);
    return { success: true, doc: doc };
  }

  dispose() {
    this.subscriptions.dispose();
  }

  async doc(editor, bufferPosition) {
    const cmd = await this.goconfig.locator.findTool('gogetdoc');
    if (!cmd) return null;

    const file = editor.getBuffer().getPath();
    if (!file) return null;

    const offset = (0, _utils.utf8OffsetForBufferPosition)(bufferPosition, editor);
    const archive = (0, _guruUtils.buildGuruArchive)();
    const args = ['-pos', `${file}:#${offset}`, '-linelength', '999', '-json'];

    const options = this.goconfig.executor.getOptions('project', editor);
    if (archive && archive.length) {
      options.input = archive;
      args.push('-modified');
    }
    const r = await this.goconfig.executor.exec(cmd, args, options);
    if (r.exitcode !== 0) return null;

    const stdout = r.stdout instanceof Buffer ? r.stdout.toString() : r.stdout;
    const doc = JSON.parse(stdout.trim());
    return doc;
  }

  async datatip(editor, bufferPosition) {
    const doc = await this.doc(editor, bufferPosition);
    if (!doc) return null;

    const markedStrings = [{
      type: 'markdown',
      value: `### ${doc.name}

import "${doc.import}"

\`\`\`go
${doc.decl}
\`\`\`

${doc.doc}`
    }];
    return {
      range: new _atom.Range(bufferPosition, bufferPosition),
      markedStrings,
      pinnable: true
    };
  }

  declIsMethod(decl) {
    // func (receiver Type) Name(Args...) -> return Type
    // func Name(Args...) -> return undefined
    const matches = this.methodRegexp.exec(decl);
    if (matches && matches.length) {
      return matches[matches.length - 1];
    }
    return undefined;
  }

  promptForToolsUpdate() {
    if (this.electedNotToUpdate) {
      return;
    }
    this.electedNotToUpdate = true;

    const notification = atom.notifications.addWarning('go-plus', {
      dismissable: true,
      detail: '`gogetdoc` may be out of date',
      description: 'Your `gogetdoc` tool may be out of date.' + _os2.default.EOL + _os2.default.EOL + 'Would you like to run `go get -u github.com/zmb3/gogetdoc` to update?',
      buttons: [{
        text: 'Yes',
        onDidClick: () => {
          notification.dismiss();
          atom.commands.dispatch(atom.views.getView(atom.workspace), 'golang:update-tools', ['github.com/zmb3/gogetdoc']);
        }
      }, {
        text: 'Not Now',
        onDidClick: () => {
          notification.dismiss();
        }
      }]
    });
  }

  getPanel() {
    return this.panelModel;
  }
}

exports.Godoc = Godoc;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdvZG9jLmpzIl0sIm5hbWVzIjpbIkdvZG9jIiwiY29uc3RydWN0b3IiLCJnb2NvbmZpZyIsInByaW9yaXR5IiwiZ3JhbW1hclNjb3BlcyIsInByb3ZpZGVyTmFtZSIsInN1YnNjcmlwdGlvbnMiLCJDb21wb3NpdGVEaXNwb3NhYmxlIiwicGFuZWxNb2RlbCIsIkdvZG9jUGFuZWwiLCJhZGQiLCJhdG9tIiwiY29tbWFuZHMiLCJjb21tYW5kSW52b2tlZCIsIm1ldGhvZFJlZ2V4cCIsImVkaXRvciIsIndvcmtzcGFjZSIsImdldEFjdGl2ZVRleHRFZGl0b3IiLCJzdWNjZXNzIiwicmVzdWx0IiwidXBkYXRlTWVzc2FnZSIsImRvYyIsImdldEN1cnNvckJ1ZmZlclBvc2l0aW9uIiwiZGVjbCIsInN0YXJ0c1dpdGgiLCJpbXBvcnQiLCJsZW5ndGgiLCJwcm9tcHRGb3JUb29sc1VwZGF0ZSIsImdkZG8iLCJ0eXAiLCJkZWNsSXNNZXRob2QiLCJuYW1lIiwidXBkYXRlQ29udGVudCIsImRpc3Bvc2UiLCJidWZmZXJQb3NpdGlvbiIsImNtZCIsImxvY2F0b3IiLCJmaW5kVG9vbCIsImZpbGUiLCJnZXRCdWZmZXIiLCJnZXRQYXRoIiwib2Zmc2V0IiwiYXJjaGl2ZSIsImFyZ3MiLCJvcHRpb25zIiwiZXhlY3V0b3IiLCJnZXRPcHRpb25zIiwiaW5wdXQiLCJwdXNoIiwiciIsImV4ZWMiLCJleGl0Y29kZSIsInN0ZG91dCIsIkJ1ZmZlciIsInRvU3RyaW5nIiwiSlNPTiIsInBhcnNlIiwidHJpbSIsImRhdGF0aXAiLCJtYXJrZWRTdHJpbmdzIiwidHlwZSIsInZhbHVlIiwicmFuZ2UiLCJSYW5nZSIsInBpbm5hYmxlIiwibWF0Y2hlcyIsInVuZGVmaW5lZCIsImVsZWN0ZWROb3RUb1VwZGF0ZSIsIm5vdGlmaWNhdGlvbiIsIm5vdGlmaWNhdGlvbnMiLCJhZGRXYXJuaW5nIiwiZGlzbWlzc2FibGUiLCJkZXRhaWwiLCJkZXNjcmlwdGlvbiIsIm9zIiwiRU9MIiwiYnV0dG9ucyIsInRleHQiLCJvbkRpZENsaWNrIiwiZGlzbWlzcyIsImRpc3BhdGNoIiwidmlld3MiLCJnZXRWaWV3IiwiZ2V0UGFuZWwiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQTBCQSxNQUFNQSxLQUFOLENBQVk7O0FBVVZDLGNBQVlDLFFBQVosRUFBZ0M7QUFBQSxTQVBoQ0MsUUFPZ0MsR0FQYixDQU9hO0FBQUEsU0FOaENDLGFBTWdDLEdBTmhCLENBQUMsV0FBRCxFQUFjLElBQWQsQ0FNZ0I7QUFBQSxTQUxoQ0MsWUFLZ0MsR0FMakIsU0FLaUI7O0FBQzlCLFNBQUtILFFBQUwsR0FBZ0JBLFFBQWhCO0FBQ0EsU0FBS0ksYUFBTCxHQUFxQixJQUFJQyx5QkFBSixFQUFyQjtBQUNBLFNBQUtDLFVBQUwsR0FBa0IsSUFBSUMsc0JBQUosRUFBbEI7QUFDQSxTQUFLSCxhQUFMLENBQW1CSSxHQUFuQixDQUF1QixLQUFLRixVQUE1QjtBQUNBLFNBQUtGLGFBQUwsQ0FBbUJJLEdBQW5CLENBQ0VDLEtBQUtDLFFBQUwsQ0FBY0YsR0FBZCxDQUFrQixrQkFBbEIsRUFBc0MsZ0JBQXRDLEVBQXdELE1BQ3RELEtBQUtHLGNBQUwsRUFERixDQURGO0FBS0EsU0FBS0MsWUFBTCxHQUFvQiwwQkFBcEI7QUFDRDs7QUFFRCxRQUFNRCxjQUFOLEdBQXVCO0FBQ3JCLFVBQU1FLFNBQVNKLEtBQUtLLFNBQUwsQ0FBZUMsbUJBQWYsRUFBZjtBQUNBLFFBQUksQ0FBQ0YsTUFBTCxFQUFhO0FBQ1gsYUFBTyxFQUFFRyxTQUFTLEtBQVgsRUFBa0JDLFFBQVEsSUFBMUIsRUFBUDtBQUNEO0FBQ0QsU0FBS1gsVUFBTCxDQUFnQlksYUFBaEIsQ0FBOEIsNkJBQTlCO0FBQ0EsVUFBTUMsTUFBTSxNQUFNLEtBQUtBLEdBQUwsQ0FBU04sTUFBVCxFQUFpQkEsT0FBT08sdUJBQVAsRUFBakIsQ0FBbEI7QUFDQSxRQUFJLENBQUNELEdBQUwsRUFBVTtBQUNSLGFBQU8sRUFBRUgsU0FB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QVksTUFBTTtBQUNoQlYsdUJBQWFXLE9BQWI7QUFDRDtBQUpILE9BWk87QUFSbUQsS0FBekMsQ0FBckI7QUE0QkQ7O0FBRURJLGFBQVc7QUFDVCxXQUFPLEtBQUszRSxVQUFaO0FBQ0Q7QUFsS1M7O1FBcUtIUixLLEdBQUFBLEsiLCJmaWxlIjoiZ29kb2MuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvbXl1Z2EvLmF0b20vcGFja2FnZXMvZ28tcGx1cy9saWIvZG9jIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgUmFuZ2UgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgR29kb2NQYW5lbCB9IGZyb20gJy4vZ29kb2MtcGFuZWwnXG5pbXBvcnQgeyB1dGY4T2Zmc2V0Rm9yQnVmZmVyUG9zaXRpb24gfSBmcm9tICcuLi91dGlscydcbmltcG9ydCB7IGJ1aWxkR3VydUFyY2hpdmUgfSBmcm9tICcuLi9ndXJ1LXV0aWxzJ1xuaW1wb3J0IG9zIGZyb20gJ29zJ1xuXG5pbXBvcnQgdHlwZSB7IEdvQ29uZmlnIH0gZnJvbSAnLi8uLi9jb25maWcvc2VydmljZSdcblxuZXhwb3J0IHR5cGUgR29nZXRkb2NSZXN1bHQgPSB7XG4gIG5hbWU6IHN0cmluZyxcbiAgaW1wb3J0OiBzdHJpbmcsXG4gIHBrZzogc3RyaW5nLFxuICBkZWNsOiBzdHJpbmcsXG4gIGRvYzogc3RyaW5nLFxuICBwb3M6IHN0cmluZyxcblxuICBnZGRvPzogc3RyaW5nIC8vIGdvZG9jLm9yZyBsaW5rICh3ZSBhZGQgdGhpcyBvdXJzZWx2ZXMpXG59XG5cbnR5cGUgTWFya2VkU3RyaW5nID0ge1xuICB0eXBlOiAnbWFya2Rvd24nLFxuICB2YWx1ZTogc3RyaW5nXG59XG5cbnR5cGUgRGF0YXRpcCA9IHtcbiAgbWFya2VkU3RyaW5nczogQXJyYXk8TWFya2VkU3RyaW5nPixcbiAgcmFuZ2U6IGF0b20kUmFuZ2UsXG4gIHBpbm5hYmxlPzogYm9vbGVhblxufVxuXG5jbGFzcyBHb2RvYyB7XG4gIGdvY29uZmlnOiBHb0NvbmZpZ1xuICBzdWJzY3JpcHRpb25zOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIHByaW9yaXR5OiBudW1iZXIgPSAyXG4gIGdyYW1tYXJTY29wZXMgPSBbJ3NvdXJjZS5nbycsICdnbyddXG4gIHByb3ZpZGVyTmFtZSA9ICdnby1wbHVzJ1xuICBwYW5lbE1vZGVsOiBHb2RvY1BhbmVsXG4gIG1ldGhvZFJlZ2V4cDogUmVnRXhwXG4gIGVsZWN0ZWROb3RUb1VwZGF0ZTogYm9vbGVhblxuXG4gIGNvbnN0cnVjdG9yKGdvY29uZmlnOiBHb0NvbmZpZykge1xuICAgIHRoaXMuZ29jb25maWcgPSBnb2NvbmZpZ1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLnBhbmVsTW9kZWwgPSBuZXcgR29kb2NQYW5lbCgpXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZCh0aGlzLnBhbmVsTW9kZWwpXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXRleHQtZWRpdG9yJywgJ2dvbGFuZzpzaG93ZG9jJywgKCkgPT5cbiAgICAgICAgdGhpcy5jb21tYW5kSW52b2tlZCgpXG4gICAgICApXG4gICAgKVxuICAgIHRoaXMubWV0aG9kUmVnZXhwID0gLyg/Ol5mdW5jIFxcKFxcdysgXFwqKikoXFx3KykvXG4gIH1cblxuICBhc3luYyBjb21tYW5kSW52b2tlZCgpIHtcbiAgICBjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKClcbiAgICBpZiAoIWVkaXRvcikge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlc3VsdDogbnVsbCB9XG4gICAgfVxuICAgIHRoaXMucGFuZWxNb2RlbC51cGRhdGVNZXNzYWdlKCdHZW5lcmF0aW5nIGRvY3VtZW50YXRpb24uLi4nKVxuICAgIGNvbnN0IGRvYyA9IGF3YWl0IHRoaXMuZG9jKGVkaXRvciwgZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCkpXG4gICAgaWYgKCFkb2MpIHtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZXN1bHQ6IG51bGwgfVxuICAgIH1cblxuICAgIGlmIChkb2MuZGVjbC5zdGFydHNXaXRoKCdwYWNrYWdlJykpIHtcbiAgICAgIC8vIG9sZGVyIHZlcnNpb25zIG9mIGdvZ2V0ZG9jIGRpZG4ndCBwb3B1bGF0ZSB0aGUgaW1wb3J0IHByb3BlcnR5XG4gICAgICAvLyBmb3IgcGFja2FnZXMgLSBwcm9tcHQgdXNlciB0byB1cGRhdGVcbiAgICAgIGlmICghZG9jLmltcG9ydCB8fCAhZG9jLmltcG9ydC5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5wcm9tcHRGb3JUb29sc1VwZGF0ZSgpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2MuZ2RkbyA9ICdodHRwczovL2dvZG9jLm9yZy8nICsgZG9jLmltcG9ydFxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB0eXAgPSB0aGlzLmRlY2xJc01ldGhvZChkb2MuZGVjbClcbiAgICAgIGlmICh0eXApIHtcbiAgICAgICAgZG9jLmdkZG8gPVxuICAgICAgICAgICdodHRwczovL2dvZG9jLm9yZy8nICsgZG9jLmltcG9ydCArICcjJyArIHR5cCArICcuJyArIGRvYy5uYW1lXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkb2MuZ2RkbyA9ICdodHRwczovL2dvZG9jLm9yZy8nICsgZG9jLmltcG9ydCArICcjJyArIGRvYy5uYW1lXG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMucGFuZWxNb2RlbC51cGRhdGVDb250ZW50KGRvYylcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBkb2M6IGRvYyB9XG4gIH1cblxuICBkaXNwb3NlKCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5kaXNwb3NlKClcbiAgfVxuXG4gIGFzeW5jIGRvYyhcbiAgICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcbiAgICBidWZmZXJQb3NpdGlvbjogYXRvbSRQb2ludFxuICApOiBQcm9taXNlPD9Hb2dldGRvY1Jlc3VsdD4ge1xuICAgIGNvbnN0IGNtZCA9IGF3YWl0IHRoaXMuZ29jb25maWcubG9jYXRvci5maW5kVG9vbCgnZ29nZXRkb2MnKVxuICAgIGlmICghY21kKSByZXR1cm4gbnVsbFxuXG4gICAgY29uc3QgZmlsZSA9IGVkaXRvci5nZXRCdWZmZXIoKS5nZXRQYXRoKClcbiAgICBpZiAoIWZpbGUpIHJldHVybiBudWxsXG5cbiAgICBjb25zdCBvZmZzZXQgPSB1dGY4T2Zmc2V0Rm9yQnVmZmVyUG9zaXRpb24oYnVmZmVyUG9zaXRpb24sIGVkaXRvcilcbiAgICBjb25zdCBhcmNoaXZlID0gYnVpbGRHdXJ1QXJjaGl2ZSgpXG4gICAgY29uc3QgYXJncyA9IFsnLXBvcycsIGAke2ZpbGV9OiMke29mZnNldH1gLCAnLWxpbmVsZW5ndGgnLCAnOTk5JywgJy1qc29uJ11cblxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdvY29uZmlnLmV4ZWN1dG9yLmdldE9wdGlvbnMoJ3Byb2plY3QnLCBlZGl0b3IpXG4gICAgaWYgKGFyY2hpdmUgJiYgYXJjaGl2ZS5sZW5ndGgpIHtcbiAgICAgIG9wdGlvbnMuaW5wdXQgPSBhcmNoaXZlXG4gICAgICBhcmdzLnB1c2goJy1tb2RpZmllZCcpXG4gICAgfVxuICAgIGNvbnN0IHIgPSBhd2FpdCB0aGlzLmdvY29uZmlnLmV4ZWN1dG9yLmV4ZWMoY21kLCBhcmdzLCBvcHRpb25zKVxuICAgIGlmIChyLmV4aXRjb2RlICE9PSAwKSByZXR1cm4gbnVsbFxuXG4gICAgY29uc3Qgc3Rkb3V0ID0gci5zdGRvdXQgaW5zdGFuY2VvZiBCdWZmZXIgPyByLnN0ZG91dC50b1N0cmluZygpIDogci5zdGRvdXRcbiAgICBjb25zdCBkb2M6IEdvZ2V0ZG9jUmVzdWx0ID0gSlNPTi5wYXJzZShzdGRvdXQudHJpbSgpKVxuICAgIHJldHVybiBkb2NcbiAgfVxuXG4gIGFzeW5jIGRhdGF0aXAoXG4gICAgZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXG4gICAgYnVmZmVyUG9zaXRpb246IGF0b20kUG9pbnRcbiAgKTogUHJvbWlzZTw/RGF0YXRpcD4ge1xuICAgIGNvbnN0IGRvYyA9IGF3YWl0IHRoaXMuZG9jKGVkaXRvciwgYnVmZmVyUG9zaXRpb24pXG4gICAgaWYgKCFkb2MpIHJldHVybiBudWxsXG5cbiAgICBjb25zdCBtYXJrZWRTdHJpbmdzID0gW1xuICAgICAge1xuICAgICAgICB0eXBlOiAnbWFya2Rvd24nLFxuICAgICAgICB2YWx1ZTogYCMjIyAke2RvYy5uYW1lfVxuXG5pbXBvcnQgXCIke2RvYy5pbXBvcnR9XCJcblxuXFxgXFxgXFxgZ29cbiR7ZG9jLmRlY2x9XG5cXGBcXGBcXGBcblxuJHtkb2MuZG9jfWBcbiAgICAgIH1cbiAgICBdXG4gICAgcmV0dXJuIHtcbiAgICAgIHJhbmdlOiBuZXcgUmFuZ2UoYnVmZmVyUG9zaXRpb24sIGJ1ZmZlclBvc2l0aW9uKSxcbiAgICAgIG1hcmtlZFN0cmluZ3MsXG4gICAgICBwaW5uYWJsZTogdHJ1ZVxuICAgIH1cbiAgfVxuXG4gIGRlY2xJc01ldGhvZChkZWNsOiBzdHJpbmcpOiA/c3RyaW5nIHtcbiAgICAvLyBmdW5jIChyZWNlaXZlciBUeXBlKSBOYW1lKEFyZ3MuLi4pIC0+IHJldHVybiBUeXBlXG4gICAgLy8gZnVuYyBOYW1lKEFyZ3MuLi4pIC0+IHJldHVybiB1bmRlZmluZWRcbiAgICBjb25zdCBtYXRjaGVzID0gdGhpcy5tZXRob2RSZWdleHAuZXhlYyhkZWNsKVxuICAgIGlmIChtYXRjaGVzICYmIG1hdGNoZXMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gbWF0Y2hlc1ttYXRjaGVzLmxlbmd0aCAtIDFdXG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuXG4gIHByb21wdEZvclRvb2xzVXBkYXRlKCkge1xuICAgIGlmICh0aGlzLmVsZWN0ZWROb3RUb1VwZGF0ZSkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIHRoaXMuZWxlY3RlZE5vdFRvVXBkYXRlID0gdHJ1ZVxuXG4gICAgY29uc3Qgbm90aWZpY2F0aW9uID0gYXRvbS5ub3RpZmljYXRpb25zLmFkZFdhcm5pbmcoJ2dvLXBsdXMnLCB7XG4gICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgIGRldGFpbDogJ2Bnb2dldGRvY2AgbWF5IGJlIG91dCBvZiBkYXRlJyxcbiAgICAgIGRlc2NyaXB0aW9uOlxuICAgICAgICAnWW91ciBgZ29nZXRkb2NgIHRvb2wgbWF5IGJlIG91dCBvZiBkYXRlLicgK1xuICAgICAgICBvcy5FT0wgK1xuICAgICAgICBvcy5FT0wgK1xuICAgICAgICAnV291bGQgeW91IGxpa2UgdG8gcnVuIGBnbyBnZXQgLXUgZ2l0aHViLmNvbS96bWIzL2dvZ2V0ZG9jYCB0byB1cGRhdGU/JyxcbiAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHRleHQ6ICdZZXMnLFxuICAgICAgICAgIG9uRGlkQ2xpY2s6ICgpID0+IHtcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbi5kaXNtaXNzKClcbiAgICAgICAgICAgIGF0b20uY29tbWFuZHMuZGlzcGF0Y2goXG4gICAgICAgICAgICAgIGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSksXG4gICAgICAgICAgICAgICdnb2xhbmc6dXBkYXRlLXRvb2xzJyxcbiAgICAgICAgICAgICAgWydnaXRodWIuY29tL3ptYjMvZ29nZXRkb2MnXVxuICAgICAgICAgICAgKVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHRleHQ6ICdOb3QgTm93JyxcbiAgICAgICAgICBvbkRpZENsaWNrOiAoKSA9PiB7XG4gICAgICAgICAgICBub3RpZmljYXRpb24uZGlzbWlzcygpXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICBdXG4gICAgfSlcbiAgfVxuXG4gIGdldFBhbmVsKCkge1xuICAgIHJldHVybiB0aGlzLnBhbmVsTW9kZWxcbiAgfVxufVxuXG5leHBvcnQgeyBHb2RvYyB9XG4iXX0=