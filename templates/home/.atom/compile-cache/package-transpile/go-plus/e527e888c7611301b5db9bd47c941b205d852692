Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Implements = undefined;

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _atom = require('atom');

var _utils = require('./../utils');

var _guruUtils = require('./../guru-utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Implements {

  constructor(goconfig) {
    this.goconfig = goconfig;

    this.key = 'implements';
    this.tab = {
      key: 'implements',
      name: 'Implements',
      packageName: 'go-plus',
      icon: 'tasklist',
      order: 450,
      suppressPadding: true
    };

    this.subscriptions = new _atom.CompositeDisposable();
    this.subscriptions.add(atom.commands.add('atom-workspace', {
      'golang:implements': () => {
        this.handleCommand();
      }
    }));
  }

  handleCommand() {
    if (!this.goconfig || !this.goconfig.locator || !this.goconfig.executor) {
      return;
    }
    const editor = (0, _utils.getEditor)();
    if (!editor) {
      return;
    }
    const args = (0, _guruUtils.computeArgs)('implements', null, editor);
    if (args && args.length) {
      return this.runGuru(args);
    }
  }

  async runGuru(args) {
    const options = {};
    options.timeout = 20000;
    const archive = (0, _guruUtils.buildGuruArchive)();
    if (archive && archive.length) {
      options.input = archive;
      args.unshift('-modified');
    }
    if (this.requestFocus) {
      await this.requestFocus();
    }
    if (this.view) {
      this.view.update('running guru ' + args.join(' '));
    }
    const cmd = await this.goconfig.locator.findTool('guru');
    if (!cmd) {
      return false;
    }
    const r = await this.goconfig.executor.exec(cmd, args, options);
    if (!r) {
      return false;
    }

    const stderr = r.stderr instanceof Buffer ? r.stderr.toString() : r.stderr;
    if (r.error || r.exitcode !== 0 || stderr && stderr.trim() !== '') {
      if (this.view) {
        if (r.exitcode === 124) {
          this.view.update(`guru failed: operation timed out after ${options.timeout} ms`);
        } else {
          this.view.update('guru failed' + _os2.default.EOL + _os2.default.EOL + stderr.trim());
        }
      }
      return false;
    }
    const stdout = r.stdout instanceof Buffer ? r.stdout.toString() : r.stdout;
    const obj = JSON.parse(stdout);
    if (obj && this.requestFocus) {
      this.requestFocus().then(() => {
        if (this.view) {
          this.view.update(obj);
        }
        return;
      }).catch(e => console.log(e)); // eslint-disable-line no-console
    }
  }

  dispose() {
    if (this.subscriptions) {
      this.subscriptions.dispose();
    }
  }
}

exports.Implements = Implements;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImltcGxlbWVudHMuanMiXSwibmFtZXMiOlsiSW1wbGVtZW50cyIsImNvbnN0cnVjdG9yIiwiZ29jb25maWciLCJrZXkiLCJ0YWIiLCJuYW1lIiwicGFja2FnZU5hbWUiLCJpY29uIiwib3JkZXIiLCJzdXBwcmVzc1BhZGRpbmciLCJzdWJzY3JpcHRpb25zIiwiQ29tcG9zaXRlRGlzcG9zYWJsZSIsImFkZCIsImF0b20iLCJjb21tYW5kcyIsImhhbmRsZUNvbW1hbmQiLCJsb2NhdG9yIiwiZXhlY3V0b3IiLCJlZGl0b3IiLCJhcmdzIiwibGVuZ3RoIiwicnVuR3VydSIsIm9wdGlvbnMiLCJ0aW1lb3V0IiwiYXJjaGl2ZSIsImlucHV0IiwidW5zaGlmdCIsInJlcXVlc3RGb2N1cyIsInZpZXciLCJ1cGRhdGUiLCJqb2luIiwiY21kIiwiZmluZFRvb2wiLCJyIiwiZXhlYyIsInN0ZGVyciIsIkJ1ZmZlciIsInRvU3RyaW5nIiwiZXJyb3IiLCJleGl0Y29kZSIsInRyaW0iLCJvcyIsIkVPTCIsInN0ZG91dCIsIm9iaiIsIkpTT04iLCJwYXJzZSIsInRoZW4iLCJjYXRjaCIsImUiLCJjb25zb2xlIiwibG9nIiwiZGlzcG9zZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBTUEsTUFBTUEsVUFBTixDQUF1Qzs7QUFRckNDLGNBQVlDLFFBQVosRUFBZ0M7QUFDOUIsU0FBS0EsUUFBTCxHQUFnQkEsUUFBaEI7O0FBRUEsU0FBS0MsR0FBTCxHQUFXLFlBQVg7QUFDQSxTQUFLQyxHQUFMLEdBQVc7QUFDVEQsV0FBSyxZQURJO0FBRVRFLFlBQU0sWUFGRztBQUdUQyxtQkFBYSxTQUhKO0FBSVRDLFlBQU0sVUFKRztBQUtUQyxhQUFPLEdBTEU7QUFNVEMsdUJBQWlCO0FBTlIsS0FBWDs7QUFTQSxTQUFLQyxhQUFMLEdBQXFCLElBQUlDLHlCQUFKLEVBQXJCO0FBQ0EsU0FBS0QsYUFBTCxDQUFtQkUsR0FBbkIsQ0FDRUMsS0FBS0Ms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QUNELE9BTkgsRUFPR0ksS0FQSCxDQU9TQyxLQUFLQyxRQUFRQyxHQUFSLENBQVlGLENBQVosQ0FQZCxFQUQ0QixDQVFFO0FBQy9CO0FBQ0Y7O0FBRURHLFlBQVU7QUFDUixRQUFJLEtBQUsxQyxhQUFULEVBQXdCO0FBQ3RCLFdBQUtBLGFBQUwsQ0FBbUIwQyxPQUFuQjtBQUNEO0FBQ0Y7QUFyR29DOztRQXdHOUJwRCxVLEdBQUFBLFUiLCJmaWxlIjoiaW1wbGVtZW50cy5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS9teXVnYS8uYXRvbS9wYWNrYWdlcy9nby1wbHVzL2xpYi9pbXBsZW1lbnRzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IG9zIGZyb20gJ29zJ1xuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBnZXRFZGl0b3IgfSBmcm9tICcuLy4uL3V0aWxzJ1xuaW1wb3J0IHsgYnVpbGRHdXJ1QXJjaGl2ZSwgY29tcHV0ZUFyZ3MgfSBmcm9tICcuLy4uL2d1cnUtdXRpbHMnXG5cbmltcG9ydCB0eXBlIHsgSW1wbGVtZW50c1ZpZXcgfSBmcm9tICcuL2ltcGxlbWVudHMtdmlldydcbmltcG9ydCB0eXBlIHsgR29Db25maWcgfSBmcm9tICcuLy4uL2NvbmZpZy9zZXJ2aWNlJ1xuaW1wb3J0IHR5cGUgeyBQYW5lbE1vZGVsLCBUYWIgfSBmcm9tICcuLy4uL3BhbmVsL3RhYidcblxuY2xhc3MgSW1wbGVtZW50cyBpbXBsZW1lbnRzIFBhbmVsTW9kZWwge1xuICBrZXk6IHN0cmluZ1xuICB0YWI6IFRhYlxuICBnb2NvbmZpZzogR29Db25maWdcbiAgc3Vic2NyaXB0aW9uczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuICByZXF1ZXN0Rm9jdXM6ID8oKSA9PiBQcm9taXNlPHZvaWQ+XG4gIHZpZXc6IEltcGxlbWVudHNWaWV3XG5cbiAgY29uc3RydWN0b3IoZ29jb25maWc6IEdvQ29uZmlnKSB7XG4gICAgdGhpcy5nb2NvbmZpZyA9IGdvY29uZmlnXG5cbiAgICB0aGlzLmtleSA9ICdpbXBsZW1lbnRzJ1xuICAgIHRoaXMudGFiID0ge1xuICAgICAga2V5OiAnaW1wbGVtZW50cycsXG4gICAgICBuYW1lOiAnSW1wbGVtZW50cycsXG4gICAgICBwYWNrYWdlTmFtZTogJ2dvLXBsdXMnLFxuICAgICAgaWNvbjogJ3Rhc2tsaXN0JyxcbiAgICAgIG9yZGVyOiA0NTAsXG4gICAgICBzdXBwcmVzc1BhZGRpbmc6IHRydWVcbiAgICB9XG5cbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsIHtcbiAgICAgICAgJ2dvbGFuZzppbXBsZW1lbnRzJzogKCkgPT4ge1xuICAgICAgICAgIHRoaXMuaGFuZGxlQ29tbWFuZCgpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKVxuICB9XG5cbiAgaGFuZGxlQ29tbWFuZCgpIHtcbiAgICBpZiAoIXRoaXMuZ29jb25maWcgfHwgIXRoaXMuZ29jb25maWcubG9jYXRvciB8fCAhdGhpcy5nb2NvbmZpZy5leGVjdXRvcikge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnN0IGVkaXRvciA9IGdldEVkaXRvcigpXG4gICAgaWYgKCFlZGl0b3IpIHtcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjb25zdCBhcmdzID0gY29tcHV0ZUFyZ3MoJ2ltcGxlbWVudHMnLCBudWxsLCBlZGl0b3IpXG4gICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiB0aGlzLnJ1bkd1cnUoYXJncylcbiAgICB9XG4gIH1cblxuICBhc3luYyBydW5HdXJ1KGFyZ3M6IEFycmF5PHN0cmluZz4pIHtcbiAgICBjb25zdCBvcHRpb25zID0ge31cbiAgICBvcHRpb25zLnRpbWVvdXQgPSAyMDAwMFxuICAgIGNvbnN0IGFyY2hpdmUgPSBidWlsZEd1cnVBcmNoaXZlKClcbiAgICBpZiAoYXJjaGl2ZSAmJiBhcmNoaXZlLmxlbmd0aCkge1xuICAgICAgb3B0aW9ucy5pbnB1dCA9IGFyY2hpdmVcbiAgICAgIGFyZ3MudW5zaGlmdCgnLW1vZGlmaWVkJylcbiAgICB9XG4gICAgaWYgKHRoaXMucmVxdWVzdEZvY3VzKSB7XG4gICAgICBhd2FpdCB0aGlzLnJlcXVlc3RGb2N1cygpXG4gICAgfVxuICAgIGlmICh0aGlzLnZpZXcpIHtcbiAgICAgIHRoaXMudmlldy51cGRhdGUoJ3J1bm5pbmcgZ3VydSAnICsgYXJncy5qb2luKCcgJykpXG4gICAgfVxuICAgIGNvbnN0IGNtZCA9IGF3YWl0IHRoaXMuZ29jb25maWcubG9jYXRvci5maW5kVG9vbCgnZ3VydScpXG4gICAgaWYgKCFjbWQpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICBjb25zdCByID0gYXdhaXQgdGhpcy5nb2NvbmZpZy5leGVjdXRvci5leGVjKGNtZCwgYXJncywgb3B0aW9ucylcbiAgICBpZiAoIXIpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIGNvbnN0IHN0ZGVycjogc3RyaW5nID1cbiAgICAgIHIuc3RkZXJyIGluc3RhbmNlb2YgQnVmZmVyID8gci5zdGRlcnIudG9TdHJpbmcoKSA6IHIuc3RkZXJyXG4gICAgaWYgKHIuZXJyb3IgfHwgci5leGl0Y29kZSAhPT0gMCB8fCAoc3RkZXJyICYmIHN0ZGVyci50cmltKCkgIT09ICcnKSkge1xuICAgICAgaWYgKHRoaXMudmlldykge1xuICAgICAgICBpZiAoci5leGl0Y29kZSA9PT0gMTI0KSB7XG4gICAgICAgICAgdGhpcy52aWV3LnVwZGF0ZShcbiAgICAgICAgICAgIGBndXJ1IGZhaWxlZDogb3BlcmF0aW9uIHRpbWVkIG91dCBhZnRlciAke29wdGlvbnMudGltZW91dH0gbXNgXG4gICAgICAgICAgKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMudmlldy51cGRhdGUoJ2d1cnUgZmFpbGVkJyArIG9zLkVPTCArIG9zLkVPTCArIHN0ZGVyci50cmltKCkpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICBjb25zdCBzdGRvdXQ6IHN0cmluZyA9XG4gICAgICByLnN0ZG91dCBpbnN0YW5jZW9mIEJ1ZmZlciA/IHIuc3Rkb3V0LnRvU3RyaW5nKCkgOiByLnN0ZG91dFxuICAgIGNvbnN0IG9iaiA9IEpTT04ucGFyc2Uoc3Rkb3V0KVxuICAgIGlmIChvYmogJiYgdGhpcy5yZXF1ZXN0Rm9jdXMpIHtcbiAgICAgIHRoaXMucmVxdWVzdEZvY3VzKClcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLnZpZXcpIHtcbiAgICAgICAgICAgIHRoaXMudmlldy51cGRhdGUob2JqKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKGUgPT4gY29uc29sZS5sb2coZSkpIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuICAgIH1cbiAgfVxuXG4gIGRpc3Bvc2UoKSB7XG4gICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9ucykge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmRpc3Bvc2UoKVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBJbXBsZW1lbnRzIH1cbiJdfQ==