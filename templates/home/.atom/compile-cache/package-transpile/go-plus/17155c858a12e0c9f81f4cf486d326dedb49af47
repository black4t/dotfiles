Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Gorename = undefined;

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _atom = require('atom');

var _simpleDialog = require('./../simple-dialog');

var _utils = require('../utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Gorename {

  constructor(goconfig) {
    this.goconfig = goconfig;
    this.subscriptions = new _atom.CompositeDisposable();
    this.subscriptions.add(atom.commands.add('atom-text-editor', 'golang:gorename', () => this.commandInvoked()));
  }

  dispose() {
    this.subscriptions.dispose();
  }

  async commandInvoked() {
    const editor = atom.workspace.getActiveTextEditor();
    if (!editor || !(0, _utils.isValidEditor)(editor)) {
      return;
    }
    try {
      const cmd = await this.goconfig.locator.findTool('gorename');
      if (!cmd) {
        return;
      }
      const { word, offset } = (0, _utils.wordAndOffset)(editor);
      const cursor = editor.getCursorBufferPosition();

      const dialog = new _simpleDialog.SimpleDialog({
        prompt: `Rename ${word} to:`,
        initialValue: word,
        onConfirm: newName => {
          this.saveAllEditors().then(() => {
            const file = editor.getBuffer().getPath();
            if (!file) {
              return;
            }
            const cwd = _path2.default.dirname(file);

            // restore cursor position after gorename completes and the buffer is reloaded
            if (cursor) {
              const disp = editor.getBuffer().onDidReload(() => {
                editor.setCursorBufferPosition(cursor, { autoscroll: false });
                const element = atom.views.getView(editor);
                if (element) {
                  element.focus();
                }
                disp.dispose();
              });
            }
            this.runGorename(file, offset, cwd, newName, cmd);
            return;
          }).catch(e => console.log(e)); // eslint-disable-line no-console
        },
        onCancel: () => {
          editor.setCursorBufferPosition(cursor, { autoscroll: false });
          const element = atom.views.getView(editor);
          if (element) {
            element.focus();
          }
        }
      });

      dialog.attach();
    } catch (e) {
      if (e.handle) {
        e.handle();
      }
      console.log(e); // eslint-disable-line no-console
    }
  }

  saveAllEditors() {
    const promises = [];
    for (const editor of atom.workspace.getTextEditors()) {
      if (editor.isModified() && (0, _utils.isValidEditor)(editor)) {
        promises.push(editor.save());
      }
    }
    return Promise.all(promises);
  }

  async runGorename(file, offset, cwd, newName, cmd) {
    if (!this.goconfig || !this.goconfig.executor) {
      return { success: false, result: null };
    }

    const args = ['-offset', `${file}:#${offset}`, '-to', newName];
    const options = {
      cwd: cwd,
      env: this.goconfig.environment(),
      timeout: 20000
    };
    const notification = atom.notifications.addInfo('Renaming...', {
      dismissable: true
    });
    const r = await this.goconfig.executor.exec(cmd, args, options);
    notification.dismiss();
    if (r.exitcode === 124) {
      atom.notifications.addError('Operation timed out', {
        detail: 'gorename ' + args.join(' '),
        dismissable: true
      });
      return { success: false, result: r };
    } else if (r.error) {
      if (r.error.code === 'ENOENT') {
        atom.notifications.addError('Missing Rename Tool', {
          detail: 'The gorename tool is required to perform a rename. Please run go get -u golang.org/x/tools/cmd/gorename to get it.',
          dismissable: true
        });
      } else {
        atom.notifications.addError('Rename Error', {
          detail: r.error.message,
          dismissable: true
        });
      }
      return { success: false, result: r };
    }

    const stderr = r.stderr instanceof Buffer ? r.stderr.toString() : r.stderr;
    const stdout = r.stdout instanceof Buffer ? r.stdout.toString() : r.stdout;
    const message = stderr.trim() + '\r\n' + stdout.trim();
    if (r.exitcode !== 0 || stderr && stderr.trim() !== '') {
      atom.notifications.addWarning('Rename Error', {
        detail: message.trim(),
        dismissable: true
      });
      return { success: false, result: r };
    }

    atom.notifications.addSuccess(message.trim());
    return { success: true, result: r };
  }
}

exports.Gorename = Gorename;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdvcmVuYW1lLmpzIl0sIm5hbWVzIjpbIkdvcmVuYW1lIiwiY29uc3RydWN0b3IiLCJnb2NvbmZpZyIsInN1YnNjcmlwdGlvbnMiLCJDb21wb3NpdGVEaXNwb3NhYmxlIiwiYWRkIiwiYXRvbSIsImNvbW1hbmRzIiwiY29tbWFuZEludm9rZWQiLCJkaXNwb3NlIiwiZWRpdG9yIiwid29ya3NwYWNlIiwiZ2V0QWN0aXZlVGV4dEVkaXRvciIsImNtZCIsImxvY2F0b3IiLCJmaW5kVG9vbCIsIndvcmQiLCJvZmZzZXQiLCJjdXJzb3IiLCJnZXRDdXJzb3JCdWZmZXJQb3NpdGlvbiIsImRpYWxvZyIsIlNpbXBsZURpYWxvZyIsInByb21wdCIsImluaXRpYWxWYWx1ZSIsIm9uQ29uZmlybSIsIm5ld05hbWUiLCJzYXZlQWxsRWRpdG9ycyIsInRoZW4iLCJmaWxlIiwiZ2V0QnVmZmVyIiwiZ2V0UGF0aCIsImN3ZCIsInBhdGgiLCJkaXJuYW1lIiwiZGlzcCIsIm9uRGlkUmVsb2FkIiwic2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24iLCJhdXRvc2Nyb2xsIiwiZWxlbWVudCIsInZpZXdzIiwiZ2V0VmlldyIsImZvY3VzIiwicnVuR29yZW5hbWUiLCJjYXRjaCIsImUiLCJjb25zb2xlIiwibG9nIiwib25DYW5jZWwiLCJhdHRhY2giLCJoYW5kbGUiLCJwcm9taXNlcyIsImdldFRleHRFZGl0b3JzIiwiaXNNb2RpZmllZCIsInB1c2giLCJzYXZlIiwiUHJvbWlzZSIsImFsbCIsImV4ZWN1dG9yIiwic3VjY2VzcyIsInJlc3VsdCIsImFyZ3MiLCJvcHRpb25zIiwiZW52IiwiZW52aXJvbm1lbnQiLCJ0aW1lb3V0Iiwibm90aWZpY2F0aW9uIiwibm90aWZpY2F0aW9ucyIsImFkZEluZm8iLCJkaXNtaXNzYWJsZSIsInIiLCJleGVjIiwiZGlzbWlzcyIsImV4aXRjb2RlIiwiYWRkRXJyb3IiLCJkZXRhaWwiLCJqb2luIiwiZXJyb3IiLCJjb2RlIiwibWVzc2FnZSIsInN0ZGVy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QUFQLE9BQWtCLEVBQXJELEVBQTBEO0FBQ3hEN0UsV0FBSzRELGFBQUwsQ0FBbUJrQixVQUFuQixDQUE4QixjQUE5QixFQUE4QztBQUM1Q1YsZ0JBQVFJLFFBQVFLLElBQVIsRUFEb0M7QUFFNUNmLHFCQUFhO0FBRitCLE9BQTlDO0FBSUEsYUFBTyxFQUFFVixTQUFTLEtBQVgsRUFBa0JDLFFBQVFVLENBQTFCLEVBQVA7QUFDRDs7QUFFRC9ELFNBQUs0RCxhQUFMLENBQW1CbUIsVUFBbkIsQ0FBOEJQLFFBQVFLLElBQVIsRUFBOUI7QUFDQSxXQUFPLEVBQUV6QixTQUFTLElBQVgsRUFBaUJDLFFBQVFVLENBQXpCLEVBQVA7QUFDRDtBQWhKWTs7UUFtSk5yRSxRLEdBQUFBLFEiLCJmaWxlIjoiZ29yZW5hbWUuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvbXl1Z2EvLmF0b20vcGFja2FnZXMvZ28tcGx1cy9saWIvcmVuYW1lIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgU2ltcGxlRGlhbG9nIH0gZnJvbSAnLi8uLi9zaW1wbGUtZGlhbG9nJ1xuaW1wb3J0IHsgaXNWYWxpZEVkaXRvciwgd29yZEFuZE9mZnNldCB9IGZyb20gJy4uL3V0aWxzJ1xuXG5pbXBvcnQgdHlwZSB7IEdvQ29uZmlnIH0gZnJvbSAnLi8uLi9jb25maWcvc2VydmljZSdcblxuY2xhc3MgR29yZW5hbWUge1xuICBnb2NvbmZpZzogR29Db25maWdcbiAgc3Vic2NyaXB0aW9uczogQ29tcG9zaXRlRGlzcG9zYWJsZVxuXG4gIGNvbnN0cnVjdG9yKGdvY29uZmlnOiBHb0NvbmZpZykge1xuICAgIHRoaXMuZ29jb25maWcgPSBnb2NvbmZpZ1xuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKFxuICAgICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3InLCAnZ29sYW5nOmdvcmVuYW1lJywgKCkgPT5cbiAgICAgICAgdGhpcy5jb21tYW5kSW52b2tlZCgpXG4gICAgICApXG4gICAgKVxuICB9XG5cbiAgZGlzcG9zZSgpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZGlzcG9zZSgpXG4gIH1cblxuICBhc3luYyBjb21tYW5kSW52b2tlZCgpIHtcbiAgICBjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKClcbiAgICBpZiAoIWVkaXRvciB8fCAhaXNWYWxpZEVkaXRvcihlZGl0b3IpKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNtZCA9IGF3YWl0IHRoaXMuZ29jb25maWcubG9jYXRvci5maW5kVG9vbCgnZ29yZW5hbWUnKVxuICAgICAgaWYgKCFjbWQpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBjb25zdCB7IHdvcmQsIG9mZnNldCB9ID0gd29yZEFuZE9mZnNldChlZGl0b3IpXG4gICAgICBjb25zdCBjdXJzb3IgPSBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKVxuXG4gICAgICBjb25zdCBkaWFsb2cgPSBuZXcgU2ltcGxlRGlhbG9nKHtcbiAgICAgICAgcHJvbXB0OiBgUmVuYW1lICR7d29yZH0gdG86YCxcbiAgICAgICAgaW5pdGlhbFZhbHVlOiB3b3JkLFxuICAgICAgICBvbkNvbmZpcm06IG5ld05hbWUgPT4ge1xuICAgICAgICAgIHRoaXMuc2F2ZUFsbEVkaXRvcnMoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBmaWxlID0gZWRpdG9yLmdldEJ1ZmZlcigpLmdldFBhdGgoKVxuICAgICAgICAgICAgICBpZiAoIWZpbGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zdCBjd2QgPSBwYXRoLmRpcm5hbWUoZmlsZSlcblxuICAgICAgICAgICAgICAvLyByZXN0b3JlIGN1cnNvciBwb3NpdGlvbiBhZnRlciBnb3JlbmFtZSBjb21wbGV0ZXMgYW5kIHRoZSBidWZmZXIgaXMgcmVsb2FkZWRcbiAgICAgICAgICAgICAgaWYgKGN1cnNvcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRpc3AgPSBlZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRSZWxvYWQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgZWRpdG9yLnNldEN1cnNvckJ1ZmZlclBvc2l0aW9uKGN1cnNvciwgeyBhdXRvc2Nyb2xsOiBmYWxzZSB9KVxuICAgICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IGF0b20udmlld3MuZ2V0VmlldyhlZGl0b3IpXG4gICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmZvY3VzKClcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIGRpc3AuZGlzcG9zZSgpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB0aGlzLnJ1bkdvcmVuYW1lKGZpbGUsIG9mZnNldCwgY3dkLCBuZXdOYW1lLCBjbWQpXG4gICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaChlID0+IGNvbnNvbGUubG9nKGUpKSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGVcbiAgICAgICAgfSxcbiAgICAgICAgb25DYW5jZWw6ICgpID0+IHtcbiAgICAgICAgICBlZGl0b3Iuc2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oY3Vyc29yLCB7IGF1dG9zY3JvbGw6IGZhbHNlIH0pXG4gICAgICAgICAgY29uc3QgZWxlbWVudCA9IGF0b20udmlld3MuZ2V0VmlldyhlZGl0b3IpXG4gICAgICAgICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgICAgIGVsZW1lbnQuZm9jdXMoKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgZGlhbG9nLmF0dGFjaCgpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUuaGFuZGxlKSB7XG4gICAgICAgIGUuaGFuZGxlKClcbiAgICAgIH1cbiAgICAgIGNvbnNvbGUubG9nKGUpIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuICAgIH1cbiAgfVxuXG4gIHNhdmVBbGxFZGl0b3JzKCkge1xuICAgIGNvbnN0IHByb21pc2VzID0gW11cbiAgICBmb3IgKGNvbnN0IGVkaXRvciBvZiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpKSB7XG4gICAgICBpZiAoZWRpdG9yLmlzTW9kaWZpZWQoKSAmJiBpc1ZhbGlkRWRpdG9yKGVkaXRvcikpIHtcbiAgICAgICAgcHJvbWlzZXMucHVzaChlZGl0b3Iuc2F2ZSgpKVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpXG4gIH1cblxuICBhc3luYyBydW5Hb3JlbmFtZShcbiAgICBmaWxlOiBzdHJpbmcsXG4gICAgb2Zmc2V0OiBudW1iZXIsXG4gICAgY3dkOiBzdHJpbmcsXG4gICAgbmV3TmFtZTogc3RyaW5nLFxuICAgIGNtZDogc3RyaW5nXG4gICkge1xuICAgIGlmICghdGhpcy5nb2NvbmZpZyB8fCAhdGhpcy5nb2NvbmZpZy5leGVjdXRvcikge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlc3VsdDogbnVsbCB9XG4gICAgfVxuXG4gICAgY29uc3QgYXJncyA9IFsnLW9mZnNldCcsIGAke2ZpbGV9OiMke29mZnNldH1gLCAnLXRvJywgbmV3TmFtZV1cbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgY3dkOiBjd2QsXG4gICAgICBlbnY6IHRoaXMuZ29jb25maWcuZW52aXJvbm1lbnQoKSxcbiAgICAgIHRpbWVvdXQ6IDIwMDAwXG4gICAgfVxuICAgIGNvbnN0IG5vdGlmaWNhdGlvbiA9IGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKCdSZW5hbWluZy4uLicsIHtcbiAgICAgIGRpc21pc3NhYmxlOiB0cnVlXG4gICAgfSlcbiAgICBjb25zdCByID0gYXdhaXQgdGhpcy5nb2NvbmZpZy5leGVjdXRvci5leGVjKGNtZCwgYXJncywgb3B0aW9ucylcbiAgICBub3RpZmljYXRpb24uZGlzbWlzcygpXG4gICAgaWYgKHIuZXhpdGNvZGUgPT09IDEyNCkge1xuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKCdPcGVyYXRpb24gdGltZWQgb3V0Jywge1xuICAgICAgICBkZXRhaWw6ICdnb3JlbmFtZSAnICsgYXJncy5qb2luKCcgJyksXG4gICAgICAgIGRpc21pc3NhYmxlOiB0cnVlXG4gICAgICB9KVxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlc3VsdDogciB9XG4gICAgfSBlbHNlIGlmIChyLmVycm9yKSB7XG4gICAgICBpZiAoci5lcnJvci5jb2RlID09PSAnRU5PRU5UJykge1xuICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoJ01pc3NpbmcgUmVuYW1lIFRvb2wnLCB7XG4gICAgICAgICAgZGV0YWlsOlxuICAgICAgICAgICAgJ1RoZSBnb3JlbmFtZSB0b29sIGlzIHJlcXVpcmVkIHRvIHBlcmZvcm0gYSByZW5hbWUuIFBsZWFzZSBydW4gZ28gZ2V0IC11IGdvbGFuZy5vcmcveC90b29scy9jbWQvZ29yZW5hbWUgdG8gZ2V0IGl0LicsXG4gICAgICAgICAgZGlzbWlzc2FibGU6IHRydWVcbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcignUmVuYW1lIEVycm9yJywge1xuICAgICAgICAgIGRldGFpbDogci5lcnJvci5tZXNzYWdlLFxuICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVzdWx0OiByIH1cbiAgICB9XG5cbiAgICBjb25zdCBzdGRlcnIgPSByLnN0ZGVyciBpbnN0YW5jZW9mIEJ1ZmZlciA/IHIuc3RkZXJyLnRvU3RyaW5nKCkgOiByLnN0ZGVyclxuICAgIGNvbnN0IHN0ZG91dCA9IHIuc3Rkb3V0IGluc3RhbmNlb2YgQnVmZmVyID8gci5zdGRvdXQudG9TdHJpbmcoKSA6IHIuc3Rkb3V0XG4gICAgY29uc3QgbWVzc2FnZSA9IHN0ZGVyci50cmltKCkgKyAnXFxyXFxuJyArIHN0ZG91dC50cmltKClcbiAgICBpZiAoci5leGl0Y29kZSAhPT0gMCB8fCAoc3RkZXJyICYmIHN0ZGVyci50cmltKCkgIT09ICcnKSkge1xuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFdhcm5pbmcoJ1JlbmFtZSBFcnJvcicsIHtcbiAgICAgICAgZGV0YWlsOiBtZXNzYWdlLnRyaW0oKSxcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWVcbiAgICAgIH0pXG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVzdWx0OiByIH1cbiAgICB9XG5cbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkU3VjY2VzcyhtZXNzYWdlLnRyaW0oKSlcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCByZXN1bHQ6IHIgfVxuICB9XG59XG5cbmV4cG9ydCB7IEdvcmVuYW1lIH1cbiJdfQ==