Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.OutlineProvider = undefined;

var _guruUtils = require('../guru-utils');

const toOutline = (editor, goOutline, results) => {
  goOutline.forEach(item => {
    let { label } = item;
    let kind = item.type;

    // omit '-' variable assignments
    if (label === '_' && kind === 'variable') return;

    // distinguish methods from ordinary functions
    if (item.receiverType) {
      label = `(${item.receiverType}).${label}`;
      kind = 'method';
    }

    // there isn't an atom-ide-ui icon for "import", so we'll use
    // 'file' for our top-level container and 'package' for imports
    if (kind === 'package') kind = 'file';
    if (kind === 'import') kind = 'package';

    // TODO: this assumes a character index === byte index
    const start = editor.getBuffer().positionForCharacterIndex(item.start - 1);
    const end = editor.getBuffer().positionForCharacterIndex(item.end - 1);

    const line = editor.lineTextForBufferRow(start.row);

    if (kind === 'type') {
      // distinguish between structs and interfaces
      if (line.includes('type')) {
        if (line.includes('interface')) kind = 'interface';
        if (line.includes('struct')) kind = 'class'; // TODO: is there a better icon?
      }

      // TODO: what about other type definitions?  'type' is not valid..
    }

    // go-outline doesn't distinguish constants from variables,
    // but we can get _some_ constants by looking for const in the line
    // (this won't catch multiple constants in a single GenDecl, though)
    if (kind === 'variable' && line.includes('const')) {
      kind = 'constant';
    }

    const converted = {
      kind: kind,
      plainText: label,
      representativeName: label,
      startPosition: start,
      endPosition: end,
      children: []
    };
    results.push(converted);

    // recurse through children
    if (item.children && item.children.length) {
      toOutline(editor, item.children, converted.children);
    }
  });
};

class OutlineProvider {

  constructor(goconfig) {
    this.name = 'go-plus';
    this.priority = 2;
    this.grammarScopes = ['go', 'source.go'];
    this.updateOnEdit = false;

    this.goconfig = goconfig;
  }

  async getCmd() {
    if (this.cmd) return this.cmd;

    const r = await this.goconfig.locator.findTool('go-outline');
    if (r) this.cmd = r;

    return this.cmd;
  }

  async getOutline(editor) {
    const p = editor.getPath();
    if (!p) return null;

    const cmd = await this.getCmd();
    if (!cmd) return null;

    const options = {};
    options.timeout = 3000;
    const args = ['-f', p];
    const archive = (0, _guruUtils.buildGuruArchive)(editor);
    if (archive && archive.length) {
      args.push('-modified');
      options.input = archive;
    }

    const r = await this.goconfig.executor.exec(cmd, args, options);
    if (r.exitcode !== 0) return null;

    const stdout = typeof r.stdout === 'string' ? r.stdout : r.stdout.toString();
    const goOutlineResult = JSON.parse(stdout);

    const trees = [];
    toOutline(editor, goOutlineResult, trees);
    return { outlineTrees: trees };
  }
}
exports.OutlineProvider = OutlineProvider;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm91dGxpbmUtcHJvdmlkZXIuanMiXSwibmFtZXMiOlsidG9PdXRsaW5lIiwiZWRpdG9yIiwiZ29PdXRsaW5lIiwicmVzdWx0cyIsImZvckVhY2giLCJpdGVtIiwibGFiZWwiLCJraW5kIiwidHlwZSIsInJlY2VpdmVyVHlwZSIsInN0YXJ0IiwiZ2V0QnVmZmVyIiwicG9zaXRpb25Gb3JDaGFyYWN0ZXJJbmRleCIsImVuZCIsImxpbmUiLCJsaW5lVGV4dEZvckJ1ZmZlclJvdyIsInJvdyIsImluY2x1ZGVzIiwiY29udmVydGVkIiwicGxhaW5UZXh0IiwicmVwcmVzZW50YXRpdmVOYW1lIiwic3RhcnRQb3NpdGlvbiIsImVuZFBvc2l0aW9uIiwiY2hpbGRyZW4iLCJwdXNoIiwibGVuZ3RoIiwiT3V0bGluZVByb3ZpZGVyIiwiY29uc3RydWN0b3IiLCJnb2NvbmZpZyIsIm5hbWUiLCJwcmlvcml0eSIsImdyYW1tYXJTY29wZXMiLCJ1cGRhdGVPbkVkaXQiLCJnZXRDbWQiLCJjbWQiLCJyIiwibG9jYXRvciIsImZpbmRUb29sIiwiZ2V0T3V0bGluZSIsInAiLCJnZXRQYXRoIiwib3B0aW9ucyIsInRpbWVvdXQiLCJhcmdzIiwiYXJjaGl2ZSIsImlucHV0IiwiZXhlY3V0b3IiLCJleGVjIiwiZXhpdGNvZGUiLCJzdGRvdXQiLCJ0b1N0cmluZyIsImdvT3V0bGluZVJlc3VsdCIsIkpTT04iLCJwYXJzZSIsInRyZWVzIiwib3V0bGluZVRyZWVzIl0sIm1hcHBpbmdzIjoiOzs7OztBQUVBOztBQStFQSxNQUFNQSxZQUFZLENBQ2hCQyxNQURnQixFQUVoQkMsU0FGZ0IsRUFHaEJDLE9BSGdCLEtBSWI7QUFDSEQsWUFBVUUsT0FBVixDQUFrQkMsUUFBUTtBQUN4QixRQUFJLEVBQUVDLEtBQUYsS0FBWUQsSUFBaEI7QUFDQSxRQUFJRSxPQUFPRixLQUFLRyxJQUFoQjs7QUFFQTtBQUNBLFFBQUlGLFVBQVUsR0FBVixJQUFpQkMsU0FBUyxVQUE5QixFQUEwQzs7QUFFMUM7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QUFXQSxRQUFRbkIsTUFBdkIsRUFBK0I7QUFDN0JrQixXQUFLbkIsSUFBTCxDQUFVLFdBQVY7QUFDQWlCLGNBQVFJLEtBQVIsR0FBZ0JELE9BQWhCO0FBQ0Q7O0FBRUQsVUFBTVQsSUFBSSxNQUFNLEtBQUtQLFFBQUwsQ0FBY2tCLFFBQWQsQ0FBdUJDLElBQXZCLENBQTRCYixHQUE1QixFQUFpQ1MsSUFBakMsRUFBdUNGLE9BQXZDLENBQWhCO0FBQ0EsUUFBSU4sRUFBRWEsUUFBRixLQUFlLENBQW5CLEVBQXNCLE9BQU8sSUFBUDs7QUFFdEIsVUFBTUMsU0FBUyxPQUFPZCxFQUFFYyxNQUFULEtBQW9CLFFBQXBCLEdBQStCZCxFQUFFYyxNQUFqQyxHQUEwQ2QsRUFBRWMsTUFBRixDQUFTQyxRQUFULEVBQXpEO0FBQ0EsVUFBTUMsa0JBQWtCQyxLQUFLQyxLQUFMLENBQVdKLE1BQVgsQ0FBeEI7O0FBRUEsVUFBTUssUUFBNEIsRUFBbEM7QUFDQXRELGNBQVVDLE1BQVYsRUFBa0JrRCxlQUFsQixFQUFtQ0csS0FBbkM7QUFDQSxXQUFPLEVBQUVDLGNBQWNELEtBQWhCLEVBQVA7QUFDRDtBQS9DMEI7UUFBaEI1QixlLEdBQUFBLGUiLCJmaWxlIjoib3V0bGluZS1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS9teXVnYS8uYXRvbS9wYWNrYWdlcy9nby1wbHVzL2xpYi9vdXRsaW5lIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgYnVpbGRHdXJ1QXJjaGl2ZSB9IGZyb20gJy4uL2d1cnUtdXRpbHMnXG5pbXBvcnQgdHlwZSB7IEdvQ29uZmlnIH0gZnJvbSAnLi4vY29uZmlnL3NlcnZpY2UnXG5cbnR5cGUgVG9rZW5LaW5kID1cbiAgfCAna2V5d29yZCdcbiAgfCAnY2xhc3MtbmFtZSdcbiAgfCAnY29uc3RydWN0b3InXG4gIHwgJ21ldGhvZCdcbiAgfCAncGFyYW0nXG4gIHwgJ3N0cmluZydcbiAgfCAnd2hpdGVzcGFjZSdcbiAgfCAncGxhaW4nXG4gIHwgJ3R5cGUnXG5cbnR5cGUgVGV4dFRva2VuID0ge1xuICBraW5kOiBUb2tlbktpbmQsXG4gIHZhbHVlOiBzdHJpbmdcbn1cblxudHlwZSBUb2tlbml6ZWRUZXh0ID0gQXJyYXk8VGV4dFRva2VuPlxuXG50eXBlIE91dGxpbmUgPSB7IG91dGxpbmVUcmVlczogQXJyYXk8T3V0bGluZVRyZWU+IH1cblxudHlwZSBPdXRsaW5lVHJlZSA9IHtcbiAgaWNvbj86IHN0cmluZywgLy8gZnJvbSBhdG9tJE9jdGljb24gKHRoYXQgdHlwZSdzIG5vdCBhbGxvd2VkIG92ZXIgcnBjIHNvIHdlIHVzZSBzdHJpbmcpXG4gIGtpbmQ/OiBPdXRsaW5lVHJlZUtpbmQsIC8vIGtpbmQgeW91IGNhbiBwYXNzIHRvIHRoZSBVSSBmb3IgdGhlbWluZ1xuXG4gIC8vIE11c3QgYmUgb25lIG9yIHRoZSBvdGhlci4gSWYgYm90aCBhcmUgcHJlc2VudCwgdG9rZW5pemVkVGV4dCBpcyBwcmVmZXJyZWQuXG4gIHBsYWluVGV4dD86IHN0cmluZyxcbiAgdG9rZW5pemVkVGV4dD86IFRva2VuaXplZFRleHQsXG5cbiAgLy8gSWYgdXNlciBoYXMgYXRvbS1pZGUtb3V0bGluZS12aWV3Lm5hbWVPbmx5IHRoZW4gcmVwcmVzZW50YXRpdmVOYW1lIGlzIHVzZWQgaW5zdGVhZC5cbiAgcmVwcmVzZW50YXRpdmVOYW1lPzogc3RyaW5nLFxuXG4gIHN0YXJ0UG9zaXRpb246IGF0b20kUG9pbnQsXG4gIGVuZFBvc2l0aW9uPzogYXRvbSRQb2ludCxcbiAgbGFuZGluZ1Bvc2l0aW9uPzogYXRvbSRQb2ludCxcbiAgY2hpbGRyZW46IEFycmF5PE91dGxpbmVUcmVlPlxufVxuXG50eXBlIE91dGxpbmVUcmVlS2luZCA9XG4gIHwgJ2ZpbGUnXG4gIHwgJ21vZHVsZSdcbiAgfCAnbmFtZXNwYWNlJ1xuICB8ICdwYWNrYWdlJ1xuICB8ICdjbGFzcydcbiAgfCAnbWV0aG9kJ1xuICB8ICdwcm9wZXJ0eSdcbiAgfCAnZmllbGQnXG4gIHwgJ2NvbnN0cnVjdG9yJ1xuICB8ICdlbnVtJ1xuICB8ICdpbnRlcmZhY2UnXG4gIHwgJ2Z1bmN0aW9uJ1xuICB8ICd2YXJpYWJsZSdcbiAgfCAnY29uc3RhbnQnXG4gIHwgJ3N0cmluZydcbiAgfCAnbnVtYmVyJ1xuICB8ICdib29sZWFuJ1xuICB8ICdhcnJheSdcblxudHlwZSBHb091dGxpbmVSYW5nZSA9IHtcbiAgc3RhcnQ6IG51bWJlcixcbiAgZW5kOiBudW1iZXJcbn1cblxudHlwZSBHb091dGxpbmVUeXBlID0gJ3ZhcmlhYmxlJyB8ICd0eXBlJyB8ICdpbXBvcnQnIHwgJ2Z1bmN0aW9uJyB8ICdwYWNrYWdlJ1xuXG50eXBlIEdvT3V0bGluZURlY2xhcmF0aW9uID0ge1xuICBsYWJlbDogc3RyaW5nLFxuICB0eXBlOiBHb091dGxpbmVUeXBlLFxuICByZWNlaXZlclR5cGU/OiBzdHJpbmcsXG4gIGljb24/OiBzdHJpbmcsXG4gIHN0YXJ0OiBudW1iZXIsXG4gIGVuZDogbnVtYmVyLFxuICBjaGlsZHJlbj86IEdvT3V0bGluZURlY2xhcmF0aW9uW10sXG4gIHNpZ25hdHVyZT86IEdvT3V0bGluZVJhbmdlLFxuICBjb21tZW50PzogR29PdXRsaW5lUmFuZ2Vcbn1cblxuY29uc3QgdG9PdXRsaW5lID0gKFxuICBlZGl0b3I6IFRleHRFZGl0b3IsXG4gIGdvT3V0bGluZTogQXJyYXk8R29PdXRsaW5lRGVjbGFyYXRpb24+LFxuICByZXN1bHRzOiBBcnJheTxPdXRsaW5lVHJlZT5cbikgPT4ge1xuICBnb091dGxpbmUuZm9yRWFjaChpdGVtID0+IHtcbiAgICBsZXQgeyBsYWJlbCB9ID0gaXRlbVxuICAgIGxldCBraW5kID0gaXRlbS50eXBlXG5cbiAgICAvLyBvbWl0ICctJyB2YXJpYWJsZSBhc3NpZ25tZW50c1xuICAgIGlmIChsYWJlbCA9PT0gJ18nICYmIGtpbmQgPT09ICd2YXJpYWJsZScpIHJldHVyblxuXG4gICAgLy8gZGlzdGluZ3Vpc2ggbWV0aG9kcyBmcm9tIG9yZGluYXJ5IGZ1bmN0aW9uc1xuICAgIGlmIChpdGVtLnJlY2VpdmVyVHlwZSkge1xuICAgICAgbGFiZWwgPSBgKCR7aXRlbS5yZWNlaXZlclR5cGV9KS4ke2xhYmVsfWBcbiAgICAgIGtpbmQgPSAnbWV0aG9kJ1xuICAgIH1cblxuICAgIC8vIHRoZXJlIGlzbid0IGFuIGF0b20taWRlLXVpIGljb24gZm9yIFwiaW1wb3J0XCIsIHNvIHdlJ2xsIHVzZVxuICAgIC8vICdmaWxlJyBmb3Igb3VyIHRvcC1sZXZlbCBjb250YWluZXIgYW5kICdwYWNrYWdlJyBmb3IgaW1wb3J0c1xuICAgIGlmIChraW5kID09PSAncGFja2FnZScpIGtpbmQgPSAnZmlsZSdcbiAgICBpZiAoa2luZCA9PT0gJ2ltcG9ydCcpIGtpbmQgPSAncGFja2FnZSdcblxuICAgIC8vIFRPRE86IHRoaXMgYXNzdW1lcyBhIGNoYXJhY3RlciBpbmRleCA9PT0gYnl0ZSBpbmRleFxuICAgIGNvbnN0IHN0YXJ0ID0gZWRpdG9yLmdldEJ1ZmZlcigpLnBvc2l0aW9uRm9yQ2hhcmFjdGVySW5kZXgoaXRlbS5zdGFydCAtIDEpXG4gICAgY29uc3QgZW5kID0gZWRpdG9yLmdldEJ1ZmZlcigpLnBvc2l0aW9uRm9yQ2hhcmFjdGVySW5kZXgoaXRlbS5lbmQgLSAxKVxuXG4gICAgY29uc3QgbGluZSA9IGVkaXRvci5saW5lVGV4dEZvckJ1ZmZlclJvdyhzdGFydC5yb3cpXG5cbiAgICBpZiAoa2luZCA9PT0gJ3R5cGUnKSB7XG4gICAgICAvLyBkaXN0aW5ndWlzaCBiZXR3ZWVuIHN0cnVjdHMgYW5kIGludGVyZmFjZXNcbiAgICAgIGlmIChsaW5lLmluY2x1ZGVzKCd0eXBlJykpIHtcbiAgICAgICAgaWYgKGxpbmUuaW5jbHVkZXMoJ2ludGVyZmFjZScpKSBraW5kID0gJ2ludGVyZmFjZSdcbiAgICAgICAgaWYgKGxpbmUuaW5jbHVkZXMoJ3N0cnVjdCcpKSBraW5kID0gJ2NsYXNzJyAvLyBUT0RPOiBpcyB0aGVyZSBhIGJldHRlciBpY29uP1xuICAgICAgfVxuXG4gICAgICAvLyBUT0RPOiB3aGF0IGFib3V0IG90aGVyIHR5cGUgZGVmaW5pdGlvbnM/ICAndHlwZScgaXMgbm90IHZhbGlkLi5cbiAgICB9XG5cbiAgICAvLyBnby1vdXRsaW5lIGRvZXNuJ3QgZGlzdGluZ3Vpc2ggY29uc3RhbnRzIGZyb20gdmFyaWFibGVzLFxuICAgIC8vIGJ1dCB3ZSBjYW4gZ2V0IF9zb21lXyBjb25zdGFudHMgYnkgbG9va2luZyBmb3IgY29uc3QgaW4gdGhlIGxpbmVcbiAgICAvLyAodGhpcyB3b24ndCBjYXRjaCBtdWx0aXBsZSBjb25zdGFudHMgaW4gYSBzaW5nbGUgR2VuRGVjbCwgdGhvdWdoKVxuICAgIGlmIChraW5kID09PSAndmFyaWFibGUnICYmIGxpbmUuaW5jbHVkZXMoJ2NvbnN0JykpIHtcbiAgICAgIGtpbmQgPSAnY29uc3RhbnQnXG4gICAgfVxuXG4gICAgY29uc3QgY29udmVydGVkOiBPdXRsaW5lVHJlZSA9IHtcbiAgICAgIGtpbmQ6IChraW5kOiBhbnkpLFxuICAgICAgcGxhaW5UZXh0OiBsYWJlbCxcbiAgICAgIHJlcHJlc2VudGF0aXZlTmFtZTogbGFiZWwsXG4gICAgICBzdGFydFBvc2l0aW9uOiBzdGFydCxcbiAgICAgIGVuZFBvc2l0aW9uOiBlbmQsXG4gICAgICBjaGlsZHJlbjogW11cbiAgICB9XG4gICAgcmVzdWx0cy5wdXNoKGNvbnZlcnRlZClcblxuICAgIC8vIHJlY3Vyc2UgdGhyb3VnaCBjaGlsZHJlblxuICAgIGlmIChpdGVtLmNoaWxkcmVuICYmIGl0ZW0uY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICB0b091dGxpbmUoZWRpdG9yLCBpdGVtLmNoaWxkcmVuLCBjb252ZXJ0ZWQuY2hpbGRyZW4pXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgY2xhc3MgT3V0bGluZVByb3ZpZGVyIHtcbiAgZ29jb25maWc6IEdvQ29uZmlnXG4gIGNtZDogc3RyaW5nXG5cbiAgbmFtZSA9ICdnby1wbHVzJ1xuICBwcmlvcml0eSA9IDJcbiAgZ3JhbW1hclNjb3BlcyA9IFsnZ28nLCAnc291cmNlLmdvJ11cbiAgdXBkYXRlT25FZGl0ID0gZmFsc2VcblxuICBjb25zdHJ1Y3Rvcihnb2NvbmZpZzogR29Db25maWcpIHtcbiAgICB0aGlzLmdvY29uZmlnID0gZ29jb25maWdcbiAgfVxuXG4gIGFzeW5jIGdldENtZCgpOiBQcm9taXNlPD9zdHJpbmc+IHtcbiAgICBpZiAodGhpcy5jbWQpIHJldHVybiB0aGlzLmNtZFxuXG4gICAgY29uc3QgciA9IGF3YWl0IHRoaXMuZ29jb25maWcubG9jYXRvci5maW5kVG9vbCgnZ28tb3V0bGluZScpXG4gICAgaWYgKHIpIHRoaXMuY21kID0gclxuXG4gICAgcmV0dXJuIHRoaXMuY21kXG4gIH1cblxuICBhc3luYyBnZXRPdXRsaW5lKGVkaXRvcjogVGV4dEVkaXRvcik6IFByb21pc2U8P091dGxpbmU+IHtcbiAgICBjb25zdCBwID0gZWRpdG9yLmdldFBhdGgoKVxuICAgIGlmICghcCkgcmV0dXJuIG51bGxcblxuICAgIGNvbnN0IGNtZCA9IGF3YWl0IHRoaXMuZ2V0Q21kKClcbiAgICBpZiAoIWNtZCkgcmV0dXJuIG51bGxcblxuICAgIGNvbnN0IG9wdGlvbnMgPSB7fVxuICAgIG9wdGlvbnMudGltZW91dCA9IDMwMDBcbiAgICBjb25zdCBhcmdzID0gWyctZicsIHBdXG4gICAgY29uc3QgYXJjaGl2ZSA9IGJ1aWxkR3VydUFyY2hpdmUoZWRpdG9yKVxuICAgIGlmIChhcmNoaXZlICYmIGFyY2hpdmUubGVuZ3RoKSB7XG4gICAgICBhcmdzLnB1c2goJy1tb2RpZmllZCcpXG4gICAgICBvcHRpb25zLmlucHV0ID0gYXJjaGl2ZVxuICAgIH1cblxuICAgIGNvbnN0IHIgPSBhd2FpdCB0aGlzLmdvY29uZmlnLmV4ZWN1dG9yLmV4ZWMoY21kLCBhcmdzLCBvcHRpb25zKVxuICAgIGlmIChyLmV4aXRjb2RlICE9PSAwKSByZXR1cm4gbnVsbFxuXG4gICAgY29uc3Qgc3Rkb3V0ID0gdHlwZW9mIHIuc3Rkb3V0ID09PSAnc3RyaW5nJyA/IHIuc3Rkb3V0IDogci5zdGRvdXQudG9TdHJpbmcoKVxuICAgIGNvbnN0IGdvT3V0bGluZVJlc3VsdCA9IEpTT04ucGFyc2Uoc3Rkb3V0KVxuXG4gICAgY29uc3QgdHJlZXM6IEFycmF5PE91dGxpbmVUcmVlPiA9IFtdXG4gICAgdG9PdXRsaW5lKGVkaXRvciwgZ29PdXRsaW5lUmVzdWx0LCB0cmVlcylcbiAgICByZXR1cm4geyBvdXRsaW5lVHJlZXM6IHRyZWVzIH1cbiAgfVxufVxuIl19