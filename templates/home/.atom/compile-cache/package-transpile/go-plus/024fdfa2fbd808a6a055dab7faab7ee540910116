Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Navigator = undefined;

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _atom = require('atom');

var _guruUtils = require('../guru-utils');

var _utils = require('../utils');

var _navigationStack = require('./navigation-stack');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Navigator {

  constructor(goconfig) {
    this.goconfig = goconfig;
    this.godefCommand = 'golang:godef';
    this.returnCommand = 'golang:godef-return';
    this.navigationStack = new _navigationStack.NavigationStack();
    this.subscriptions = new _atom.CompositeDisposable();
    this.subscriptions.add(atom.commands.add('atom-workspace', 'golang:godef', () => {
      if (!this.disposed) {
        this.gotoDefinitionForWordAtCursor();
      }
    }));
    this.subscriptions.add(atom.commands.add('atom-workspace', 'golang:godef-return', () => {
      if (this.navigationStack && !this.disposed) {
        this.navigationStack.restorePreviousLocation();
      }
    }));
    this.disposed = false;
  }

  dispose() {
    this.disposed = true;
    if (this.subscriptions) {
      this.subscriptions.dispose();
    }
  }

  async gotoDefinitionForWordAtCursor() {
    const editor = (0, _utils.getEditor)();
    if (!editor) {
      return false;
    }

    if (editor.hasMultipleCursors()) {
      atom.notifications.addWarning('go-plus', {
        dismissable: true,
        icon: 'location',
        detail: 'go to definition only works with a single cursor'
      });
      return false;
    }

    return this.gotoDefinitionForBufferPosition(editor.getCursorBufferPosition(), editor);
  }

  async definitionForBufferPosition(pos, editor) {
    const tool = atom.config.get('go-plus.navigator.mode');
    const r = tool === 'guru' ? await this.executeGuru(pos, editor) : await this.executeGodef(pos, editor);
    if (!r || r.exitcode !== 0) {
      return null;
    }
    const stdout = r.stdout instanceof Buffer ? r.stdout.toString() : r.stdout;
    return tool === 'guru' ? this.parseGuruLocation(stdout) : this.parseGodefLocation(stdout);
  }

  async gotoDefinitionForBufferPosition(pos, editor) {
    if (!editor || !pos) {
      return false;
    }

    const def = await this.definitionForBufferPosition(pos, editor);
    if (!def || !def.pos) return false;

    return this.visitLocation(def);
  }

  async executeGuru(pos, editor) {
    if (!editor || !pos) {
      return false;
    }
    const cmd = await this.goconfig.locator.findTool('guru');
    if (!cmd) {
      return false;
    }
    const filepath = editor.getPath();
    if (!filepath) {
      return false;
    }
    const archive = (0, _guruUtils.buildGuruArchive)();

    const options = this.goconfig.executor.getOptions('file', editor);
    if (archive && archive !== '') {
      options.input = archive;
    }

    pos = (0, _guruUtils.adjustPositionForGuru)(pos, editor);
    const offset = (0, _utils.utf8OffsetForBufferPosition)(pos, editor);
    const args = ['-json', 'definition', filepath + ':#' + offset];
    if (archive && archive !== '') {
      args.unshift('-modified');
    }
    return this.goconfig.executor.exec(cmd, args, options);
  }

  async executeGodef(pos, editor) {
    const cmd = await this.goconfig.locator.findTool('godef');
    if (!cmd) {
      return false;
    }
    const filepath = editor.getPath();
    if (!filepath) {
      return false;
    }
    const offset = (0, _utils.utf8OffsetForBufferPosition)(pos, editor);
    const args = ['-f', filepath, '-o', offset.toString(), '-i'];
    const options = this.goconfig.executor.getOptions('file', editor);
    options.input = editor.getText();
    return this.goconfig.executor.exec(cmd, args, options);
  }

  parseGuruLocation(stdout) {
    let output;
    try {
      output = JSON.parse(stdout);
    } catch (e) {
      console.log(e); // eslint-disable-line no-console
    }

    if (!output || !output.objpos) {
      return null;
    }

    const parsed = (0, _utils.parseGoPosition)(output.objpos.trim());
    if (!parsed) {
      return null;
    }
    const result = {};
    result.filepath = parsed.file;
    result.raw = stdout;

    if (parsed.line !== false && parsed.column !== false) {
      result.pos = new _atom.Point(parseInt(parsed.line) - 1, parseInt(parsed.column) - 1);
    }
    return result;
  }

  parseGodefLocation(godefStdout) {
    const pos = (0, _utils.parseGoPosition)(godefStdout);

    const result = {};
    result.filepath = pos.file;
    result.raw = godefStdout;

    if (pos.hasOwnProperty('line') && pos.hasOwnProperty('column')) {
      // atom's cursors are 0-based; godef uses diff-like 1-based
      const correct = str => parseInt(str, 10) - 1;
      result.pos = new _atom.Point(correct(pos.line), correct(pos.column));
    }
    return result;
  }

  async visitLocation(loc) {
    if (!loc || !loc.filepath) {
      const opts = {};
      opts.dismissable = true;
      opts.icon = 'location';
      opts.detail = 'definition tool returned malformed output';

      if (loc) {
        opts.description = JSON.stringify(loc.raw);
      }
      atom.notifications.addWarning('go-plus', opts);
      return false;
    }
    try {
      const l = loc;
      const stats = await (0, _utils.stat)(loc.filepath);
      this.navigationStack.pushCurrentLocation();
      if (stats.isDirectory()) {
        return this.visitDirectory(l);
      } else {
        return this.visitFile(l);
      }
    } catch (e) {
      atom.notifications.addWarning('go-plus', {
        dismissable: true,
        icon: 'location',
        detail: 'definition tool returned invalid file path',
        description: loc.filepath
      });
      return false;
    }
  }

  async visitFile(loc) {
    return (0, _utils.openFile)(loc.filepath, loc.pos);
  }

  async visitDirectory(loc) {
    try {
      const file = await this.findFirstGoFile(loc.filepath);
      loc.filepath = file;
      return this.visitFile(loc);
    } catch (err) {
      if (err.handle) {
        err.handle();
      }
      atom.notifications.addWarning('go-plus', {
        dismissable: true,
        icon: 'location',
        detail: 'godef return invalid directory',
        description: loc.filepath
      });
    }
  }

  findFirstGoFile(dir) {
    return new Promise((resolve, reject) => {
      _fs2.default.readdir(dir, (err, files) => {
        if (err) {
          reject(err);
        }

        const filepath = this.firstGoFilePath(dir, files.sort());
        if (filepath) {
          resolve(filepath);
        } else {
          reject(new Error(dir + 'has no non-test .go file'));
        }
      });
    });
  }

  firstGoFilePath(dir, files) {
    for (const file of files) {
      if (file.endsWith('.go') && file.indexOf('_test') === -1) {
        return _path2.default.join(dir, file);
      }
    }
    return null;
  }
}

exports.Navigator = Navigator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5hdmlnYXRvci5qcyJdLCJuYW1lcyI6WyJOYXZpZ2F0b3IiLCJjb25zdHJ1Y3RvciIsImdvY29uZmlnIiwiZ29kZWZDb21tYW5kIiwicmV0dXJuQ29tbWFuZCIsIm5hdmlnYXRpb25TdGFjayIsIk5hdmlnYXRpb25TdGFjayIsInN1YnNjcmlwdGlvbnMiLCJDb21wb3NpdGVEaXNwb3NhYmxlIiwiYWRkIiwiYXRvbSIsImNvbW1hbmRzIiwiZGlzcG9zZWQiLCJnb3RvRGVmaW5pdGlvbkZvcldvcmRBdEN1cnNvciIsInJlc3RvcmVQcmV2aW91c0xvY2F0aW9uIiwiZGlzcG9zZSIsImVkaXRvciIsImhhc011bHRpcGxlQ3Vyc29ycyIsIm5vdGlmaWNhdGlvbnMiLCJhZGRXYXJuaW5nIiwiZGlzbWlzc2FibGUiLCJpY29uIiwiZGV0YWlsIiwiZ290b0RlZmluaXRpb25Gb3JCdWZmZXJQb3NpdGlvbiIsImdldEN1cnNvckJ1ZmZlclBvc2l0aW9uIiwiZGVmaW5pdGlvbkZvckJ1ZmZlclBvc2l0aW9uIiwicG9zIiwidG9vbCIsImNvbmZpZyIsImdldCIsInIiLCJleGVjdXRlR3VydSIsImV4ZWN1dGVHb2RlZiIsImV4aXRjb2RlIiwic3Rkb3V0IiwiQnVmZmVyIiwidG9TdHJpbmciLCJwYXJzZUd1cnVMb2NhdGlvbiIsInBhcnNlR29kZWZMb2NhdGlvbiIsImRlZiIsInZpc2l0TG9jYXRpb24iLCJjbWQiLCJsb2NhdG9yIiwiZmluZFRvb2wiLCJmaWxlcGF0aCIsImdldFBhdGgiLCJhcmNoaXZlIiwib3B0aW9ucyIsImV4ZWN1dG9yIiwiZ2V0T3B0aW9ucyIsImlucHV0Iiwib2Zmc2V0IiwiYXJncyIsInVuc2hpZnQiLCJleGVjIiwiZ2V0VGV4dCIsIm91dHB1dCIsIkpTT04iLCJwYXJzZSIsImUiLCJjb25zb2xlIiwibG9nIiwib2JqcG9zIiwicGFyc2VkIiwidHJpbSIsInJlc3VsdCIsImZpbGUiLCJyYXciLCJsaW5lIiwiY29sdW1uIiwiUG9pbnQiLCJwYXJzZUludCIsImdvZGVmU3Rkb3V0IiwiaGFzT3duUHJvcGVydHkiLCJjb3JyZWN0Iiwic3RyIiwibG9jIiwib3B0cyIsImRlc2NyaXB0aW9uIiwic3RyaW5naWZ5IiwibCIsInN0YXRzIiwicHVzaEN1cnJlbnRMb2NhdGlvbiIsImlzRGlyZWN0b3J5IiwidmlzaXREaXJlY3RvcnkiLCJ2aXNpdEZpbGUiLCJmaW5kRmlyc3RHb0ZpbGUiLCJlcnIiLCJoYW5kbGUiLCJkaXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZzIiwicmVhZGRpciIsImZpbGVzIiwiZmlyc3RHb0ZpbGVQYXRoIiwic29ydCIsIkVycm9yIiwiZW5kc1dpdGgiLCJpbmRleE9mIiwicGF0aCIsImpvaW4iXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOztBQU9BOzs7O0FBTUEsTUFBTUEsU0FBTixDQUFnQjs7QUFRZEMsY0FBWUMsUUFBWixFQUFnQztBQUM5QixTQUFLQSxRQUFMLEdBQWdCQSxRQUFoQjtBQUNBLFNBQUtDLFlBQUwsR0FBb0IsY0FBcEI7QUFDQSxTQUFLQyxhQUFMLEdBQXFCLHFCQUFyQjtBQUNBLFNBQUtDLGVBQUwsR0FBdUIsSUFBSUMsZ0NBQUosRUFBdkI7QUFDQSxTQUFLQyxhQUFMLEdBQXFCLElBQUlDLHlCQUFKLEVBQXJCO0FBQ0EsU0FBS0QsYUFBTCxDQUFtQkUsR0FBbkIsQ0FDRUMsS0FBS0MsUUFBTCxDQUFjRixHQUFkLENBQWtCLGdCQUFsQixFQUFvQyxjQUFwQyxFQUFvRCxNQUFNO0FBQ3hELFVBQUksQ0FBQyxLQUFLRyxRQUFWLEVBQW9CO0FBQ2xCLGFBQUtDLDZCQUFMO0FBQ0Q7QUFDRixLQUpELENBREY7QUFPQSxTQUFLTixhQUFMLENBQW1CRSxHQUFuQixDQUNFQyxLQUFLQyxRQUFMLENBQWNGLEdBQWQsQ0FBa0IsZ0JBQWxCLEVBQW9DLHFCQUFwQyxFQUEyRCxNQUFNO0FBQy9ELFVBQUksS0FBS0osZUFBTCxJQUF3QixDQUFDLEtBQUtPLFFB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QUFqQjtBQUNBLFlBQUlyRCxRQUFKLEVBQWM7QUFDWitDLGtCQUFRL0MsUUFBUjtBQUNELFNBRkQsTUFFTztBQUNMZ0QsaUJBQU8sSUFBSU0sS0FBSixDQUFVVCxNQUFNLDBCQUFoQixDQUFQO0FBQ0Q7QUFDRixPQVhEO0FBWUQsS0FiTSxDQUFQO0FBY0Q7O0FBRURPLGtCQUFnQlAsR0FBaEIsRUFBNkJNLEtBQTdCLEVBQWtFO0FBQ2hFLFNBQUssTUFBTTdCLElBQVgsSUFBbUI2QixLQUFuQixFQUEwQjtBQUN4QixVQUFJN0IsS0FBS2lDLFFBQUwsQ0FBYyxLQUFkLEtBQXdCakMsS0FBS2tDLE9BQUwsQ0FBYSxPQUFiLE1BQTBCLENBQUMsQ0FBdkQsRUFBMEQ7QUFDeEQsZUFBT0MsZUFBS0MsSUFBTCxDQUFVYixHQUFWLEVBQWV2QixJQUFmLENBQVA7QUFDRDtBQUNGO0FBQ0QsV0FBTyxJQUFQO0FBQ0Q7QUF4UWE7O1FBMlFQbEUsUyxHQUFBQSxTIiwiZmlsZSI6Im5hdmlnYXRvci5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS9teXVnYS8uYXRvbS9wYWNrYWdlcy9nby1wbHVzL2xpYi9uYXZpZ2F0b3IiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgZnMgZnJvbSAnZnMnXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSwgUG9pbnQgfSBmcm9tICdhdG9tJ1xuaW1wb3J0IHsgYWRqdXN0UG9zaXRpb25Gb3JHdXJ1LCBidWlsZEd1cnVBcmNoaXZlIH0gZnJvbSAnLi4vZ3VydS11dGlscydcbmltcG9ydCB7XG4gIGdldEVkaXRvcixcbiAgb3BlbkZpbGUsXG4gIHBhcnNlR29Qb3NpdGlvbixcbiAgc3RhdCxcbiAgdXRmOE9mZnNldEZvckJ1ZmZlclBvc2l0aW9uXG59IGZyb20gJy4uL3V0aWxzJ1xuaW1wb3J0IHsgTmF2aWdhdGlvblN0YWNrIH0gZnJvbSAnLi9uYXZpZ2F0aW9uLXN0YWNrJ1xuXG5pbXBvcnQgdHlwZSB7IEdvQ29uZmlnIH0gZnJvbSAnLi8uLi9jb25maWcvc2VydmljZSdcbmltcG9ydCB0eXBlIHsgRXhlY1Jlc3VsdCB9IGZyb20gJy4vLi4vY29uZmlnL2V4ZWN1dG9yJ1xuaW1wb3J0IHR5cGUgeyBEZWZMb2NhdGlvbiB9IGZyb20gJy4vZGVmaW5pdGlvbi10eXBlcydcblxuY2xhc3MgTmF2aWdhdG9yIHtcbiAgZ29jb25maWc6IEdvQ29uZmlnXG4gIGdvZGVmQ29tbWFuZDogc3RyaW5nXG4gIHJldHVybkNvbW1hbmQ6IHN0cmluZ1xuICBuYXZpZ2F0aW9uU3RhY2s6IE5hdmlnYXRpb25TdGFja1xuICBzdWJzY3JpcHRpb25zOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIGRpc3Bvc2VkOiBib29sZWFuXG5cbiAgY29uc3RydWN0b3IoZ29jb25maWc6IEdvQ29uZmlnKSB7XG4gICAgdGhpcy5nb2NvbmZpZyA9IGdvY29uZmlnXG4gICAgdGhpcy5nb2RlZkNvbW1hbmQgPSAnZ29sYW5nOmdvZGVmJ1xuICAgIHRoaXMucmV0dXJuQ29tbWFuZCA9ICdnb2xhbmc6Z29kZWYtcmV0dXJuJ1xuICAgIHRoaXMubmF2aWdhdGlvblN0YWNrID0gbmV3IE5hdmlnYXRpb25TdGFjaygpXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoXG4gICAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS13b3Jrc3BhY2UnLCAnZ29sYW5nOmdvZGVmJywgKCkgPT4ge1xuICAgICAgICBpZiAoIXRoaXMuZGlzcG9zZWQpIHtcbiAgICAgICAgICB0aGlzLmdvdG9EZWZpbml0aW9uRm9yV29yZEF0Q3Vyc29yKClcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsICdnb2xhbmc6Z29kZWYtcmV0dXJuJywgKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5uYXZpZ2F0aW9uU3RhY2sgJiYgIXRoaXMuZGlzcG9zZWQpIHtcbiAgICAgICAgICB0aGlzLm5hdmlnYXRpb25TdGFjay5yZXN0b3JlUHJldmlvdXNMb2NhdGlvbigpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKVxuICAgIHRoaXMuZGlzcG9zZWQgPSBmYWxzZVxuICB9XG5cbiAgZGlzcG9zZSgpIHtcbiAgICB0aGlzLmRpc3Bvc2VkID0gdHJ1ZVxuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5kaXNwb3NlKClcbiAgICB9XG4gIH1cblxuICBhc3luYyBnb3RvRGVmaW5pdGlvbkZvcldvcmRBdEN1cnNvcigpOiBQcm9taXNlPGFueT4ge1xuICAgIGNvbnN0IGVkaXRvciA9IGdldEVkaXRvcigpXG4gICAgaWYgKCFlZGl0b3IpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIGlmIChlZGl0b3IuaGFzTXVsdGlwbGVDdXJzb3JzKCkpIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKCdnby1wbHVzJywge1xuICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgaWNvbjogJ2xvY2F0aW9uJyxcbiAgICAgICAgZGV0YWlsOiAnZ28gdG8gZGVmaW5pdGlvbiBvbmx5IHdvcmtzIHdpdGggYSBzaW5nbGUgY3Vyc29yJ1xuICAgICAgfSlcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmdvdG9EZWZpbml0aW9uRm9yQnVmZmVyUG9zaXRpb24oXG4gICAgICBlZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKSxcbiAgICAgIGVkaXRvclxuICAgIClcbiAgfVxuXG4gIGFzeW5jIGRlZmluaXRpb25Gb3JCdWZmZXJQb3NpdGlvbihcbiAgICBwb3M6IGF0b20kUG9pbnQsXG4gICAgZWRpdG9yOiBUZXh0RWRpdG9yXG4gICk6IFByb21pc2U8P0RlZkxvY2F0aW9uPiB7XG4gICAgY29uc3QgdG9vbCA9IGF0b20uY29uZmlnLmdldCgnZ28tcGx1cy5uYXZpZ2F0b3IubW9kZScpXG4gICAgY29uc3QgciA9XG4gICAgICB0b29sID09PSAnZ3VydSdcbiAgICAgICAgPyBhd2FpdCB0aGlzLmV4ZWN1dGVHdXJ1KHBvcywgZWRpdG9yKVxuICAgICAgICA6IGF3YWl0IHRoaXMuZXhlY3V0ZUdvZGVmKHBvcywgZWRpdG9yKVxuICAgIGlmICghciB8fCByLmV4aXRjb2RlICE9PSAwKSB7XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cbiAgICBjb25zdCBzdGRvdXQgPSByLnN0ZG91dCBpbnN0YW5jZW9mIEJ1ZmZlciA/IHIuc3Rkb3V0LnRvU3RyaW5nKCkgOiByLnN0ZG91dFxuICAgIHJldHVybiB0b29sID09PSAnZ3VydSdcbiAgICAgID8gdGhpcy5wYXJzZUd1cnVMb2NhdGlvbihzdGRvdXQpXG4gICAgICA6IHRoaXMucGFyc2VHb2RlZkxvY2F0aW9uKHN0ZG91dClcbiAgfVxuXG4gIGFzeW5jIGdvdG9EZWZpbml0aW9uRm9yQnVmZmVyUG9zaXRpb24oXG4gICAgcG9zOiBhdG9tJFBvaW50LFxuICAgIGVkaXRvcjogVGV4dEVkaXRvclxuICApOiBQcm9taXNlPGFueT4ge1xuICAgIGlmICghZWRpdG9yIHx8ICFwb3MpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIGNvbnN0IGRlZiA9IGF3YWl0IHRoaXMuZGVmaW5pdGlvbkZvckJ1ZmZlclBvc2l0aW9uKHBvcywgZWRpdG9yKVxuICAgIGlmICghZGVmIHx8ICFkZWYucG9zKSByZXR1cm4gZmFsc2VcblxuICAgIHJldHVybiB0aGlzLnZpc2l0TG9jYXRpb24oZGVmKVxuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUd1cnUoXG4gICAgcG9zOiBhdG9tJFBvaW50LFxuICAgIGVkaXRvcjogVGV4dEVkaXRvclxuICApOiBQcm9taXNlPEV4ZWNSZXN1bHQgfCBmYWxzZT4ge1xuICAgIGlmICghZWRpdG9yIHx8ICFwb3MpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICBjb25zdCBjbWQgPSBhd2FpdCB0aGlzLmdvY29uZmlnLmxvY2F0b3IuZmluZFRvb2woJ2d1cnUnKVxuICAgIGlmICghY21kKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgY29uc3QgZmlsZXBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpXG4gICAgaWYgKCFmaWxlcGF0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICAgIGNvbnN0IGFyY2hpdmUgPSBidWlsZEd1cnVBcmNoaXZlKClcblxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdvY29uZmlnLmV4ZWN1dG9yLmdldE9wdGlvbnMoJ2ZpbGUnLCBlZGl0b3IpXG4gICAgaWYgKGFyY2hpdmUgJiYgYXJjaGl2ZSAhPT0gJycpIHtcbiAgICAgIG9wdGlvbnMuaW5wdXQgPSBhcmNoaXZlXG4gICAgfVxuXG4gICAgcG9zID0gYWRqdXN0UG9zaXRpb25Gb3JHdXJ1KHBvcywgZWRpdG9yKVxuICAgIGNvbnN0IG9mZnNldCA9IHV0ZjhPZmZzZXRGb3JCdWZmZXJQb3NpdGlvbihwb3MsIGVkaXRvcilcbiAgICBjb25zdCBhcmdzID0gWyctanNvbicsICdkZWZpbml0aW9uJywgZmlsZXBhdGggKyAnOiMnICsgb2Zmc2V0XVxuICAgIGlmIChhcmNoaXZlICYmIGFyY2hpdmUgIT09ICcnKSB7XG4gICAgICBhcmdzLnVuc2hpZnQoJy1tb2RpZmllZCcpXG4gICAgfVxuICAgIHJldHVybiB0aGlzLmdvY29uZmlnLmV4ZWN1dG9yLmV4ZWMoY21kLCBhcmdzLCBvcHRpb25zKVxuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUdvZGVmKFxuICAgIHBvczogYXRvbSRQb2ludExpa2UsXG4gICAgZWRpdG9yOiBUZXh0RWRpdG9yXG4gICk6IFByb21pc2U8RXhlY1Jlc3VsdCB8IGZhbHNlPiB7XG4gICAgY29uc3QgY21kID0gYXdhaXQgdGhpcy5nb2NvbmZpZy5sb2NhdG9yLmZpbmRUb29sKCdnb2RlZicpXG4gICAgaWYgKCFjbWQpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICBjb25zdCBmaWxlcGF0aCA9IGVkaXRvci5nZXRQYXRoKClcbiAgICBpZiAoIWZpbGVwYXRoKSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgY29uc3Qgb2Zmc2V0ID0gdXRmOE9mZnNldEZvckJ1ZmZlclBvc2l0aW9uKHBvcywgZWRpdG9yKVxuICAgIGNvbnN0IGFyZ3MgPSBbJy1mJywgZmlsZXBhdGgsICctbycsIG9mZnNldC50b1N0cmluZygpLCAnLWknXVxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdvY29uZmlnLmV4ZWN1dG9yLmdldE9wdGlvbnMoJ2ZpbGUnLCBlZGl0b3IpXG4gICAgb3B0aW9ucy5pbnB1dCA9IGVkaXRvci5nZXRUZXh0KClcbiAgICByZXR1cm4gdGhpcy5nb2NvbmZpZy5leGVjdXRvci5leGVjKGNtZCwgYXJncywgb3B0aW9ucylcbiAgfVxuXG4gIHBhcnNlR3VydUxvY2F0aW9uKHN0ZG91dDogc3RyaW5nKTogRGVmTG9jYXRpb24gfCBudWxsIHtcbiAgICBsZXQgb3V0cHV0XG4gICAgdHJ5IHtcbiAgICAgIG91dHB1dCA9IEpTT04ucGFyc2Uoc3Rkb3V0KVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGUpIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuICAgIH1cblxuICAgIGlmICghb3V0cHV0IHx8ICFvdXRwdXQub2JqcG9zKSB7XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cblxuICAgIGNvbnN0IHBhcnNlZCA9IHBhcnNlR29Qb3NpdGlvbihvdXRwdXQub2JqcG9zLnRyaW0oKSlcbiAgICBpZiAoIXBhcnNlZCkge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0ID0ge31cbiAgICByZXN1bHQuZmlsZXBhdGggPSBwYXJzZWQuZmlsZVxuICAgIHJlc3VsdC5yYXcgPSBzdGRvdXRcblxuICAgIGlmIChwYXJzZWQubGluZSAhPT0gZmFsc2UgJiYgcGFyc2VkLmNvbHVtbiAhPT0gZmFsc2UpIHtcbiAgICAgIHJlc3VsdC5wb3MgPSBuZXcgUG9pbnQoXG4gICAgICAgIHBhcnNlSW50KHBhcnNlZC5saW5lKSAtIDEsXG4gICAgICAgIHBhcnNlSW50KHBhcnNlZC5jb2x1bW4pIC0gMVxuICAgICAgKVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0XG4gIH1cblxuICBwYXJzZUdvZGVmTG9jYXRpb24oZ29kZWZTdGRvdXQ6IHN0cmluZyk6IERlZkxvY2F0aW9uIHwgbnVsbCB7XG4gICAgY29uc3QgcG9zID0gcGFyc2VHb1Bvc2l0aW9uKGdvZGVmU3Rkb3V0KVxuXG4gICAgY29uc3QgcmVzdWx0ID0ge31cbiAgICByZXN1bHQuZmlsZXBhdGggPSBwb3MuZmlsZVxuICAgIHJlc3VsdC5yYXcgPSBnb2RlZlN0ZG91dFxuXG4gICAgaWYgKHBvcy5oYXNPd25Qcm9wZXJ0eSgnbGluZScpICYmIHBvcy5oYXNPd25Qcm9wZXJ0eSgnY29sdW1uJykpIHtcbiAgICAgIC8vIGF0b20ncyBjdXJzb3JzIGFyZSAwLWJhc2VkOyBnb2RlZiB1c2VzIGRpZmYtbGlrZSAxLWJhc2VkXG4gICAgICBjb25zdCBjb3JyZWN0ID0gc3RyID0+IHBhcnNlSW50KHN0ciwgMTApIC0gMVxuICAgICAgcmVzdWx0LnBvcyA9IG5ldyBQb2ludChjb3JyZWN0KHBvcy5saW5lKSwgY29ycmVjdChwb3MuY29sdW1uKSlcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgYXN5bmMgdmlzaXRMb2NhdGlvbihsb2M6IERlZkxvY2F0aW9uIHwgbnVsbCkge1xuICAgIGlmICghbG9jIHx8ICFsb2MuZmlsZXBhdGgpIHtcbiAgICAgIGNvbnN0IG9wdHMgPSB7fVxuICAgICAgb3B0cy5kaXNtaXNzYWJsZSA9IHRydWVcbiAgICAgIG9wdHMuaWNvbiA9ICdsb2NhdGlvbidcbiAgICAgIG9wdHMuZGV0YWlsID0gJ2RlZmluaXRpb24gdG9vbCByZXR1cm5lZCBtYWxmb3JtZWQgb3V0cHV0J1xuXG4gICAgICBpZiAobG9jKSB7XG4gICAgICAgIG9wdHMuZGVzY3JpcHRpb24gPSBKU09OLnN0cmluZ2lmeShsb2MucmF3KVxuICAgICAgfVxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFdhcm5pbmcoJ2dvLXBsdXMnLCBvcHRzKVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBjb25zdCBsOiBEZWZMb2NhdGlvbiA9IGxvY1xuICAgICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBzdGF0KGxvYy5maWxlcGF0aClcbiAgICAgIHRoaXMubmF2aWdhdGlvblN0YWNrLnB1c2hDdXJyZW50TG9jYXRpb24oKVxuICAgICAgaWYgKHN0YXRzLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudmlzaXREaXJlY3RvcnkobClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLnZpc2l0RmlsZShsKVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKCdnby1wbHVzJywge1xuICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgaWNvbjogJ2xvY2F0aW9uJyxcbiAgICAgICAgZGV0YWlsOiAnZGVmaW5pdGlvbiB0b29sIHJldHVybmVkIGludmFsaWQgZmlsZSBwYXRoJyxcbiAgICAgICAgZGVzY3JpcHRpb246IGxvYy5maWxlcGF0aFxuICAgICAgfSlcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHZpc2l0RmlsZShsb2M6IERlZkxvY2F0aW9uKTogUHJvbWlzZTxUZXh0RWRpdG9yPiB7XG4gICAgcmV0dXJuIG9wZW5GaWxlKGxvYy5maWxlcGF0aCwgbG9jLnBvcylcbiAgfVxuXG4gIGFzeW5jIHZpc2l0RGlyZWN0b3J5KGxvYzogRGVmTG9jYXRpb24pOiBQcm9taXNlPD9UZXh0RWRpdG9yPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLmZpbmRGaXJzdEdvRmlsZShsb2MuZmlsZXBhdGgpXG4gICAgICBsb2MuZmlsZXBhdGggPSBmaWxlXG4gICAgICByZXR1cm4gdGhpcy52aXNpdEZpbGUobG9jKVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGVyci5oYW5kbGUpIHtcbiAgICAgICAgZXJyLmhhbmRsZSgpXG4gICAgICB9XG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZygnZ28tcGx1cycsIHtcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgIGljb246ICdsb2NhdGlvbicsXG4gICAgICAgIGRldGFpbDogJ2dvZGVmIHJldHVybiBpbnZhbGlkIGRpcmVjdG9yeScsXG4gICAgICAgIGRlc2NyaXB0aW9uOiBsb2MuZmlsZXBhdGhcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgZmluZEZpcnN0R29GaWxlKGRpcjogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgZnMucmVhZGRpcihkaXIsIChlcnIsIGZpbGVzKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZmlsZXBhdGggPSB0aGlzLmZpcnN0R29GaWxlUGF0aChkaXIsIGZpbGVzLnNvcnQoKSlcbiAgICAgICAgaWYgKGZpbGVwYXRoKSB7XG4gICAgICAgICAgcmVzb2x2ZShmaWxlcGF0aClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGRpciArICdoYXMgbm8gbm9uLXRlc3QgLmdvIGZpbGUnKSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgZmlyc3RHb0ZpbGVQYXRoKGRpcjogc3RyaW5nLCBmaWxlczogQXJyYXk8c3RyaW5nPik6IHN0cmluZyB8IG51bGwge1xuICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgaWYgKGZpbGUuZW5kc1dpdGgoJy5nbycpICYmIGZpbGUuaW5kZXhPZignX3Rlc3QnKSA9PT0gLTEpIHtcbiAgICAgICAgcmV0dXJuIHBhdGguam9pbihkaXIsIGZpbGUpXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsXG4gIH1cbn1cblxuZXhwb3J0IHsgTmF2aWdhdG9yIH1cbiJdfQ==