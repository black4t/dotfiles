Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.GoModifyTags = undefined;

var _atom = require('atom');

var _utils = require('../utils');

var _guruUtils = require('../guru-utils');

var _tagsDialog = require('./tags-dialog');

class GoModifyTags {

  constructor(goconfig) {
    this.goconfig = goconfig;
    this.subscriptions = new _atom.CompositeDisposable();
    this.subscriptions.add(atom.commands.add('atom-workspace', 'golang:add-tags', () => this.commandInvoked('Add')));
    this.subscriptions.add(atom.commands.add('atom-workspace', 'golang:remove-tags', () => this.commandInvoked('Remove')));
  }

  dispose() {
    this.subscriptions.dispose();
  }

  async commandInvoked(mode) {
    const editor = atom.workspace.getActiveTextEditor();
    if (!editor || !(0, _utils.isValidEditor)(editor)) {
      return;
    }

    if (editor.hasMultipleCursors()) {
      atom.notifications.addWarning('go-plus', {
        dismissable: true,
        icon: 'tag',
        detail: 'Modifying tags only works with a single cursor'
      });
      return;
    }
    const cmd = await this.goconfig.locator.findTool('gomodifytags');
    if (cmd) {
      const dialog = new _tagsDialog.TagsDialog({
        mode: mode
      });
      const c = cmd;
      dialog.onAccept = options => this.modifyTags(editor, options, mode, c);
      dialog.attach();
    }
  }

  buildArgs(editor, options, mode) {
    const { tags, transform, sortTags } = options;

    // if there is a selection, use the -line flag,
    // otherwise just use the cursor offset (and apply modifications to entire struct)
    const args = ['-file', editor.getPath() || ''];
    const selection = editor.getSelectedBufferRange();
    if (selection && !selection.start.isEqual(selection.end)) {
      args.push('-line');
      if (selection.isSingleLine()) {
        args.push(`${selection.start.row + 1}`);
      } else {
        args.push(`${selection.start.row + 1},${selection.end.row + 1}`);
      }
    } else {
      args.push('-offset');
      args.push((0, _utils.wordAndOffset)(editor).offset.toString());
    }

    if (editor.isModified()) {
      args.push('-modified');
    }

    if (transform) {
      args.push('-transform');
      args.push(transform);
    }
    if (sortTags) {
      args.push('-sort');
    }

    if (mode === 'Add') {
      const tagNames = [];
      const opts = [];
      for (const t of tags) {
        tagNames.push(t.tag);
        if (t.option && t.option.length) {
          opts.push(`${t.tag}=${t.option}`);
        }
      }
      if (opts.length > 0) {
        args.push('-add-options');
        args.push(opts.join(','));
      }
      if (tagNames.length === 0) {
        tagNames.push('json');
      }
      args.push('-add-tags', tagNames.join(','));
    } else if (mode === 'Remove') {
      const tagNames = [];
      const opts = [];
      if (!tags || !tags.length) {
        args.push('-clear-tags');
      } else {
        for (const t of tags) {
          if (t.option && t.option.length) {
            opts.push(`${t.tag}=${t.option}`);
          } else {
            tagNames.push(t.tag);
          }
        }
        if (tagNames.length > 0) {
          args.push('-remove-tags');
          args.push(tagNames.join(','));
        }
        if (opts.length > 0) {
          args.push('-remove-options');
          args.push(opts.join(','));
        }
      }
    }
    return args;
  }

  async modifyTags(editor, options, mode, cmd) {
    const executorOptions = this.goconfig.executor.getOptions('file', editor);

    if (editor.isModified()) {
      executorOptions.input = (0, _guruUtils.buildGuruArchive)(editor);
    }

    const args = this.buildArgs(editor, options, mode);
    const r = await this.goconfig.executor.exec(cmd, args, executorOptions);
    if (r.error) {
      if (r.error.code === 'ENOENT') {
        atom.notifications.addError('Missing Tool', {
          detail: 'Missing the `gomodifytags` tool.',
          dismissable: true
        });
      } else {
        atom.notifications.addError('Error', {
          detail: r.error.message,
          dismissable: true
        });
      }
      return { success: false, result: r };
    } else if (r.exitcode !== 0) {
      const stderr = r.stderr instanceof Buffer ? r.stderr.toString() : r.stderr;
      atom.notifications.addError('Error', {
        detail: stderr.trim(),
        dismissable: true
      });
      return { success: false, result: r };
    }
    editor.getBuffer().setTextViaDiff(r.stdout.toString());
    return { success: true, result: r };
  }
}

exports.GoModifyTags = GoModifyTags;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImdvbW9kaWZ5dGFncy5qcyJdLCJuYW1lcyI6WyJHb01vZGlmeVRhZ3MiLCJjb25zdHJ1Y3RvciIsImdvY29uZmlnIiwic3Vic2NyaXB0aW9ucyIsIkNvbXBvc2l0ZURpc3Bvc2FibGUiLCJhZGQiLCJhdG9tIiwiY29tbWFuZHMiLCJjb21tYW5kSW52b2tlZCIsImRpc3Bvc2UiLCJtb2RlIiwiZWRpdG9yIiwid29ya3NwYWNlIiwiZ2V0QWN0aXZlVGV4dEVkaXRvciIsImhhc011bHRpcGxlQ3Vyc29ycyIsIm5vdGlmaWNhdGlvbnMiLCJhZGRXYXJuaW5nIiwiZGlzbWlzc2FibGUiLCJpY29uIiwiZGV0YWlsIiwiY21kIiwibG9jYXRvciIsImZpbmRUb29sIiwiZGlhbG9nIiwiVGFnc0RpYWxvZyIsImMiLCJvbkFjY2VwdCIsIm9wdGlvbnMiLCJtb2RpZnlUYWdzIiwiYXR0YWNoIiwiYnVpbGRBcmdzIiwidGFncyIsInRyYW5zZm9ybSIsInNvcnRUYWdzIiwiYXJncyIsImdldFBhdGgiLCJzZWxlY3Rpb24iLCJnZXRTZWxlY3RlZEJ1ZmZlclJhbmdlIiwic3RhcnQiLCJpc0VxdWFsIiwiZW5kIiwicHVzaCIsImlzU2luZ2xlTGluZSIsInJvdyIsIm9mZnNldCIsInRvU3RyaW5nIiwiaXNNb2RpZmllZCIsInRhZ05hbWVzIiwib3B0cyIsInQiLCJ0YWciLCJvcHRpb24iLCJsZW5ndGgiLCJqb2luIiwiZXhlY3V0b3JPcHRpb25zIiwiZXhlY3V0b3IiLCJnZXRPcHRpb25zIiwiaW5wdXQiLCJyIiwiZXhlYyIsImVycm9yIiwiY29kZSIsImFkZEVycm9yIiwibWVzc2FnZSIsInN1Y2Nlc3MiLCJyZXN1bHQiLCJleGl0Y29kZSIsInN0ZGVyciIsIkJ1ZmZlciIsInRyaW0iLCJnZXRCdWZmZXIiLCJzZXRUZXh0VmlhRGlmZiIsInN0ZG91dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFpQkEsTUFBTUEsWUFBTixDQUFtQjs7QUFJ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QUFyQixFQUErQjtBQUM3QnZELGFBQUtTLGFBQUwsQ0FBbUIrQyxRQUFuQixDQUE0QixjQUE1QixFQUE0QztBQUMxQzNDLGtCQUFRLGtDQURrQztBQUUxQ0YsdUJBQWE7QUFGNkIsU0FBNUM7QUFJRCxPQUxELE1BS087QUFDTFgsYUFBS1MsYUFBTCxDQUFtQitDLFFBQW5CLENBQTRCLE9BQTVCLEVBQXFDO0FBQ25DM0Msa0JBQVF1QyxFQUFFRSxLQUFGLENBQVFHLE9BRG1CO0FBRW5DOUMsdUJBQWE7QUFGc0IsU0FBckM7QUFJRDtBQUNELGFBQU8sRUFBRStDLFNBQVMsS0FBWCxFQUFrQkMsUUFBUVAsQ0FBMUIsRUFBUDtBQUNELEtBYkQsTUFhTyxJQUFJQSxFQUFFUSxRQUFGLEtBQWUsQ0FBbkIsRUFBc0I7QUFDM0IsWUFBTUMsU0FBU1QsRUFBRVMsTUFBRixZQUFvQkMsTUFBcEIsR0FBNkJWLEVBQUVTLE1BQUYsQ0FBU3RCLFFBQVQsRUFBN0IsR0FBbURhLEVBQUVTLE1BQXBFO0FBQ0E3RCxXQUFLUyxhQUFMLENBQW1CK0MsUUFBbkIsQ0FBNEIsT0FBNUIsRUFBcUM7QUFDbkMzQyxnQkFBUWdELE9BQU9FLElBQVAsRUFEMkI7QUFFbkNwRCxxQkFBYTtBQUZzQixPQUFyQztBQUlBLGFBQU8sRUFBRStDLFNBQVMsS0FBWCxFQUFrQkMsUUFBUVAsQ0FBMUIsRUFBUDtBQUNEO0FBQ0QvQyxXQUFPMkQsU0FBUCxHQUFtQkMsY0FBbkIsQ0FBa0NiLEVBQUVjLE1BQUYsQ0FBUzNCLFFBQVQsRUFBbEM7QUFDQSxXQUFPLEVBQUVtQixTQUFTLElBQVgsRUFBaUJDLFFBQVFQLENBQXpCLEVBQVA7QUFDRDtBQW5LZ0I7O1FBc0tWMUQsWSxHQUFBQSxZIiwiZmlsZSI6ImdvbW9kaWZ5dGFncy5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS9teXVnYS8uYXRvbS9wYWNrYWdlcy9nby1wbHVzL2xpYi90YWdzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHsgQ29tcG9zaXRlRGlzcG9zYWJsZSB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBpc1ZhbGlkRWRpdG9yLCB3b3JkQW5kT2Zmc2V0IH0gZnJvbSAnLi4vdXRpbHMnXG5pbXBvcnQgeyBidWlsZEd1cnVBcmNoaXZlIH0gZnJvbSAnLi4vZ3VydS11dGlscydcbmltcG9ydCB7IFRhZ3NEaWFsb2cgfSBmcm9tICcuL3RhZ3MtZGlhbG9nJ1xuXG5pbXBvcnQgdHlwZSB7IEdvQ29uZmlnIH0gZnJvbSAnLi8uLi9jb25maWcvc2VydmljZSdcblxudHlwZSBNb2RlID0gJ0FkZCcgfCAnUmVtb3ZlJ1xuXG5leHBvcnQgdHlwZSBUYWcgPSB7XG4gIHRhZzogc3RyaW5nLFxuICBvcHRpb24/OiBzdHJpbmdcbn1cblxuZXhwb3J0IHR5cGUgR29Nb2RpZnlUYWdzT3B0aW9ucyA9IHtcbiAgdGFnczogQXJyYXk8VGFnPixcbiAgdHJhbnNmb3JtOiAnc25ha2VjYXNlJyB8ICdjYW1lbGNhc2UnLCAvLyB8ICdsaXNwY2FzZScsXG4gIHNvcnRUYWdzOiBib29sZWFuXG59XG5cbmNsYXNzIEdvTW9kaWZ5VGFncyB7XG4gIGdvY29uZmlnOiBHb0NvbmZpZ1xuICBzdWJzY3JpcHRpb25zOiBDb21wb3NpdGVEaXNwb3NhYmxlXG5cbiAgY29uc3RydWN0b3IoZ29jb25maWc6IEdvQ29uZmlnKSB7XG4gICAgdGhpcy5nb2NvbmZpZyA9IGdvY29uZmlnXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5hZGQoXG4gICAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYXRvbS13b3Jrc3BhY2UnLCAnZ29sYW5nOmFkZC10YWdzJywgKCkgPT5cbiAgICAgICAgdGhpcy5jb21tYW5kSW52b2tlZCgnQWRkJylcbiAgICAgIClcbiAgICApXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsICdnb2xhbmc6cmVtb3ZlLXRhZ3MnLCAoKSA9PlxuICAgICAgICB0aGlzLmNvbW1hbmRJbnZva2VkKCdSZW1vdmUnKVxuICAgICAgKVxuICAgIClcbiAgfVxuXG4gIGRpc3Bvc2UoKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmRpc3Bvc2UoKVxuICB9XG5cbiAgYXN5bmMgY29tbWFuZEludm9rZWQobW9kZTogTW9kZSkge1xuICAgIGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKVxuICAgIGlmICghZWRpdG9yIHx8ICFpc1ZhbGlkRWRpdG9yKGVkaXRvcikpIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGlmIChlZGl0b3IuaGFzTXVsdGlwbGVDdXJzb3JzKCkpIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKCdnby1wbHVzJywge1xuICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgaWNvbjogJ3RhZycsXG4gICAgICAgIGRldGFpbDogJ01vZGlmeWluZyB0YWdzIG9ubHkgd29ya3Mgd2l0aCBhIHNpbmdsZSBjdXJzb3InXG4gICAgICB9KVxuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnN0IGNtZCA9IGF3YWl0IHRoaXMuZ29jb25maWcubG9jYXRvci5maW5kVG9vbCgnZ29tb2RpZnl0YWdzJylcbiAgICBpZiAoY21kKSB7XG4gICAgICBjb25zdCBkaWFsb2cgPSBuZXcgVGFnc0RpYWxvZyh7XG4gICAgICAgIG1vZGU6IG1vZGVcbiAgICAgIH0pXG4gICAgICBjb25zdCBjOiBzdHJpbmcgPSBjbWRcbiAgICAgIGRpYWxvZy5vbkFjY2VwdCA9IG9wdGlvbnMgPT4gdGhpcy5tb2RpZnlUYWdzKGVkaXRvciwgb3B0aW9ucywgbW9kZSwgYylcbiAgICAgIGRpYWxvZy5hdHRhY2goKVxuICAgIH1cbiAgfVxuXG4gIGJ1aWxkQXJncyhcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsXG4gICAgb3B0aW9uczogR29Nb2RpZnlUYWdzT3B0aW9ucyxcbiAgICBtb2RlOiBNb2RlXG4gICk6IEFycmF5PHN0cmluZz4ge1xuICAgIGNvbnN0IHsgdGFncywgdHJhbnNmb3JtLCBzb3J0VGFncyB9ID0gb3B0aW9uc1xuXG4gICAgLy8gaWYgdGhlcmUgaXMgYSBzZWxlY3Rpb24sIHVzZSB0aGUgLWxpbmUgZmxhZyxcbiAgICAvLyBvdGhlcndpc2UganVzdCB1c2UgdGhlIGN1cnNvciBvZmZzZXQgKGFuZCBhcHBseSBtb2RpZmljYXRpb25zIHRvIGVudGlyZSBzdHJ1Y3QpXG4gICAgY29uc3QgYXJncyA9IFsnLWZpbGUnLCBlZGl0b3IuZ2V0UGF0aCgpIHx8ICcnXVxuICAgIGNvbnN0IHNlbGVjdGlvbiA9IGVkaXRvci5nZXRTZWxlY3RlZEJ1ZmZlclJhbmdlKClcbiAgICBpZiAoc2VsZWN0aW9uICYmICFzZWxlY3Rpb24uc3RhcnQuaXNFcXVhbChzZWxlY3Rpb24uZW5kKSkge1xuICAgICAgYXJncy5wdXNoKCctbGluZScpXG4gICAgICBpZiAoc2VsZWN0aW9uLmlzU2luZ2xlTGluZSgpKSB7XG4gICAgICAgIGFyZ3MucHVzaChgJHtzZWxlY3Rpb24uc3RhcnQucm93ICsgMX1gKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXJncy5wdXNoKGAke3NlbGVjdGlvbi5zdGFydC5yb3cgKyAxfSwke3NlbGVjdGlvbi5lbmQucm93ICsgMX1gKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBhcmdzLnB1c2goJy1vZmZzZXQnKVxuICAgICAgYXJncy5wdXNoKHdvcmRBbmRPZmZzZXQoZWRpdG9yKS5vZmZzZXQudG9TdHJpbmcoKSlcbiAgICB9XG5cbiAgICBpZiAoZWRpdG9yLmlzTW9kaWZpZWQoKSkge1xuICAgICAgYXJncy5wdXNoKCctbW9kaWZpZWQnKVxuICAgIH1cblxuICAgIGlmICh0cmFuc2Zvcm0pIHtcbiAgICAgIGFyZ3MucHVzaCgnLXRyYW5zZm9ybScpXG4gICAgICBhcmdzLnB1c2godHJhbnNmb3JtKVxuICAgIH1cbiAgICBpZiAoc29ydFRhZ3MpIHtcbiAgICAgIGFyZ3MucHVzaCgnLXNvcnQnKVxuICAgIH1cblxuICAgIGlmIChtb2RlID09PSAnQWRkJykge1xuICAgICAgY29uc3QgdGFnTmFtZXMgPSBbXVxuICAgICAgY29uc3Qgb3B0cyA9IFtdXG4gICAgICBmb3IgKGNvbnN0IHQgb2YgdGFncykge1xuICAgICAgICB0YWdOYW1lcy5wdXNoKHQudGFnKVxuICAgICAgICBpZiAodC5vcHRpb24gJiYgdC5vcHRpb24ubGVuZ3RoKSB7XG4gICAgICAgICAgb3B0cy5wdXNoKGAke3QudGFnfT0ke3Qub3B0aW9ufWApXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChvcHRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgYXJncy5wdXNoKCctYWRkLW9wdGlvbnMnKVxuICAgICAgICBhcmdzLnB1c2gob3B0cy5qb2luKCcsJykpXG4gICAgICB9XG4gICAgICBpZiAodGFnTmFtZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRhZ05hbWVzLnB1c2goJ2pzb24nKVxuICAgICAgfVxuICAgICAgYXJncy5wdXNoKCctYWRkLXRhZ3MnLCB0YWdOYW1lcy5qb2luKCcsJykpXG4gICAgfSBlbHNlIGlmIChtb2RlID09PSAnUmVtb3ZlJykge1xuICAgICAgY29uc3QgdGFnTmFtZXMgPSBbXVxuICAgICAgY29uc3Qgb3B0cyA9IFtdXG4gICAgICBpZiAoIXRhZ3MgfHwgIXRhZ3MubGVuZ3RoKSB7XG4gICAgICAgIGFyZ3MucHVzaCgnLWNsZWFyLXRhZ3MnKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZm9yIChjb25zdCB0IG9mIHRhZ3MpIHtcbiAgICAgICAgICBpZiAodC5vcHRpb24gJiYgdC5vcHRpb24ubGVuZ3RoKSB7XG4gICAgICAgICAgICBvcHRzLnB1c2goYCR7dC50YWd9PSR7dC5vcHRpb259YClcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGFnTmFtZXMucHVzaCh0LnRhZylcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRhZ05hbWVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBhcmdzLnB1c2goJy1yZW1vdmUtdGFncycpXG4gICAgICAgICAgYXJncy5wdXNoKHRhZ05hbWVzLmpvaW4oJywnKSlcbiAgICAgICAgfVxuICAgICAgICBpZiAob3B0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgYXJncy5wdXNoKCctcmVtb3ZlLW9wdGlvbnMnKVxuICAgICAgICAgIGFyZ3MucHVzaChvcHRzLmpvaW4oJywnKSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYXJnc1xuICB9XG5cbiAgYXN5bmMgbW9kaWZ5VGFncyhcbiAgICBlZGl0b3I6IFRleHRFZGl0b3IsXG4gICAgb3B0aW9uczogR29Nb2RpZnlUYWdzT3B0aW9ucyxcbiAgICBtb2RlOiBNb2RlLFxuICAgIGNtZDogc3RyaW5nXG4gICkge1xuICAgIGNvbnN0IGV4ZWN1dG9yT3B0aW9ucyA9IHRoaXMuZ29jb25maWcuZXhlY3V0b3IuZ2V0T3B0aW9ucygnZmlsZScsIGVkaXRvcilcblxuICAgIGlmIChlZGl0b3IuaXNNb2RpZmllZCgpKSB7XG4gICAgICBleGVjdXRvck9wdGlvbnMuaW5wdXQgPSBidWlsZEd1cnVBcmNoaXZlKGVkaXRvcilcbiAgICB9XG5cbiAgICBjb25zdCBhcmdzID0gdGhpcy5idWlsZEFyZ3MoZWRpdG9yLCBvcHRpb25zLCBtb2RlKVxuICAgIGNvbnN0IHIgPSBhd2FpdCB0aGlzLmdvY29uZmlnLmV4ZWN1dG9yLmV4ZWMoY21kLCBhcmdzLCBleGVjdXRvck9wdGlvbnMpXG4gICAgaWYgKHIuZXJyb3IpIHtcbiAgICAgIGlmIChyLmVycm9yLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcignTWlzc2luZyBUb29sJywge1xuICAgICAgICAgIGRldGFpbDogJ01pc3NpbmcgdGhlIGBnb21vZGlmeXRhZ3NgIHRvb2wuJyxcbiAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKCdFcnJvcicsIHtcbiAgICAgICAgICBkZXRhaWw6IHIuZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZVxuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlc3VsdDogciB9XG4gICAgfSBlbHNlIGlmIChyLmV4aXRjb2RlICE9PSAwKSB7XG4gICAgICBjb25zdCBzdGRlcnIgPSByLnN0ZGVyciBpbnN0YW5jZW9mIEJ1ZmZlciA/IHIuc3RkZXJyLnRvU3RyaW5nKCkgOiByLnN0ZGVyclxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKCdFcnJvcicsIHtcbiAgICAgICAgZGV0YWlsOiBzdGRlcnIudHJpbSgpLFxuICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZVxuICAgICAgfSlcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZXN1bHQ6IHIgfVxuICAgIH1cbiAgICBlZGl0b3IuZ2V0QnVmZmVyKCkuc2V0VGV4dFZpYURpZmYoci5zdGRvdXQudG9TdHJpbmcoKSlcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCByZXN1bHQ6IHIgfVxuICB9XG59XG5cbmV4cG9ydCB7IEdvTW9kaWZ5VGFncyB9XG4iXX0=