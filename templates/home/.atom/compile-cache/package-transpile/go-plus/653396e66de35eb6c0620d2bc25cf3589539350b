Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Builder = undefined;

var _tokenizeArgString = require('yargs-parser/lib/tokenize-arg-string');

var _tokenizeArgString2 = _interopRequireDefault(_tokenizeArgString);

var _fsExtra = require('fs-extra');

var _fsExtra2 = _interopRequireDefault(_fsExtra);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _temp = require('@atom/temp');

var _temp2 = _interopRequireDefault(_temp);

var _atom = require('atom');

var _utils = require('./../utils');

var _environment = require('../config/environment');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Builder {

  constructor(goconfig, linter, output, busySignal) {
    this.goconfig = goconfig;
    this.linter = linter;
    this.output = output;
    this.subscriptions = new _atom.CompositeDisposable();
    this.busySignal = busySignal;

    _temp2.default.track();
  }

  dispose() {
    this.disposed = true;
    if (this.subscriptions) {
      this.subscriptions.dispose();
    }
    try {
      _temp2.default.cleanupSync();
    } catch (err) {
      // eslint-disable-next-line no-console
      console.log('builder cleanup:', err);
    }
  }

  deleteMessages() {
    const linter = this.linter();
    if (linter) {
      linter.clearMessages();
    }
  }

  setMessages(messages) {
    const linter = this.linter();
    if (linter && messages && messages.length) {
      linter.setAllMessages(messages);
    }
  }

  async build(editor, path) {
    if (!atom.config.get('go-plus.config.compileOnSave')) {
      return;
    }
    if (!(0, _utils.isValidEditor)(editor)) {
      throw new Error('invalid editor');
    }
    this.deleteMessages();
    const options = this.goconfig.executor.getOptions('file', editor);
    const cmd = await this.goconfig.locator.findTool('go');
    if (!cmd) {
      throw new Error('cannot find go tool');
    }
    const buildPromise = this.lintInstall(cmd, options);
    const testPromise = this.hasTests(path) ? this.lintTest(cmd, options) : Promise.resolve({ output: '', linterName: 'test', exitcode: 0 });

    const all = Promise.all([buildPromise, testPromise]);
    const bs = this.busySignal();
    const p = bs ? bs.reportBusyWhile('Building Go', () => all) : all;
    const results = await p;
    if (!results || results.length === 0) {
      return;
    }
    this.setMessages(this.getMessages(results, options.cwd || ''));

    // check for any non-zero exit codes and error if found
    for (const result of results) {
      if (result.exitcode !== 0) {
        if (this.output) {
          if (result.exitcode === 124) {
            let timeoutMsg = `${result.linterName} timed out`;
            if (options.timeout) {
              timeoutMsg += ` after ${options.timeout} ms`;
            }
            this.output.update({
              exitcode: result.exitcode,
              output: timeoutMsg,
              dir: options.cwd
            });
          } else {
            this.output.update({
              exitcode: result.exitcode,
              output: result.output,
              dir: options.cwd
            });
          }
        }
        throw new Error(result.output);
      }
    }
    // indicate that we're done, which is especially important when test on save is disabled
    // (we don't want to give the appearance that we're compiling indefinitely)
    if (this.output) {
      this.output.update({
        output: this.output.props.output + '\n\nDone'
      });
    }
  }

  getMessages(results, cwd) {
    let messages = [];
    for (const _ref of results) {
      const { output, linterName } = _ref;

      const newMessages = this.mapMessages(output, cwd, linterName);
      for (const newMessage of newMessages) {
        if (!messages.some(message => this.messageEquals(newMessage, message))) {
          messages.push(newMessage);
        }
      }
    }

    // add the "(<name>)" postfix to each message
    for (const message of messages) {
      if (message.name) {
        message.excerpt += ' (' + message.name + ')';
      }
    }
    return messages;
  }

  messageEquals(m1, m2) {
    return m1.location.file === m2.location.file && m1.excerpt === m2.excerpt && m1.location.position.isEqual(m2.location.position);
  }

  buildCommand(gopath, cwd, sep = _path2.default.sep) {
    if (gopath.endsWith(sep)) {
      gopath = gopath.slice(0, -1);
    }
    const srcDir = gopath + sep + 'src';
    return srcDir.split(sep).every((t, i) => cwd.split(sep)[i] === t) ? 'install' // CWD is within gopath, `go install` to keep gocode up to date
    : 'build'; // CWD is outside gopath, `go build` will suffice
  }

  async lintInstall(cmd, options) {
    options.timeout = atom.config.get('go-plus.config.buildTimeout') || 10000;
    const command = this.buildCommand((0, _environment.getgopath)(), options.cwd || '');
    const buildArgs = [command];
    let outFile;
    if (command === 'build') {
      outFile = this.outFile();
      buildArgs.push('-o');
      buildArgs.push(outFile);
    }
    const additionalArgs = atom.config.get('go-plus.config.additionalBuildArgs');
    if (additionalArgs && additionalArgs.length) {
      const parsed = (0, _tokenizeArgString2.default)(additionalArgs);
      buildArgs.push(...parsed);
    }

    // Include the -i flag with go install.
    // See: https://github.com/mdempsky/gocode/issues/79
    if (command === 'install' && !buildArgs.includes('-i')) {
      buildArgs.push('-i');
    }

    buildArgs.push('.');
    this.output.update({
      output: 'Running go ' + buildArgs.join(' '),
      exitcode: 0
    });

    const r = await this.goconfig.executor.exec(cmd, buildArgs, options);
    const stdout = r.stdout instanceof Buffer ? r.stdout.toString() : r.stdout;
    if (stdout && stdout.trim() !== '') {
      console.log('go ' + command + ': (stdout) ' + stdout); // eslint-disable-line no-console
    }
    let stderr = (r.stderr instanceof Buffer ? r.stderr.toString() : r.stderr).trim();

    // cleanup any temp files
    if (outFile && outFile !== '/dev/null' && r.exitcode === 0) {
      _fsExtra2.default.remove(outFile);
    }

    let exitcode = r.exitcode;
    if (stderr.indexOf('no non-test Go files in') >= 0) {
      // pkgs may only contain go test files (e.g. integration tests)
      // ignore this error because the test builder reports the errors then.
      stderr = '';
      exitcode = 0;
    }
    return { output: stderr, linterName: 'build', exitcode };
  }

  outFile() {
    if (process.platform === 'win32') {
      return _temp2.default.path({ prefix: 'go-plus-test' });
    }
    return '/dev/null';
  }

  testCompileArgs(outFile, additionalArgs = '') {
    const result = ['test'];
    // use additional build args even when we compile the tests
    if (additionalArgs && additionalArgs.length) {
      const parsed = (0, _tokenizeArgString2.default)(additionalArgs);
      for (let i = 0; i < parsed.length; i++) {
        if (parsed[i] === '-o') {
          // we'll take care of this one, skip over the -o flag
          i++;
          continue;
        } else if (parsed[i] === '-c') {
          continue;
        } else {
          result.push(parsed[i]);
        }
      }
    }
    result.push('-c', '-o', outFile, '.');
    return result;
  }

  async lintTest(cmd, options) {
    const outFile = this.outFile();
    const additionalArgs = atom.config.get('go-plus.config.additionalTestArgs');
    const testArgs = this.testCompileArgs(outFile, additionalArgs);

    this.output.update({
      output: 'Compiling tests:' + _os2.default.EOL + '$ go ' + testArgs.join(' '),
      exitcode: 0
    });
    const r = await this.goconfig.executor.exec(cmd, testArgs, options);
    const stdout = r.stdout instanceof Buffer ? r.stdout.toString() : r.stdout;
    const stderr = r.stderr instanceof Buffer ? r.stderr.toString() : r.stderr;
    if (stdout && stdout.trim() !== '') {
      console.log('go test: (stdout) ' + stdout); // eslint-disable-line no-console
    }
    if (outFile && outFile !== '/dev/null' && r.exitcode === 0) {
      _fsExtra2.default.remove(outFile);
    }
    return { output: stderr.trim(), linterName: 'test', exitcode: r.exitcode };
  }

  mapMessages(data, cwd, linterName) {
    const pattern = /^((#)\s(.*)?)|((.*?):(\d*?):((\d*?):)?\s((.*)?((\n\t.*)+)?))/gim;
    const messages = [];
    let match;
    for (match = pattern.exec(data); match !== null; match = pattern.exec(data)) {
      const message = this.extractMessage(match, cwd, linterName);
      if (message) {
        messages.push(message);
      }
    }
    return messages;
  }

  extractMessage(line, cwd, linterName) {
    if (!line) {
      return;
    }
    if (line[2] && line[2] === '#') {
      // Found A Package Indicator, Skip For Now
      return;
    }
    let filePath = '';
    if (line[5] && line[5] !== '') {
      if (_path2.default.isAbsolute(line[5])) {
        filePath = line[5];
      } else {
        filePath = _path2.default.join(cwd, line[5]);
      }
    }
    const row = parseInt(line[6]);
    const column = parseInt(line[8]);
    const text = line[9];
    let range;
    if (column && column >= 0) {
      range = new _atom.Range([row - 1, column - 1], [row - 1, 1000]);
    } else {
      range = new _atom.Range([row - 1, 0], [row - 1, 1000]);
    }
    return {
      name: linterName,
      severity: 'error',
      location: { file: filePath, position: range },
      excerpt: text
    };
  }

  hasTests(p) {
    if (p.endsWith('_test.go')) {
      return true;
    }
    const files = _fsExtra2.default.readdirSync(_path2.default.dirname(p));
    return files.some(f => f.endsWith('_test.go'));
  }
}

exports.Builder = Builder;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJ1aWxkZXIuanMiXSwibmFtZXMiOlsiQnVpbGRlciIsImNvbnN0cnVjdG9yIiwiZ29jb25maWciLCJsaW50ZXIiLCJvdXRwdXQiLCJidXN5U2lnbmFsIiwic3Vic2NyaXB0aW9ucyIsIkNvbXBvc2l0ZURpc3Bvc2FibGUiLCJ0ZW1wIiwidHJhY2siLCJkaXNwb3NlIiwiZGlzcG9zZWQiLCJjbGVhbnVwU3luYyIsImVyciIsImNvbnNvbGUiLCJsb2ciLCJkZWxldGVNZXNzYWdlcyIsImNsZWFyTWVzc2FnZXMiLCJzZXRNZXNzYWdlcyIsIm1lc3NhZ2VzIiwibGVuZ3RoIiwic2V0QWxsTWVzc2FnZXMiLCJidWlsZCIsImVkaXRvciIsInBhdGgiLCJhdG9tIiwiY29uZmlnIiwiZ2V0IiwiRXJyb3IiLCJvcHRpb25zIiwiZXhlY3V0b3IiLCJnZXRPcHRpb25zIiwiY21kIiwibG9jYXRvciIsImZpbmRUb29sIiwiYnVpbGRQcm9taXNlIiwibGludEluc3RhbGwiLCJ0ZXN0UHJvbWlzZSIsImhhc1Rlc3RzIiwibGludFRlc3QiLCJQcm9taXNlIiwicmVzb2x2ZSIsImxpbnRlck5hbWUiLCJleGl0Y29kZSIsImFsbCIsImJzIiwicCIsInJlcG9ydEJ1c3lXaGlsZSIsInJlc3VsdHMiLCJnZXRNZXNzYWdlcyIsImN3ZCIsInJlc3VsdCIsInRpbWVvdXRNc2ciLCJ0aW1lb3V0IiwidXBkYXRlIiwiZGlyIiwicHJvcHMiLCJuZXdNZXNzYWdlcyIsIm1hcE1lc3NhZ2VzIiwibmV3TWVzc2FnZSIsInNvbWUiLCJtZXNzYWdlIiwibWVzc2FnZUVxdWFscyIsInB1c2giLCJuYW1lIiwiZXhjZXJwdCIsIm0xIiwibTIiLCJsb2NhdGlvbiIsImZpbGUiLCJwb3NpdGlvbiIsImlzRXF1YWwiLCJidWlsZENvbW1hbmQiLCJnb3BhdGgiLCJzZXAiLCJlbmRzV2l0aCIsInNsaWNlIiwic3JjRGlyIiwic3BsaXQiLCJldmVyeSIsInQiLCJpIiwiY29tbWFuZCIsImJ1aWxkQXJncyIsIm91dEZpbGUiLCJhZGRpdGlvbmFsQXJncyIsInBhcnNlZCIsImluY2x1ZGVzIiwiam9pbiIsInIiLCJleGVjIiwic3Rkb3V0IiwiQnVmZmVyIiwidG9TdHJpbmciLCJ0cmltIiwic3RkZXJyIiwiZnMiLCJyZW1vdmUiLCJpbmRleE9mIiwicHJvY2VzcyIsInBsYXRmb3JtIiwicHJlZml4IiwidGVzdENvbXBpbGVBcmdzIiwidGVzdEFyZ3MiLCJvcyIsIkVPTCIsImRhdGEiLCJwYXR0ZXJuIiwibWF0Y2giLCJleHRyYWN0TWVzc2FnZSIsImxpbmUiLCJmaWxlUGF0aCIsImlzQWJzb2x1dGUiLCJyb3ciLCJwYXJzZUludCIsImNvbHVtbiIsInRleHQiLCJyYW5nZSIsIlJhbmdlIiwic2V2ZXJpdHkiLCJmaWxlcyIsInJlYWRkaXJTeW5jIiwiZGlybmFtZSIsImYiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBT0EsTUFBTUEsT0FBTixDQUFjOztBQVFaQyxjQUNFQyxRQURGLEVBRUVDLE1BRkYsRUFHRUMsTUFIRixFQUlFQyxVQUpGLEVBS0U7QUFDQSxTQUFLSCxRQUFMLEdBQWdCQSxRQUFoQjtBQUNBLFNBQUtDLE1BQUwsR0FBY0EsTUFBZDtBQUNBLFNBQUtDLE1BQUwsR0FBY0EsTUFBZDtBQUNBLFNBQUtFLGFBQUwsR0FBcUIsSUFBSUMseUJBQUosRUFBckI7QUFDQSxTQUFLRixVQUFMLEdBQWtCQSxVQUFsQjs7QUFFQUcsbUJBQUtDLEtBQUw7QUFDRDs7QUFFREMsWUFBVTtBQUNSLFNBQUtDLFFBQUwsR0FBZ0IsSUFBaEI7QUFDQSxRQUFJLEtBQUtMLGFBQVQsRUFBd0I7QUFDdEIsV0FBS0EsYUFBTCxDQUFtQkksT0FBbkI7QUFDRDtBQUNELFFBQUk7QUFDRkYscUJBQUtJLFdBQUw7QUFDRCxLQUZELENBRUUsT0FBT0MsR0FBUCxFQUFZO0FBQ1o7QUFDQUMsY0FBUUMsR0FBUixDQUFZLGtCQUFaLEVB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SixLQUFLLENBQUwsQ0FBVCxDQUFmO0FBQ0EsVUFBTU0sT0FBT04sS0FBSyxDQUFMLENBQWI7QUFDQSxRQUFJTyxLQUFKO0FBQ0EsUUFBSUYsVUFBVUEsVUFBVSxDQUF4QixFQUEyQjtBQUN6QkUsY0FBUSxJQUFJQyxXQUFKLENBQVUsQ0FBQ0wsTUFBTSxDQUFQLEVBQVVFLFNBQVMsQ0FBbkIsQ0FBVixFQUFpQyxDQUFDRixNQUFNLENBQVAsRUFBVSxJQUFWLENBQWpDLENBQVI7QUFDRCxLQUZELE1BRU87QUFDTEksY0FBUSxJQUFJQyxXQUFKLENBQVUsQ0FBQ0wsTUFBTSxDQUFQLEVBQVUsQ0FBVixDQUFWLEVBQXdCLENBQUNBLE1BQU0sQ0FBUCxFQUFVLElBQVYsQ0FBeEIsQ0FBUjtBQUNEO0FBQ0QsV0FBTztBQUNMakQsWUFBTXRCLFVBREQ7QUFFTDZFLGdCQUFVLE9BRkw7QUFHTG5ELGdCQUFVLEVBQUVDLE1BQU0wQyxRQUFSLEVBQWtCekMsVUFBVStDLEtBQTVCLEVBSEw7QUFJTHBELGVBQVNtRDtBQUpKLEtBQVA7QUFNRDs7QUFFRDlFLFdBQVNRLENBQVQsRUFBNkI7QUFDM0IsUUFBSUEsRUFBRTZCLFFBQUYsQ0FBVyxVQUFYLENBQUosRUFBNEI7QUFDMUIsYUFBTyxJQUFQO0FBQ0Q7QUFDRCxVQUFNNkMsUUFBUXhCLGtCQUFHeUIsV0FBSCxDQUFlakcsZUFBS2tHLE9BQUwsQ0FBYTVFLENBQWIsQ0FBZixDQUFkO0FBQ0EsV0FBTzBFLE1BQU01RCxJQUFOLENBQVcrRCxLQUFLQSxFQUFFaEQsUUFBRixDQUFXLFVBQVgsQ0FBaEIsQ0FBUDtBQUNEO0FBblVXOztRQXNVTDNFLE8sR0FBQUEsTyIsImZpbGUiOiJidWlsZGVyLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL215dWdhLy5hdG9tL3BhY2thZ2VzL2dvLXBsdXMvbGliL2J1aWxkIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IGFyZ3BhcnNlciBmcm9tICd5YXJncy1wYXJzZXIvbGliL3Rva2VuaXplLWFyZy1zdHJpbmcnXG5pbXBvcnQgZnMgZnJvbSAnZnMtZXh0cmEnXG5pbXBvcnQgb3MgZnJvbSAnb3MnXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IHRlbXAgZnJvbSAnQGF0b20vdGVtcCdcbmltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IGlzVmFsaWRFZGl0b3IgfSBmcm9tICcuLy4uL3V0aWxzJ1xuaW1wb3J0IHsgZ2V0Z29wYXRoIH0gZnJvbSAnLi4vY29uZmlnL2Vudmlyb25tZW50J1xuXG5pbXBvcnQgdHlwZSB7IEdvQ29uZmlnIH0gZnJvbSAnLi8uLi9jb25maWcvc2VydmljZSdcbmltcG9ydCB0eXBlIHsgRXhlY3V0b3JPcHRpb25zIH0gZnJvbSAnLi8uLi9jb25maWcvZXhlY3V0b3InXG5pbXBvcnQgdHlwZSB7IExpbnRlckRlbGVnYXRlLCBMaW50ZXJWMk1lc3NhZ2UgfSBmcm9tICcuLy4uL2xpbnQvbGludGVyJ1xuaW1wb3J0IHR5cGUgeyBPdXRwdXRNYW5hZ2VyIH0gZnJvbSAnLi8uLi9vdXRwdXQtbWFuYWdlcidcblxuY2xhc3MgQnVpbGRlciB7XG4gIGdvY29uZmlnOiBHb0NvbmZpZ1xuICBzdWJzY3JpcHRpb25zOiBDb21wb3NpdGVEaXNwb3NhYmxlXG4gIGRpc3Bvc2VkOiBib29sZWFuXG4gIGxpbnRlcjogKCkgPT4gTGludGVyRGVsZWdhdGVcbiAgb3V0cHV0OiBPdXRwdXRNYW5hZ2VyXG4gIGJ1c3lTaWduYWw6ICgpID0+ID9CdXN5U2lnbmFsU2VydmljZVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGdvY29uZmlnOiBHb0NvbmZpZyxcbiAgICBsaW50ZXI6ICgpID0+IExpbnRlckRlbGVnYXRlLFxuICAgIG91dHB1dDogT3V0cHV0TWFuYWdlcixcbiAgICBidXN5U2lnbmFsOiAoKSA9PiA/QnVzeVNpZ25hbFNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5nb2NvbmZpZyA9IGdvY29uZmlnXG4gICAgdGhpcy5saW50ZXIgPSBsaW50ZXJcbiAgICB0aGlzLm91dHB1dCA9IG91dHB1dFxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgICB0aGlzLmJ1c3lTaWduYWwgPSBidXN5U2lnbmFsXG5cbiAgICB0ZW1wLnRyYWNrKClcbiAgfVxuXG4gIGRpc3Bvc2UoKSB7XG4gICAgdGhpcy5kaXNwb3NlZCA9IHRydWVcbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25zKSB7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZGlzcG9zZSgpXG4gICAgfVxuICAgIHRyeSB7XG4gICAgICB0ZW1wLmNsZWFudXBTeW5jKClcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXG4gICAgICBjb25zb2xlLmxvZygnYnVpbGRlciBjbGVhbnVwOicsIGVycilcbiAgICB9XG4gIH1cblxuICBkZWxldGVNZXNzYWdlcygpIHtcbiAgICBjb25zdCBsaW50ZXIgPSB0aGlzLmxpbnRlcigpXG4gICAgaWYgKGxpbnRlcikge1xuICAgICAgbGludGVyLmNsZWFyTWVzc2FnZXMoKVxuICAgIH1cbiAgfVxuXG4gIHNldE1lc3NhZ2VzKG1lc3NhZ2VzOiBBcnJheTxPYmplY3Q+KSB7XG4gICAgY29uc3QgbGludGVyID0gdGhpcy5saW50ZXIoKVxuICAgIGlmIChsaW50ZXIgJiYgbWVzc2FnZXMgJiYgbWVzc2FnZXMubGVuZ3RoKSB7XG4gICAgICBsaW50ZXIuc2V0QWxsTWVzc2FnZXMobWVzc2FnZXMpXG4gICAgfVxuICB9XG5cbiAgYXN5bmMgYnVpbGQoZWRpdG9yOiBUZXh0RWRpdG9yLCBwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIWF0b20uY29uZmlnLmdldCgnZ28tcGx1cy5jb25maWcuY29tcGlsZU9uU2F2ZScpKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgaWYgKCFpc1ZhbGlkRWRpdG9yKGVkaXRvcikpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBlZGl0b3InKVxuICAgIH1cbiAgICB0aGlzLmRlbGV0ZU1lc3NhZ2VzKClcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5nb2NvbmZpZy5leGVjdXRvci5nZXRPcHRpb25zKCdmaWxlJywgZWRpdG9yKVxuICAgIGNvbnN0IGNtZCA9IGF3YWl0IHRoaXMuZ29jb25maWcubG9jYXRvci5maW5kVG9vbCgnZ28nKVxuICAgIGlmICghY21kKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2Nhbm5vdCBmaW5kIGdvIHRvb2wnKVxuICAgIH1cbiAgICBjb25zdCBidWlsZFByb21pc2UgPSB0aGlzLmxpbnRJbnN0YWxsKGNtZCwgb3B0aW9ucylcbiAgICBjb25zdCB0ZXN0UHJvbWlzZSA9IHRoaXMuaGFzVGVzdHMocGF0aClcbiAgICAgID8gdGhpcy5saW50VGVzdChjbWQsIG9wdGlvbnMpXG4gICAgICA6IFByb21pc2UucmVzb2x2ZSh7IG91dHB1dDogJycsIGxpbnRlck5hbWU6ICd0ZXN0JywgZXhpdGNvZGU6IDAgfSlcblxuICAgIGNvbnN0IGFsbCA9IFByb21pc2UuYWxsKFtidWlsZFByb21pc2UsIHRlc3RQcm9taXNlXSlcbiAgICBjb25zdCBicyA9IHRoaXMuYnVzeVNpZ25hbCgpXG4gICAgY29uc3QgcCA9IGJzID8gYnMucmVwb3J0QnVzeVdoaWxlKCdCdWlsZGluZyBHbycsICgpID0+IGFsbCkgOiBhbGxcbiAgICBjb25zdCByZXN1bHRzID0gYXdhaXQgcFxuICAgIGlmICghcmVzdWx0cyB8fCByZXN1bHRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIHRoaXMuc2V0TWVzc2FnZXModGhpcy5nZXRNZXNzYWdlcyhyZXN1bHRzLCBvcHRpb25zLmN3ZCB8fCAnJykpXG5cbiAgICAvLyBjaGVjayBmb3IgYW55IG5vbi16ZXJvIGV4aXQgY29kZXMgYW5kIGVycm9yIGlmIGZvdW5kXG4gICAgZm9yIChjb25zdCByZXN1bHQgb2YgcmVzdWx0cykge1xuICAgICAgaWYgKHJlc3VsdC5leGl0Y29kZSAhPT0gMCkge1xuICAgICAgICBpZiAodGhpcy5vdXRwdXQpIHtcbiAgICAgICAgICBpZiAocmVzdWx0LmV4aXRjb2RlID09PSAxMjQpIHtcbiAgICAgICAgICAgIGxldCB0aW1lb3V0TXNnID0gYCR7cmVzdWx0LmxpbnRlck5hbWV9IHRpbWVkIG91dGBcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnRpbWVvdXQpIHtcbiAgICAgICAgICAgICAgdGltZW91dE1zZyArPSBgIGFmdGVyICR7b3B0aW9ucy50aW1lb3V0fSBtc2BcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMub3V0cHV0LnVwZGF0ZSh7XG4gICAgICAgICAgICAgIGV4aXRjb2RlOiByZXN1bHQuZXhpdGNvZGUsXG4gICAgICAgICAgICAgIG91dHB1dDogdGltZW91dE1zZyxcbiAgICAgICAgICAgICAgZGlyOiBvcHRpb25zLmN3ZFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5vdXRwdXQudXBkYXRlKHtcbiAgICAgICAgICAgICAgZXhpdGNvZGU6IHJlc3VsdC5leGl0Y29kZSxcbiAgICAgICAgICAgICAgb3V0cHV0OiByZXN1bHQub3V0cHV0LFxuICAgICAgICAgICAgICBkaXI6IG9wdGlvbnMuY3dkXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IocmVzdWx0Lm91dHB1dClcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gaW5kaWNhdGUgdGhhdCB3ZSdyZSBkb25lLCB3aGljaCBpcyBlc3BlY2lhbGx5IGltcG9ydGFudCB3aGVuIHRlc3Qgb24gc2F2ZSBpcyBkaXNhYmxlZFxuICAgIC8vICh3ZSBkb24ndCB3YW50IHRvIGdpdmUgdGhlIGFwcGVhcmFuY2UgdGhhdCB3ZSdyZSBjb21waWxpbmcgaW5kZWZpbml0ZWx5KVxuICAgIGlmICh0aGlzLm91dHB1dCkge1xuICAgICAgdGhpcy5vdXRwdXQudXBkYXRlKHtcbiAgICAgICAgb3V0cHV0OiB0aGlzLm91dHB1dC5wcm9wcy5vdXRwdXQgKyAnXFxuXFxuRG9uZSdcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgZ2V0TWVzc2FnZXMoXG4gICAgcmVzdWx0czogQXJyYXk8eyBvdXRwdXQ6IHN0cmluZywgbGludGVyTmFtZTogc3RyaW5nIH0+LFxuICAgIGN3ZDogc3RyaW5nXG4gICk6IEFycmF5PExpbnRlclYyTWVzc2FnZT4ge1xuICAgIGxldCBtZXNzYWdlczogQXJyYXk8TGludGVyVjJNZXNzYWdlPiA9IFtdXG4gICAgZm9yIChjb25zdCB7IG91dHB1dCwgbGludGVyTmFtZSB9IG9mIHJlc3VsdHMpIHtcbiAgICAgIGNvbnN0IG5ld01lc3NhZ2VzID0gdGhpcy5tYXBNZXNzYWdlcyhvdXRwdXQsIGN3ZCwgbGludGVyTmFtZSlcbiAgICAgIGZvciAoY29uc3QgbmV3TWVzc2FnZSBvZiBuZXdNZXNzYWdlcykge1xuICAgICAgICBpZiAoXG4gICAgICAgICAgIW1lc3NhZ2VzLnNvbWUobWVzc2FnZSA9PiB0aGlzLm1lc3NhZ2VFcXVhbHMobmV3TWVzc2FnZSwgbWVzc2FnZSkpXG4gICAgICAgICkge1xuICAgICAgICAgIG1lc3NhZ2VzLnB1c2gobmV3TWVzc2FnZSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGFkZCB0aGUgXCIoPG5hbWU+KVwiIHBvc3RmaXggdG8gZWFjaCBtZXNzYWdlXG4gICAgZm9yIChjb25zdCBtZXNzYWdlIG9mIG1lc3NhZ2VzKSB7XG4gICAgICBpZiAobWVzc2FnZS5uYW1lKSB7XG4gICAgICAgIG1lc3NhZ2UuZXhjZXJwdCArPSAnICgnICsgbWVzc2FnZS5uYW1lICsgJyknXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBtZXNzYWdlc1xuICB9XG5cbiAgbWVzc2FnZUVxdWFscyhtMTogTGludGVyVjJNZXNzYWdlLCBtMjogTGludGVyVjJNZXNzYWdlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIChcbiAgICAgIG0xLmxvY2F0aW9uLmZpbGUgPT09IG0yLmxvY2F0aW9uLmZpbGUgJiZcbiAgICAgIG0xLmV4Y2VycHQgPT09IG0yLmV4Y2VycHQgJiZcbiAgICAgIG0xLmxvY2F0aW9uLnBvc2l0aW9uLmlzRXF1YWwobTIubG9jYXRpb24ucG9zaXRpb24pXG4gICAgKVxuICB9XG5cbiAgYnVpbGRDb21tYW5kKGdvcGF0aDogc3RyaW5nLCBjd2Q6IHN0cmluZywgc2VwOiBzdHJpbmcgPSBwYXRoLnNlcCk6IHN0cmluZyB7XG4gICAgaWYgKGdvcGF0aC5lbmRzV2l0aChzZXApKSB7XG4gICAgICBnb3BhdGggPSBnb3BhdGguc2xpY2UoMCwgLTEpXG4gICAgfVxuICAgIGNvbnN0IHNyY0RpciA9IGdvcGF0aCArIHNlcCArICdzcmMnXG4gICAgcmV0dXJuIHNyY0Rpci5zcGxpdChzZXApLmV2ZXJ5KCh0LCBpKSA9PiBjd2Quc3BsaXQoc2VwKVtpXSA9PT0gdClcbiAgICAgID8gJ2luc3RhbGwnIC8vIENXRCBpcyB3aXRoaW4gZ29wYXRoLCBgZ28gaW5zdGFsbGAgdG8ga2VlcCBnb2NvZGUgdXAgdG8gZGF0ZVxuICAgICAgOiAnYnVpbGQnIC8vIENXRCBpcyBvdXRzaWRlIGdvcGF0aCwgYGdvIGJ1aWxkYCB3aWxsIHN1ZmZpY2VcbiAgfVxuXG4gIGFzeW5jIGxpbnRJbnN0YWxsKGNtZDogc3RyaW5nLCBvcHRpb25zOiBFeGVjdXRvck9wdGlvbnMpIHtcbiAgICBvcHRpb25zLnRpbWVvdXQgPVxuICAgICAgKGF0b20uY29uZmlnLmdldCgnZ28tcGx1cy5jb25maWcuYnVpbGRUaW1lb3V0Jyk6IGFueSkgfHwgMTAwMDBcbiAgICBjb25zdCBjb21tYW5kID0gdGhpcy5idWlsZENvbW1hbmQoZ2V0Z29wYXRoKCksIG9wdGlvbnMuY3dkIHx8ICcnKVxuICAgIGNvbnN0IGJ1aWxkQXJncyA9IFtjb21tYW5kXVxuICAgIGxldCBvdXRGaWxlXG4gICAgaWYgKGNvbW1hbmQgPT09ICdidWlsZCcpIHtcbiAgICAgIG91dEZpbGUgPSB0aGlzLm91dEZpbGUoKVxuICAgICAgYnVpbGRBcmdzLnB1c2goJy1vJylcbiAgICAgIGJ1aWxkQXJncy5wdXNoKG91dEZpbGUpXG4gICAgfVxuICAgIGNvbnN0IGFkZGl0aW9uYWxBcmdzID0gYXRvbS5jb25maWcuZ2V0KCdnby1wbHVzLmNvbmZpZy5hZGRpdGlvbmFsQnVpbGRBcmdzJylcbiAgICBpZiAoYWRkaXRpb25hbEFyZ3MgJiYgYWRkaXRpb25hbEFyZ3MubGVuZ3RoKSB7XG4gICAgICBjb25zdCBwYXJzZWQgPSBhcmdwYXJzZXIoYWRkaXRpb25hbEFyZ3MpXG4gICAgICBidWlsZEFyZ3MucHVzaCguLi5wYXJzZWQpXG4gICAgfVxuXG4gICAgLy8gSW5jbHVkZSB0aGUgLWkgZmxhZyB3aXRoIGdvIGluc3RhbGwuXG4gICAgLy8gU2VlOiBodHRwczovL2dpdGh1Yi5jb20vbWRlbXBza3kvZ29jb2RlL2lzc3Vlcy83OVxuICAgIGlmIChjb21tYW5kID09PSAnaW5zdGFsbCcgJiYgIWJ1aWxkQXJncy5pbmNsdWRlcygnLWknKSkge1xuICAgICAgYnVpbGRBcmdzLnB1c2goJy1pJylcbiAgICB9XG5cbiAgICBidWlsZEFyZ3MucHVzaCgnLicpXG4gICAgdGhpcy5vdXRwdXQudXBkYXRlKHtcbiAgICAgIG91dHB1dDogJ1J1bm5pbmcgZ28gJyArIGJ1aWxkQXJncy5qb2luKCcgJyksXG4gICAgICBleGl0Y29kZTogMFxuICAgIH0pXG5cbiAgICBjb25zdCByID0gYXdhaXQgdGhpcy5nb2NvbmZpZy5leGVjdXRvci5leGVjKGNtZCwgYnVpbGRBcmdzLCBvcHRpb25zKVxuICAgIGNvbnN0IHN0ZG91dCA9IHIuc3Rkb3V0IGluc3RhbmNlb2YgQnVmZmVyID8gci5zdGRvdXQudG9TdHJpbmcoKSA6IHIuc3Rkb3V0XG4gICAgaWYgKHN0ZG91dCAmJiBzdGRvdXQudHJpbSgpICE9PSAnJykge1xuICAgICAgY29uc29sZS5sb2coJ2dvICcgKyBjb21tYW5kICsgJzogKHN0ZG91dCkgJyArIHN0ZG91dCkgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb25zb2xlXG4gICAgfVxuICAgIGxldCBzdGRlcnIgPSAoci5zdGRlcnIgaW5zdGFuY2VvZiBCdWZmZXJcbiAgICAgID8gci5zdGRlcnIudG9TdHJpbmcoKVxuICAgICAgOiByLnN0ZGVyclxuICAgICkudHJpbSgpXG5cbiAgICAvLyBjbGVhbnVwIGFueSB0ZW1wIGZpbGVzXG4gICAgaWYgKG91dEZpbGUgJiYgb3V0RmlsZSAhPT0gJy9kZXYvbnVsbCcgJiYgci5leGl0Y29kZSA9PT0gMCkge1xuICAgICAgZnMucmVtb3ZlKG91dEZpbGUpXG4gICAgfVxuXG4gICAgbGV0IGV4aXRjb2RlID0gci5leGl0Y29kZVxuICAgIGlmIChzdGRlcnIuaW5kZXhPZignbm8gbm9uLXRlc3QgR28gZmlsZXMgaW4nKSA+PSAwKSB7XG4gICAgICAvLyBwa2dzIG1heSBvbmx5IGNvbnRhaW4gZ28gdGVzdCBmaWxlcyAoZS5nLiBpbnRlZ3JhdGlvbiB0ZXN0cylcbiAgICAgIC8vIGlnbm9yZSB0aGlzIGVycm9yIGJlY2F1c2UgdGhlIHRlc3QgYnVpbGRlciByZXBvcnRzIHRoZSBlcnJvcnMgdGhlbi5cbiAgICAgIHN0ZGVyciA9ICcnXG4gICAgICBleGl0Y29kZSA9IDBcbiAgICB9XG4gICAgcmV0dXJuIHsgb3V0cHV0OiBzdGRlcnIsIGxpbnRlck5hbWU6ICdidWlsZCcsIGV4aXRjb2RlIH1cbiAgfVxuXG4gIG91dEZpbGUoKTogc3RyaW5nIHtcbiAgICBpZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJykge1xuICAgICAgcmV0dXJuIHRlbXAucGF0aCh7IHByZWZpeDogJ2dvLXBsdXMtdGVzdCcgfSlcbiAgICB9XG4gICAgcmV0dXJuICcvZGV2L251bGwnXG4gIH1cblxuICB0ZXN0Q29tcGlsZUFyZ3Mob3V0RmlsZTogc3RyaW5nLCBhZGRpdGlvbmFsQXJnczogc3RyaW5nID0gJycpOiBBcnJheTxzdHJpbmc+IHtcbiAgICBjb25zdCByZXN1bHQgPSBbJ3Rlc3QnXVxuICAgIC8vIHVzZSBhZGRpdGlvbmFsIGJ1aWxkIGFyZ3MgZXZlbiB3aGVuIHdlIGNvbXBpbGUgdGhlIHRlc3RzXG4gICAgaWYgKGFkZGl0aW9uYWxBcmdzICYmIGFkZGl0aW9uYWxBcmdzLmxlbmd0aCkge1xuICAgICAgY29uc3QgcGFyc2VkID0gYXJncGFyc2VyKGFkZGl0aW9uYWxBcmdzKVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJzZWQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKHBhcnNlZFtpXSA9PT0gJy1vJykge1xuICAgICAgICAgIC8vIHdlJ2xsIHRha2UgY2FyZSBvZiB0aGlzIG9uZSwgc2tpcCBvdmVyIHRoZSAtbyBmbGFnXG4gICAgICAgICAgaSsrXG4gICAgICAgICAgY29udGludWVcbiAgICAgICAgfSBlbHNlIGlmIChwYXJzZWRbaV0gPT09ICctYycpIHtcbiAgICAgICAgICBjb250aW51ZVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3VsdC5wdXNoKHBhcnNlZFtpXSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXN1bHQucHVzaCgnLWMnLCAnLW8nLCBvdXRGaWxlLCAnLicpXG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgYXN5bmMgbGludFRlc3QoY21kOiBzdHJpbmcsIG9wdGlvbnM6IEV4ZWN1dG9yT3B0aW9ucykge1xuICAgIGNvbnN0IG91dEZpbGUgPSB0aGlzLm91dEZpbGUoKVxuICAgIGNvbnN0IGFkZGl0aW9uYWxBcmdzID0gKGF0b20uY29uZmlnLmdldChcbiAgICAgICdnby1wbHVzLmNvbmZpZy5hZGRpdGlvbmFsVGVzdEFyZ3MnXG4gICAgKTogYW55KVxuICAgIGNvbnN0IHRlc3RBcmdzID0gdGhpcy50ZXN0Q29tcGlsZUFyZ3Mob3V0RmlsZSwgYWRkaXRpb25hbEFyZ3MpXG5cbiAgICB0aGlzLm91dHB1dC51cGRhdGUoe1xuICAgICAgb3V0cHV0OiAnQ29tcGlsaW5nIHRlc3RzOicgKyBvcy5FT0wgKyAnJCBnbyAnICsgdGVzdEFyZ3Muam9pbignICcpLFxuICAgICAgZXhpdGNvZGU6IDBcbiAgICB9KVxuICAgIGNvbnN0IHIgPSBhd2FpdCB0aGlzLmdvY29uZmlnLmV4ZWN1dG9yLmV4ZWMoY21kLCB0ZXN0QXJncywgb3B0aW9ucylcbiAgICBjb25zdCBzdGRvdXQgPSByLnN0ZG91dCBpbnN0YW5jZW9mIEJ1ZmZlciA/IHIuc3Rkb3V0LnRvU3RyaW5nKCkgOiByLnN0ZG91dFxuICAgIGNvbnN0IHN0ZGVyciA9IHIuc3RkZXJyIGluc3RhbmNlb2YgQnVmZmVyID8gci5zdGRlcnIudG9TdHJpbmcoKSA6IHIuc3RkZXJyXG4gICAgaWYgKHN0ZG91dCAmJiBzdGRvdXQudHJpbSgpICE9PSAnJykge1xuICAgICAgY29uc29sZS5sb2coJ2dvIHRlc3Q6IChzdGRvdXQpICcgKyBzdGRvdXQpIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuICAgIH1cbiAgICBpZiAob3V0RmlsZSAmJiBvdXRGaWxlICE9PSAnL2Rldi9udWxsJyAmJiByLmV4aXRjb2RlID09PSAwKSB7XG4gICAgICBmcy5yZW1vdmUob3V0RmlsZSlcbiAgICB9XG4gICAgcmV0dXJuIHsgb3V0cHV0OiBzdGRlcnIudHJpbSgpLCBsaW50ZXJOYW1lOiAndGVzdCcsIGV4aXRjb2RlOiByLmV4aXRjb2RlIH1cbiAgfVxuXG4gIG1hcE1lc3NhZ2VzKFxuICAgIGRhdGE6IHN0cmluZyxcbiAgICBjd2Q6IHN0cmluZyxcbiAgICBsaW50ZXJOYW1lOiBzdHJpbmdcbiAgKTogQXJyYXk8TGludGVyVjJNZXNzYWdlPiB7XG4gICAgY29uc3QgcGF0dGVybiA9IC9eKCgjKVxccyguKik/KXwoKC4qPyk6KFxcZCo/KTooKFxcZCo/KTopP1xccygoLiopPygoXFxuXFx0LiopKyk/KSkvZ2ltXG4gICAgY29uc3QgbWVzc2FnZXMgPSBbXVxuICAgIGxldCBtYXRjaFxuICAgIGZvciAoXG4gICAgICBtYXRjaCA9IHBhdHRlcm4uZXhlYyhkYXRhKTtcbiAgICAgIG1hdGNoICE9PSBudWxsO1xuICAgICAgbWF0Y2ggPSBwYXR0ZXJuLmV4ZWMoZGF0YSlcbiAgICApIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLmV4dHJhY3RNZXNzYWdlKG1hdGNoLCBjd2QsIGxpbnRlck5hbWUpXG4gICAgICBpZiAobWVzc2FnZSkge1xuICAgICAgICBtZXNzYWdlcy5wdXNoKG1lc3NhZ2UpXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBtZXNzYWdlc1xuICB9XG5cbiAgZXh0cmFjdE1lc3NhZ2UoXG4gICAgbGluZTogQXJyYXk8c3RyaW5nPixcbiAgICBjd2Q6IHN0cmluZyxcbiAgICBsaW50ZXJOYW1lOiBzdHJpbmdcbiAgKTogP0xpbnRlclYyTWVzc2FnZSB7XG4gICAgaWYgKCFsaW5lKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgaWYgKGxpbmVbMl0gJiYgbGluZVsyXSA9PT0gJyMnKSB7XG4gICAgICAvLyBGb3VuZCBBIFBhY2thZ2UgSW5kaWNhdG9yLCBTa2lwIEZvciBOb3dcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBsZXQgZmlsZVBhdGggPSAnJ1xuICAgIGlmIChsaW5lWzVdICYmIGxpbmVbNV0gIT09ICcnKSB7XG4gICAgICBpZiAocGF0aC5pc0Fic29sdXRlKGxpbmVbNV0pKSB7XG4gICAgICAgIGZpbGVQYXRoID0gbGluZVs1XVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmlsZVBhdGggPSBwYXRoLmpvaW4oY3dkLCBsaW5lWzVdKVxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCByb3cgPSBwYXJzZUludChsaW5lWzZdKVxuICAgIGNvbnN0IGNvbHVtbiA9IHBhcnNlSW50KGxpbmVbOF0pXG4gICAgY29uc3QgdGV4dCA9IGxpbmVbOV1cbiAgICBsZXQgcmFuZ2VcbiAgICBpZiAoY29sdW1uICYmIGNvbHVtbiA+PSAwKSB7XG4gICAgICByYW5nZSA9IG5ldyBSYW5nZShbcm93IC0gMSwgY29sdW1uIC0gMV0sIFtyb3cgLSAxLCAxMDAwXSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmFuZ2UgPSBuZXcgUmFuZ2UoW3JvdyAtIDEsIDBdLCBbcm93IC0gMSwgMTAwMF0pXG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiBsaW50ZXJOYW1lLFxuICAgICAgc2V2ZXJpdHk6ICdlcnJvcicsXG4gICAgICBsb2NhdGlvbjogeyBmaWxlOiBmaWxlUGF0aCwgcG9zaXRpb246IHJhbmdlIH0sXG4gICAgICBleGNlcnB0OiB0ZXh0XG4gICAgfVxuICB9XG5cbiAgaGFzVGVzdHMocDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKHAuZW5kc1dpdGgoJ190ZXN0LmdvJykpIHtcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIGNvbnN0IGZpbGVzID0gZnMucmVhZGRpclN5bmMocGF0aC5kaXJuYW1lKHApKVxuICAgIHJldHVybiBmaWxlcy5zb21lKGYgPT4gZi5lbmRzV2l0aCgnX3Rlc3QuZ28nKSlcbiAgfVxufVxuXG5leHBvcnQgeyBCdWlsZGVyIH1cbiJdfQ==