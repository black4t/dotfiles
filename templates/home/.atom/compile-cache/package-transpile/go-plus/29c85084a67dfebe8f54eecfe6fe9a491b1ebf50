Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.stat = exports.parseGoPosition = exports.getCursorPosition = exports.currentCursorOffset = exports.wordAndOffset = exports.utf8OffsetForBufferPosition = exports.getWordPosition = exports.openFile = exports.projectPath = exports.getEditor = exports.isValidEditor = undefined;

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const isValidEditor = e => {
  return !!e && hasGoGrammar(e.getGrammar());
};

const hasGoGrammar = g => {
  return !!g && (g.scopeName === 'source.go' || g.scopeName === 'go');
};

const getEditor = () => {
  if (!atom || !atom.workspace) {
    return;
  }
  const editor = atom.workspace.getActiveTextEditor();
  if (!isValidEditor(editor)) {
    return;
  }

  return editor;
};

const getWordPosition = (editor = getEditor()) => {
  if (!editor) {
    return undefined;
  }

  const cursor = editor.getLastCursor();
  const buffer = editor.getBuffer();

  if (!cursor || !buffer) {
    return undefined;
  }

  let wordPosition = cursor.getCurrentWordBufferRange();
  let start = buffer.characterIndexForPosition(wordPosition.start);
  let end = buffer.characterIndexForPosition(wordPosition.end);
  return [start, end];
};

const getCursorPosition = editor => {
  if (!editor) {
    return undefined;
  }
  const cursor = editor.getLastCursor();
  if (!cursor) {
    return undefined;
  }
  return cursor.getBufferPosition();
};

const currentCursorOffset = editor => {
  if (!editor) {
    return undefined;
  }

  const pos = getCursorPosition(editor);
  if (!pos) {
    return undefined;
  }

  return utf8OffsetForBufferPosition(pos, editor);
};

const utf8OffsetForBufferPosition = (pos, editor) => {
  if (!editor || !editor.getBuffer() || !pos) {
    return -1;
  }
  const characterOffset = editor.getBuffer().characterIndexForPosition(pos);
  const text = editor.getText().substring(0, characterOffset);
  return Buffer.byteLength(text, 'utf8');
};

const wordAndOffset = editor => {
  const cursor = editor.getLastCursor();
  const range = cursor.getCurrentWordBufferRange();
  const middle = new _atom.Point(range.start.row, Math.floor((range.start.column + range.end.column) / 2));
  const charOffset = editor.getBuffer().characterIndexForPosition(middle);
  const text = editor.getText().substring(0, charOffset);
  return {
    word: editor.getTextInBufferRange(range),
    offset: Buffer.byteLength(text, 'utf8')
  };
};

/**
 * Opens the `file` and centers the editor around the `pos`
 * @param  {string} file  Path to the file to open.
 * @param  {object} [pos] An optional object containing `row` and `column` to scroll to.
 * @return {Promise} Returns a promise which resolves with the opened editor
 */
const openFile = async (file, pos) => {
  await new Promise((resolve, reject) => {
    _fs2.default.access(file, _fs2.default.constants.F_OK | _fs2.default.constants.R_OK, err => {
      if (err) {
        reject(err);
        return;
      }
      resolve();
    });
  });
  // searchAllPanes avoids opening a file in another split pane if it is already open in one
  const options = {};
  options.searchAllPanes = true;
  if (pos && pos.row) {
    options.initialLine = pos.row;
  }
  if (pos && pos.column) {
    options.initialColumn = pos.column;
  }
  const editor = await atom.workspace.open(file, options);
  if (pos) {
    editor.scrollToBufferPosition(pos, { center: true });
  }
  return editor;
};

const stat = loc => {
  return new Promise((resolve, reject) => {
    _fs2.default.stat(loc, (err, stats) => {
      if (err) {
        reject(err);
      }
      resolve(stats);
    });
  });
};

const projectPath = () => {
  const dirs = atom.project.getDirectories().filter(dir => !dir.getPath().includes('://'));
  if (dirs && dirs.length > 0) {
    return dirs[0].getPath();
  }
  return undefined;
};

const parseGoPosition = identifier => {
  if (!identifier.includes(':')) {
    return { file: identifier };
  }

  const windows = identifier[1] === ':';
  const offset = windows ? 1 : 0;

  const components = identifier.trim().split(':');
  const hasLine = components.length >= 2 + offset;
  const hasColumn = components.length > 2 + offset;

  const column = hasColumn ? parseInt(components.pop(), 10) : undefined;
  const line = hasLine ? parseInt(components.pop(), 10) : undefined;
  const file = components.join(':');

  return { file, line, column };
};

exports.isValidEditor = isValidEditor;
exports.getEditor = getEditor;
exports.projectPath = projectPath;
exports.openFile = openFile;
exports.getWordPosition = getWordPosition;
exports.utf8OffsetForBufferPosition = utf8OffsetForBufferPosition;
exports.wordAndOffset = wordAndOffset;
exports.currentCursorOffset = currentCursorOffset;
exports.getCursorPosition = getCursorPosition;
exports.parseGoPosition = parseGoPosition;
exports.stat = stat;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzLmpzIl0sIm5hbWVzIjpbImlzVmFsaWRFZGl0b3IiLCJlIiwiaGFzR29HcmFtbWFyIiwiZ2V0R3JhbW1hciIsImciLCJzY29wZU5hbWUiLCJnZXRFZGl0b3IiLCJhdG9tIiwid29ya3NwYWNlIiwiZWRpdG9yIiwiZ2V0QWN0aXZlVGV4dEVkaXRvciIsImdldFdvcmRQb3NpdGlvbiIsInVuZGVmaW5lZCIsImN1cnNvciIsImdldExhc3RDdXJzb3IiLCJidWZmZXIiLCJnZXRCdWZmZXIiLCJ3b3JkUG9zaXRpb24iLCJnZXRDdXJyZW50V29yZEJ1ZmZlclJhbmdlIiwic3RhcnQiLCJjaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uIiwiZW5kIiwiZ2V0Q3Vyc29yUG9zaXRpb24iLCJnZXRCdWZmZXJQb3NpdGlvbiIsImN1cnJlbnRDdXJzb3JPZmZzZXQiLCJwb3MiLCJ1dGY4T2Zmc2V0Rm9yQnVmZmVyUG9zaXRpb24iLCJjaGFyYWN0ZXJPZmZzZXQiLCJ0ZXh0IiwiZ2V0VGV4dCIsInN1YnN0cmluZyIsIkJ1ZmZlciIsImJ5dGVMZW5ndGgiLCJ3b3JkQW5kT2Zmc2V0IiwicmFuZ2UiLCJtaWRkbGUiLCJQb2ludCIsInJvdyIsIk1hdGgiLCJmbG9vciIsImNvbHVtbiIsImNoYXJPZmZzZXQiLCJ3b3JkIiwiZ2V0VGV4dEluQnVmZmVyUmFuZ2UiLCJvZmZzZXQiLCJvcGVuRmlsZSIsImZpbGUiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImZzIiwiYWNjZXNzIiwiY29uc3RhbnRzIiwiRl9PSyIsIlJfT0siLCJlcnIiLCJvcHRpb25zIiwic2VhcmNoQWxsUGFuZXMiLCJpbml0aWFsTGluZSIsImluaXRpYWxDb2x1bW4iLCJvcGVuIiwic2Nyb2xsVG9CdWZmZXJQb3NpdGlvbiIsImNlbnRlciIsInN0YXQiLCJsb2MiLCJzdGF0cyIsInByb2plY3RQYXRoIiwiZGlycyIsInByb2plY3QiLCJnZXREaXJlY3RvcmllcyIsImZpbHRlciIsImRpciIsImdldFBhdGgiLCJpbmNsdWRlcyIsImxlbmd0aCIsInBhcnNlR29Qb3NpdGlvbiIsImlkZW50aWZpZXIiLCJ3aW5kb3dzIiwiY29tcG9uZW50cyIsInRyaW0iLCJzcGxpdCIsImhhc0xpbmUiLCJoYXNDb2x1bW4iLCJwYXJzZUludCIsInBvcCIsImxpbmUiLCJqb2luIl0sIm1hcHBpbmdzIjoiOzs7OztBQUVBOzs7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxnQkFBaUJDLENBQUQsSUFBcUM7QUFDekQsU0FBTyxDQUFDLENBQUNBLENBQUYsSUFBT0MsYUFBYUQsRUFBRUUsVUFBRixFQUFiLENBQWQ7QUFDRCxDQUZEOztBQUlBLE1BQU1ELGVBQWdCRSxDQUFELElBQXVDO0FBQzFELFNBQU8sQ0FBQyxDQUFDQSxDQUFGLEtBQVFBLEVBQUVDLFNBQUYsS0FBZ0IsV0FBaEIsSUFBK0JELEVBQUVDLFNBQUYsS0FBZ0IsSUFBdkQsQ0FBUDtBQUNELENBRkQ7O0FBSUEsTUFBTUMsWUFBWSxNQUFtQjtBQUNuQyxNQUFJLENBQUNDLElBQUQsSUFBUyxDQUFDQSxLQUFLQyxTQUFuQixFQUE4QjtBQUM1QjtBQUNEO0FBQ0QsUUFBTUMsU0FBU0YsS0FBS0MsU0FBTCxDQUFlRSxtQkFBZixFQUFmO0FBQ0EsTUFBSSxDQUFDVixjQUFjUyxNQUFkLENBQUwsRUFBNEI7QUFDMUI7QUFDRDs7QUFFRCxTQUFPQSxNQUFQO0FBQ0QsQ0FWRDs7QUFZQSxNQUFNRSxrQkFBa0IsQ0FDdEJGLFNBQXNCSCxXQURBLEtBRUY7QUFDcEIsTUFBSSxDQUFDRyxNQUFMLEVBQWE7QUFDWCxXQUFPRyxTQUFQO0FBQ0Q7O0FBRUQsUUFBTUMsU0FBU0osT0FBT0ssYUFBUCxFQUFmO0FBQ0EsUUFBTUMsU0FBU04sT0FBT08sU0FBUCxFQUFmOztBQUVBLE1BQUksQ0FBQ0gsTUFBRCxJQUFXLENBQUNFLE1BQWhCLEVBQXdCO0FBQ3RCLFdBQU9ILFNBQVA7QUFDRDs7QUFFRCxNQUFJSyxlQUFlSixPQUFPSyx5QkFBUCxFQUFuQjtBQUNBLE1BQUlDLFFBQVFKLE9B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LEVBQStCO0FBQzdCLFdBQU8sRUFBRTNCLE1BQU04QixVQUFSLEVBQVA7QUFDRDs7QUFFRCxRQUFNQyxVQUFVRCxXQUFXLENBQVgsTUFBa0IsR0FBbEM7QUFDQSxRQUFNaEMsU0FBU2lDLFVBQVUsQ0FBVixHQUFjLENBQTdCOztBQUVBLFFBQU1DLGFBQWFGLFdBQVdHLElBQVgsR0FBa0JDLEtBQWxCLENBQXdCLEdBQXhCLENBQW5CO0FBQ0EsUUFBTUMsVUFBVUgsV0FBV0osTUFBWCxJQUFxQixJQUFJOUIsTUFBekM7QUFDQSxRQUFNc0MsWUFBWUosV0FBV0osTUFBWCxHQUFvQixJQUFJOUIsTUFBMUM7O0FBRUEsUUFBTUosU0FBUzBDLFlBQVlDLFNBQVNMLFdBQVdNLEdBQVgsRUFBVCxFQUEyQixFQUEzQixDQUFaLEdBQTZDeEUsU0FBNUQ7QUFDQSxRQUFNeUUsT0FBT0osVUFBVUUsU0FBU0wsV0FBV00sR0FBWCxFQUFULEVBQTJCLEVBQTNCLENBQVYsR0FBMkN4RSxTQUF4RDtBQUNBLFFBQU1rQyxPQUFPZ0MsV0FBV1EsSUFBWCxDQUFnQixHQUFoQixDQUFiOztBQUVBLFNBQU8sRUFBRXhDLElBQUYsRUFBUXVDLElBQVIsRUFBYzdDLE1BQWQsRUFBUDtBQUNELENBakJEOztRQW9CRXhDLGEsR0FBQUEsYTtRQUNBTSxTLEdBQUFBLFM7UUFDQTRELFcsR0FBQUEsVztRQUNBckIsUSxHQUFBQSxRO1FBQ0FsQyxlLEdBQUFBLGU7UUFDQWUsMkIsR0FBQUEsMkI7UUFDQU8sYSxHQUFBQSxhO1FBQ0FULG1CLEdBQUFBLG1CO1FBQ0FGLGlCLEdBQUFBLGlCO1FBQ0FxRCxlLEdBQUFBLGU7UUFDQVosSSxHQUFBQSxJIiwiZmlsZSI6InV0aWxzLmpzIiwic291cmNlUm9vdCI6Ii9ob21lL215dWdhLy5hdG9tL3BhY2thZ2VzL2dvLXBsdXMvbGliIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IGZzIGZyb20gJ2ZzJ1xuaW1wb3J0IHsgVGV4dEVkaXRvciwgUG9pbnQgfSBmcm9tICdhdG9tJ1xuXG5jb25zdCBpc1ZhbGlkRWRpdG9yID0gKGU6ID9UZXh0RWRpdG9yKTogYm9vbGVhbiAlY2hlY2tzID0+IHtcbiAgcmV0dXJuICEhZSAmJiBoYXNHb0dyYW1tYXIoZS5nZXRHcmFtbWFyKCkpXG59XG5cbmNvbnN0IGhhc0dvR3JhbW1hciA9IChnOiA/YXRvbSRHcmFtbWFyKTogYm9vbGVhbiAlY2hlY2tzID0+IHtcbiAgcmV0dXJuICEhZyAmJiAoZy5zY29wZU5hbWUgPT09ICdzb3VyY2UuZ28nIHx8IGcuc2NvcGVOYW1lID09PSAnZ28nKVxufVxuXG5jb25zdCBnZXRFZGl0b3IgPSAoKTogP1RleHRFZGl0b3IgPT4ge1xuICBpZiAoIWF0b20gfHwgIWF0b20ud29ya3NwYWNlKSB7XG4gICAgcmV0dXJuXG4gIH1cbiAgY29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpXG4gIGlmICghaXNWYWxpZEVkaXRvcihlZGl0b3IpKSB7XG4gICAgcmV0dXJuXG4gIH1cblxuICByZXR1cm4gZWRpdG9yXG59XG5cbmNvbnN0IGdldFdvcmRQb3NpdGlvbiA9IChcbiAgZWRpdG9yOiA/VGV4dEVkaXRvciA9IGdldEVkaXRvcigpXG4pOiA/YXRvbSRQb2ludExpa2UgPT4ge1xuICBpZiAoIWVkaXRvcikge1xuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuXG4gIGNvbnN0IGN1cnNvciA9IGVkaXRvci5nZXRMYXN0Q3Vyc29yKClcbiAgY29uc3QgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpXG5cbiAgaWYgKCFjdXJzb3IgfHwgIWJ1ZmZlcikge1xuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuXG4gIGxldCB3b3JkUG9zaXRpb24gPSBjdXJzb3IuZ2V0Q3VycmVudFdvcmRCdWZmZXJSYW5nZSgpXG4gIGxldCBzdGFydCA9IGJ1ZmZlci5jaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uKHdvcmRQb3NpdGlvbi5zdGFydClcbiAgbGV0IGVuZCA9IGJ1ZmZlci5jaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uKHdvcmRQb3NpdGlvbi5lbmQpXG4gIHJldHVybiBbc3RhcnQsIGVuZF1cbn1cblxuY29uc3QgZ2V0Q3Vyc29yUG9zaXRpb24gPSAoZWRpdG9yOiBUZXh0RWRpdG9yKSA9PiB7XG4gIGlmICghZWRpdG9yKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZFxuICB9XG4gIGNvbnN0IGN1cnNvciA9IGVkaXRvci5nZXRMYXN0Q3Vyc29yKClcbiAgaWYgKCFjdXJzb3IpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkXG4gIH1cbiAgcmV0dXJuIGN1cnNvci5nZXRCdWZmZXJQb3NpdGlvbigpXG59XG5cbmNvbnN0IGN1cnJlbnRDdXJzb3JPZmZzZXQgPSAoZWRpdG9yOiBUZXh0RWRpdG9yKSA9PiB7XG4gIGlmICghZWRpdG9yKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZFxuICB9XG5cbiAgY29uc3QgcG9zID0gZ2V0Q3Vyc29yUG9zaXRpb24oZWRpdG9yKVxuICBpZiAoIXBvcykge1xuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxuXG4gIHJldHVybiB1dGY4T2Zmc2V0Rm9yQnVmZmVyUG9zaXRpb24ocG9zLCBlZGl0b3IpXG59XG5cbmNvbnN0IHV0ZjhPZmZzZXRGb3JCdWZmZXJQb3NpdGlvbiA9IChcbiAgcG9zOiBhdG9tJFBvaW50TGlrZSxcbiAgZWRpdG9yOiBUZXh0RWRpdG9yXG4pOiBudW1iZXIgPT4ge1xuICBpZiAoIWVkaXRvciB8fCAhZWRpdG9yLmdldEJ1ZmZlcigpIHx8ICFwb3MpIHtcbiAgICByZXR1cm4gLTFcbiAgfVxuICBjb25zdCBjaGFyYWN0ZXJPZmZzZXQgPSBlZGl0b3IuZ2V0QnVmZmVyKCkuY2hhcmFjdGVySW5kZXhGb3JQb3NpdGlvbihwb3MpXG4gIGNvbnN0IHRleHQgPSBlZGl0b3IuZ2V0VGV4dCgpLnN1YnN0cmluZygwLCBjaGFyYWN0ZXJPZmZzZXQpXG4gIHJldHVybiBCdWZmZXIuYnl0ZUxlbmd0aCh0ZXh0LCAndXRmOCcpXG59XG5cbmNvbnN0IHdvcmRBbmRPZmZzZXQgPSAoXG4gIGVkaXRvcjogVGV4dEVkaXRvclxuKTogeyB3b3JkOiBzdHJpbmcsIG9mZnNldDogbnVtYmVyIH0gPT4ge1xuICBjb25zdCBjdXJzb3IgPSBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpXG4gIGNvbnN0IHJhbmdlID0gY3Vyc29yLmdldEN1cnJlbnRXb3JkQnVmZmVyUmFuZ2UoKVxuICBjb25zdCBtaWRkbGUgPSBuZXcgUG9pbnQoXG4gICAgcmFuZ2Uuc3RhcnQucm93LFxuICAgIE1hdGguZmxvb3IoKHJhbmdlLnN0YXJ0LmNvbHVtbiArIHJhbmdlLmVuZC5jb2x1bW4pIC8gMilcbiAgKVxuICBjb25zdCBjaGFyT2Zmc2V0ID0gZWRpdG9yLmdldEJ1ZmZlcigpLmNoYXJhY3RlckluZGV4Rm9yUG9zaXRpb24obWlkZGxlKVxuICBjb25zdCB0ZXh0ID0gZWRpdG9yLmdldFRleHQoKS5zdWJzdHJpbmcoMCwgY2hhck9mZnNldClcbiAgcmV0dXJuIHtcbiAgICB3b3JkOiBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2UocmFuZ2UpLFxuICAgIG9mZnNldDogQnVmZmVyLmJ5dGVMZW5ndGgodGV4dCwgJ3V0ZjgnKVxuICB9XG59XG5cbi8qKlxuICogT3BlbnMgdGhlIGBmaWxlYCBhbmQgY2VudGVycyB0aGUgZWRpdG9yIGFyb3VuZCB0aGUgYHBvc2BcbiAqIEBwYXJhbSAge3N0cmluZ30gZmlsZSAgUGF0aCB0byB0aGUgZmlsZSB0byBvcGVuLlxuICogQHBhcmFtICB7b2JqZWN0fSBbcG9zXSBBbiBvcHRpb25hbCBvYmplY3QgY29udGFpbmluZyBgcm93YCBhbmQgYGNvbHVtbmAgdG8gc2Nyb2xsIHRvLlxuICogQHJldHVybiB7UHJvbWlzZX0gUmV0dXJucyBhIHByb21pc2Ugd2hpY2ggcmVzb2x2ZXMgd2l0aCB0aGUgb3BlbmVkIGVkaXRvclxuICovXG5jb25zdCBvcGVuRmlsZSA9IGFzeW5jIChcbiAgZmlsZTogc3RyaW5nLFxuICBwb3M/OiA/YXRvbSRQb2ludFxuKTogUHJvbWlzZTxUZXh0RWRpdG9yPiA9PiB7XG4gIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBmcy5hY2Nlc3MoZmlsZSwgZnMuY29uc3RhbnRzLkZfT0sgfCBmcy5jb25zdGFudHMuUl9PSywgZXJyID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICByZXNvbHZlKClcbiAgICB9KVxuICB9KVxuICAvLyBzZWFyY2hBbGxQYW5lcyBhdm9pZHMgb3BlbmluZyBhIGZpbGUgaW4gYW5vdGhlciBzcGxpdCBwYW5lIGlmIGl0IGlzIGFscmVhZHkgb3BlbiBpbiBvbmVcbiAgY29uc3Qgb3B0aW9ucyA9IHt9XG4gIG9wdGlvbnMuc2VhcmNoQWxsUGFuZXMgPSB0cnVlXG4gIGlmIChwb3MgJiYgcG9zLnJvdykge1xuICAgIG9wdGlvbnMuaW5pdGlhbExpbmUgPSBwb3Mucm93XG4gIH1cbiAgaWYgKHBvcyAmJiBwb3MuY29sdW1uKSB7XG4gICAgb3B0aW9ucy5pbml0aWFsQ29sdW1uID0gcG9zLmNvbHVtblxuICB9XG4gIGNvbnN0IGVkaXRvciA9IGF3YWl0IGF0b20ud29ya3NwYWNlLm9wZW4oZmlsZSwgb3B0aW9ucylcbiAgaWYgKHBvcykge1xuICAgIGVkaXRvci5zY3JvbGxUb0J1ZmZlclBvc2l0aW9uKHBvcywgeyBjZW50ZXI6IHRydWUgfSlcbiAgfVxuICByZXR1cm4gZWRpdG9yXG59XG5cbmNvbnN0IHN0YXQgPSAobG9jOiBzdHJpbmcpOiBQcm9taXNlPGZzLlN0YXRzPiA9PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgZnMuc3RhdChsb2MsIChlcnIsIHN0YXRzKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJlamVjdChlcnIpXG4gICAgICB9XG4gICAgICByZXNvbHZlKHN0YXRzKVxuICAgIH0pXG4gIH0pXG59XG5cbmNvbnN0IHByb2plY3RQYXRoID0gKCk6ID9zdHJpbmcgPT4ge1xuICBjb25zdCBkaXJzID0gYXRvbS5wcm9qZWN0XG4gICAgLmdldERpcmVjdG9yaWVzKClcbiAgICAuZmlsdGVyKGRpciA9PiAhZGlyLmdldFBhdGgoKS5pbmNsdWRlcygnOi8vJykpXG4gIGlmIChkaXJzICYmIGRpcnMubGVuZ3RoID4gMCkge1xuICAgIHJldHVybiBkaXJzWzBdLmdldFBhdGgoKVxuICB9XG4gIHJldHVybiB1bmRlZmluZWRcbn1cblxuZXhwb3J0IHR5cGUgR29Qb3MgPSB7XG4gIGZpbGU6IHN0cmluZyxcbiAgbGluZT86IG51bWJlcixcbiAgY29sdW1uPzogbnVtYmVyXG59XG5cbmNvbnN0IHBhcnNlR29Qb3NpdGlvbiA9IChpZGVudGlmaWVyOiBzdHJpbmcpOiBHb1BvcyA9PiB7XG4gIGlmICghaWRlbnRpZmllci5pbmNsdWRlcygnOicpKSB7XG4gICAgcmV0dXJuIHsgZmlsZTogaWRlbnRpZmllciB9XG4gIH1cblxuICBjb25zdCB3aW5kb3dzID0gaWRlbnRpZmllclsxXSA9PT0gJzonXG4gIGNvbnN0IG9mZnNldCA9IHdpbmRvd3MgPyAxIDogMFxuXG4gIGNvbnN0IGNvbXBvbmVudHMgPSBpZGVudGlmaWVyLnRyaW0oKS5zcGxpdCgnOicpXG4gIGNvbnN0IGhhc0xpbmUgPSBjb21wb25lbnRzLmxlbmd0aCA+PSAyICsgb2Zmc2V0XG4gIGNvbnN0IGhhc0NvbHVtbiA9IGNvbXBvbmVudHMubGVuZ3RoID4gMiArIG9mZnNldFxuXG4gIGNvbnN0IGNvbHVtbiA9IGhhc0NvbHVtbiA/IHBhcnNlSW50KGNvbXBvbmVudHMucG9wKCksIDEwKSA6IHVuZGVmaW5lZFxuICBjb25zdCBsaW5lID0gaGFzTGluZSA/IHBhcnNlSW50KGNvbXBvbmVudHMucG9wKCksIDEwKSA6IHVuZGVmaW5lZFxuICBjb25zdCBmaWxlID0gY29tcG9uZW50cy5qb2luKCc6JylcblxuICByZXR1cm4geyBmaWxlLCBsaW5lLCBjb2x1bW4gfVxufVxuXG5leHBvcnQge1xuICBpc1ZhbGlkRWRpdG9yLFxuICBnZXRFZGl0b3IsXG4gIHByb2plY3RQYXRoLFxuICBvcGVuRmlsZSxcbiAgZ2V0V29yZFBvc2l0aW9uLFxuICB1dGY4T2Zmc2V0Rm9yQnVmZmVyUG9zaXRpb24sXG4gIHdvcmRBbmRPZmZzZXQsXG4gIGN1cnJlbnRDdXJzb3JPZmZzZXQsXG4gIGdldEN1cnNvclBvc2l0aW9uLFxuICBwYXJzZUdvUG9zaXRpb24sXG4gIHN0YXRcbn1cbiJdfQ==