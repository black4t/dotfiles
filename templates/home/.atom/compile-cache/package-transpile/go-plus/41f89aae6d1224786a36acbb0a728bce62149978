Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.OutputPanel = undefined;

var _atom = require('atom');

var _etch = require('etch');

var _etch2 = _interopRequireDefault(_etch);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _etchComponent = require('./etch-component');

var _ansi = require('./ansi');

var _utils = require('./utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// eslint-disable-line no-unused-vars

/** @jsx etch.dom */
/* eslint-disable react/no-unknown-property */
/* eslint-disable react/no-string-refs */

const locationRegex = /([\w-/.\\:]*.go:\d+(:\d+)?)/g;

class OutputPanel extends _etchComponent.EtchComponent {

  constructor(props = {}) {
    super(props);
    if (this.props.model) {
      this.props.model.view = this;
    }
  }

  makeLink(text) {
    const elements = [];
    let lastIndex = 0;
    let match;

    do {
      match = locationRegex.exec(text);
      if (match && match.hasOwnProperty('index')) {
        // take raw text up to this match
        elements.push(_etch2.default.dom(
          'span',
          null,
          text.slice(lastIndex, match.index)
        ));

        const linkText = match[0];
        // convert the match to a link
        elements.push(_etch2.default.dom(
          'a',
          {
            onclick: () => this.linkClicked(linkText, this.props.model.props.dir)
          },
          linkText
        ));
        lastIndex = match.index + match[0].length;
      }
    } while (match);

    // raw text from last match to the end
    if (lastIndex < text.length) {
      elements.push(_etch2.default.dom(
        'span',
        null,
        text.slice(lastIndex)
      ));
    }

    return elements;
  }

  render() {
    let style = '';
    let output = '';
    if (this.props.model && this.props.model.props && this.props.model.props.output) {
      output = this.props.model.props.output;
    }

    return _etch2.default.dom(
      'div',
      {
        ref: 'content',
        className: 'go-plus-output-panel',
        scrollTop: this.scrollHeight,
        style: style
      },
      _etch2.default.dom(_ansi.AnsiStyle, { text: output, mapText: this.makeLink.bind(this) })
    );
  }

  linkClicked(text, dir) {
    const { file, line = 1, column = 0 } = (0, _utils.parseGoPosition)(text);

    let filepath;
    if (_path2.default.isAbsolute(file)) {
      filepath = file;
    } else {
      const base = dir || (0, _utils.projectPath)();
      if (!base) {
        return;
      }
      filepath = _path2.default.join(base, file);
    }

    const col = column && column > 0 ? column - 1 : 0;
    (0, _utils.openFile)(filepath, _atom.Point.fromObject([line - 1, col])).catch(err => {
      console.log('could not access ' + file, err); // eslint-disable-line no-console
    });
  }

  readAfterUpdate() {
    const content = this.refs.content;
    if (!content) {
      return;
    }

    const scrollHeight = content.scrollHeight;
    if (scrollHeight && this.scrollHeight !== scrollHeight) {
      this.scrollHeight = scrollHeight;
      content.scrollTop = this.scrollHeight;
      this.update();
    }
  }

  dispose() {
    this.destroy();
  }

  destroy() {
    super.destroy();
    this.props = {};
  }
}
exports.OutputPanel = OutputPanel;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm91dHB1dC1wYW5lbC5qcyJdLCJuYW1lcyI6WyJsb2NhdGlvblJlZ2V4IiwiT3V0cHV0UGFuZWwiLCJFdGNoQ29tcG9uZW50IiwiY29uc3RydWN0b3IiLCJwcm9wcyIsIm1vZGVsIiwidmlldyIsIm1ha2VMaW5rIiwidGV4dCIsImVsZW1lbnRzIiwibGFzdEluZGV4IiwibWF0Y2giLCJleGVjIiwiaGFzT3duUHJvcGVydHkiLCJwdXNoIiwic2xpY2UiLCJpbmRleCIsImxpbmtUZXh0IiwibGlua0NsaWNrZWQiLCJkaXIiLCJsZW5ndGgiLCJyZW5kZXIiLCJzdHlsZSIsIm91dHB1dCIsInNjcm9sbEhlaWdodCIsImJpbmQiLCJmaWxlIiwibGluZSIsImNvbHVtbiIsImZpbGVwYXRoIiwicGF0aCIsImlzQWJzb2x1dGUiLCJiYXNlIiwiam9pbiIsImNvbCIsIlBvaW50IiwiZnJvbU9iamVjdCIsImNhdGNoIiwiZXJyIiwiY29uc29sZSIsImxvZyIsInJlYWRBZnRlclVwZGF0ZSIsImNvbnRlbnQiLCJyZWZzIiwic2Nyb2xsVG9wIiwidXBkYXRlIiwiZGlzcG9zZSIsImRlc3Ryb3kiXSwibWFwcGluZ3MiOiI7Ozs7O0FBS0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBSndCOztBQUx4QjtBQUNBO0FBQ0E7O0FBU0EsTUFBTUEsZ0JBQWdCLDhCQUF0Qjs7QUFFTyxNQUFNQyxXQUFOLFNBQTBCQyw0QkFBMUIsQ0FBd0M7O0FBRzdDQyxjQUFZQyxRQUFnQixFQUE1QixFQUFnQztBQUM5QixVQUFNQSxLQUFOO0FBQ0EsUUFBSSxLQUFLQSxLQUFMLENBQVdDLEtBQWYsRUFBc0I7QUFDcEIsV0FBS0QsS0FBTCxDQUFXQyxLQUFYLENBQWlCQyxJQUFqQixHQUF3QixJQUF4QjtBQUNEO0FBQ0Y7O0FBRURDLFdBQVNDLElBQVQsRUFBdUI7QUFDckIsVUFBTUMsV0FBVyxFQUFqQjtBQUNBLFFBQUlDLFlBQVksQ0FBaEI7QUFDQSxRQUFJQyxLQUFK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LFlBQTFDLEVBQXdEO0FBQ3RELFdBQUtBLFlBQUwsR0FBb0JBLFlBQXBCO0FBQ0FrQixjQUFRRSxTQUFSLEdBQW9CLEtBQUtwQixZQUF6QjtBQUNBLFdBQUtxQixNQUFMO0FBQ0Q7QUFDRjs7QUFFREMsWUFBVTtBQUNSLFNBQUtDLE9BQUw7QUFDRDs7QUFFREEsWUFBVTtBQUNSLFVBQU1BLE9BQU47QUFDQSxTQUFLM0MsS0FBTCxHQUFhLEVBQWI7QUFDRDtBQTVHNEM7UUFBbENILFcsR0FBQUEsVyIsImZpbGUiOiJvdXRwdXQtcGFuZWwuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvbXl1Z2EvLmF0b20vcGFja2FnZXMvZ28tcGx1cy9saWIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuLyoqIEBqc3ggZXRjaC5kb20gKi9cbi8qIGVzbGludC1kaXNhYmxlIHJlYWN0L25vLXVua25vd24tcHJvcGVydHkgKi9cbi8qIGVzbGludC1kaXNhYmxlIHJlYWN0L25vLXN0cmluZy1yZWZzICovXG5cbmltcG9ydCB7IFBvaW50IH0gZnJvbSAnYXRvbSdcbmltcG9ydCBldGNoIGZyb20gJ2V0Y2gnIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdW51c2VkLXZhcnNcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgeyBFdGNoQ29tcG9uZW50IH0gZnJvbSAnLi9ldGNoLWNvbXBvbmVudCdcbmltcG9ydCB7IEFuc2lTdHlsZSB9IGZyb20gJy4vYW5zaSdcbmltcG9ydCB7IG9wZW5GaWxlLCBwYXJzZUdvUG9zaXRpb24sIHByb2plY3RQYXRoIH0gZnJvbSAnLi91dGlscydcblxuY29uc3QgbG9jYXRpb25SZWdleCA9IC8oW1xcdy0vLlxcXFw6XSouZ286XFxkKyg6XFxkKyk/KS9nXG5cbmV4cG9ydCBjbGFzcyBPdXRwdXRQYW5lbCBleHRlbmRzIEV0Y2hDb21wb25lbnQge1xuICBzY3JvbGxIZWlnaHQ6IG51bWJlclxuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBPYmplY3QgPSB7fSkge1xuICAgIHN1cGVyKHByb3BzKVxuICAgIGlmICh0aGlzLnByb3BzLm1vZGVsKSB7XG4gICAgICB0aGlzLnByb3BzLm1vZGVsLnZpZXcgPSB0aGlzXG4gICAgfVxuICB9XG5cbiAgbWFrZUxpbmsodGV4dDogc3RyaW5nKSB7XG4gICAgY29uc3QgZWxlbWVudHMgPSBbXVxuICAgIGxldCBsYXN0SW5kZXggPSAwXG4gICAgbGV0IG1hdGNoXG5cbiAgICBkbyB7XG4gICAgICBtYXRjaCA9IGxvY2F0aW9uUmVnZXguZXhlYyh0ZXh0KVxuICAgICAgaWYgKG1hdGNoICYmIG1hdGNoLmhhc093blByb3BlcnR5KCdpbmRleCcpKSB7XG4gICAgICAgIC8vIHRha2UgcmF3IHRleHQgdXAgdG8gdGhpcyBtYXRjaFxuICAgICAgICBlbGVtZW50cy5wdXNoKDxzcGFuPnt0ZXh0LnNsaWNlKGxhc3RJbmRleCwgbWF0Y2guaW5kZXgpfTwvc3Bhbj4pXG5cbiAgICAgICAgY29uc3QgbGlua1RleHQgPSBtYXRjaFswXVxuICAgICAgICAvLyBjb252ZXJ0IHRoZSBtYXRjaCB0byBhIGxpbmtcbiAgICAgICAgZWxlbWVudHMucHVzaChcbiAgICAgICAgICA8YVxuICAgICAgICAgICAgb25jbGljaz17KCkgPT5cbiAgICAgICAgICAgICAgdGhpcy5saW5rQ2xpY2tlZChsaW5rVGV4dCwgdGhpcy5wcm9wcy5tb2RlbC5wcm9wcy5kaXIpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgPlxuICAgICAgICAgICAge2xpbmtUZXh0fVxuICAgICAgICAgIDwvYT5cbiAgICAgICAgKVxuICAgICAgICBsYXN0SW5kZXggPSBtYXRjaC5pbmRleCArIG1hdGNoWzBdLmxlbmd0aFxuICAgICAgfVxuICAgIH0gd2hpbGUgKG1hdGNoKVxuXG4gICAgLy8gcmF3IHRleHQgZnJvbSBsYXN0IG1hdGNoIHRvIHRoZSBlbmRcbiAgICBpZiAobGFzdEluZGV4IDwgdGV4dC5sZW5ndGgpIHtcbiAgICAgIGVsZW1lbnRzLnB1c2goPHNwYW4+e3RleHQuc2xpY2UobGFzdEluZGV4KX08L3NwYW4+KVxuICAgIH1cblxuICAgIHJldHVybiBlbGVtZW50c1xuICB9XG5cbiAgcmVuZGVyKCkge1xuICAgIGxldCBzdHlsZSA9ICcnXG4gICAgbGV0IG91dHB1dCA9ICcnXG4gICAgaWYgKFxuICAgICAgdGhpcy5wcm9wcy5tb2RlbCAmJlxuICAgICAgdGhpcy5wcm9wcy5tb2RlbC5wcm9wcyAmJlxuICAgICAgdGhpcy5wcm9wcy5tb2RlbC5wcm9wcy5vdXRwdXRcbiAgICApIHtcbiAgICAgIG91dHB1dCA9IHRoaXMucHJvcHMubW9kZWwucHJvcHMub3V0cHV0XG4gICAgfVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXZcbiAgICAgICAgcmVmPVwiY29udGVudFwiXG4gICAgICAgIGNsYXNzTmFtZT1cImdvLXBsdXMtb3V0cHV0LXBhbmVsXCJcbiAgICAgICAgc2Nyb2xsVG9wPXt0aGlzLnNjcm9sbEhlaWdodH1cbiAgICAgICAgc3R5bGU9e3N0eWxlfVxuICAgICAgPlxuICAgICAgICA8QW5zaVN0eWxlIHRleHQ9e291dHB1dH0gbWFwVGV4dD17dGhpcy5tYWtlTGluay5iaW5kKHRoaXMpfSAvPlxuICAgICAgPC9kaXY+XG4gICAgKVxuICB9XG5cbiAgbGlua0NsaWNrZWQodGV4dDogc3RyaW5nLCBkaXI6IHN0cmluZykge1xuICAgIGNvbnN0IHsgZmlsZSwgbGluZSA9IDEsIGNvbHVtbiA9IDAgfSA9IHBhcnNlR29Qb3NpdGlvbih0ZXh0KVxuXG4gICAgbGV0IGZpbGVwYXRoXG4gICAgaWYgKHBhdGguaXNBYnNvbHV0ZShmaWxlKSkge1xuICAgICAgZmlsZXBhdGggPSBmaWxlXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGJhc2UgPSBkaXIgfHwgcHJvamVjdFBhdGgoKVxuICAgICAgaWYgKCFiYXNlKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgZmlsZXBhdGggPSBwYXRoLmpvaW4oYmFzZSwgZmlsZSlcbiAgICB9XG5cbiAgICBjb25zdCBjb2wgPSBjb2x1bW4gJiYgY29sdW1uID4gMCA/IGNvbHVtbiAtIDEgOiAwXG4gICAgb3BlbkZpbGUoZmlsZXBhdGgsIFBvaW50LmZyb21PYmplY3QoW2xpbmUgLSAxLCBjb2xdKSkuY2F0Y2goZXJyID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKCdjb3VsZCBub3QgYWNjZXNzICcgKyBmaWxlLCBlcnIpIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuICAgIH0pXG4gIH1cblxuICByZWFkQWZ0ZXJVcGRhdGUoKSB7XG4gICAgY29uc3QgY29udGVudCA9IHRoaXMucmVmcy5jb250ZW50XG4gICAgaWYgKCFjb250ZW50KSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBjb25zdCBzY3JvbGxIZWlnaHQgPSBjb250ZW50LnNjcm9sbEhlaWdodFxuICAgIGlmIChzY3JvbGxIZWlnaHQgJiYgdGhpcy5zY3JvbGxIZWlnaHQgIT09IHNjcm9sbEhlaWdodCkge1xuICAgICAgdGhpcy5zY3JvbGxIZWlnaHQgPSBzY3JvbGxIZWlnaHRcbiAgICAgIGNvbnRlbnQuc2Nyb2xsVG9wID0gdGhpcy5zY3JvbGxIZWlnaHRcbiAgICAgIHRoaXMudXBkYXRlKClcbiAgICB9XG4gIH1cblxuICBkaXNwb3NlKCkge1xuICAgIHRoaXMuZGVzdHJveSgpXG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIHN1cGVyLmRlc3Ryb3koKVxuICAgIHRoaXMucHJvcHMgPSB7fVxuICB9XG59XG4iXX0=