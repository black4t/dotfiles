"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
class GoCode {
    constructor(core) {
        this.core = core;
    }
    getSuggestions(request) {
        return new Promise((resolve, _) => {
            const { bufferPosition, editor } = request;
            const buffer = editor.getBuffer();
            const index = buffer.characterIndexForPosition(bufferPosition);
            const filePath = editor.getPath();
            if (!filePath) {
                resolve(null);
            }
            this.core.spawn("gocode", ["-f=json", "autocomplete", String(filePath), String(index)], {
                cwd: filePath && path.dirname(filePath),
                input: editor.getText(),
            }).then((output) => {
                const results = JSON.parse(output);
                if (results.length < 2) {
                    resolve(null);
                    return;
                }
                resolve(results[1].map((src) => ({
                    className: src.type,
                    text: src.name,
                    type: src.class,
                })));
            }).catch((err) => {
                this.core.logTrace(err);
                resolve(null);
            });
        });
    }
}
exports.GoCode = GoCode;
