Object.defineProperty(exports, '__esModule', {
  value: true
});

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var _redux = require('redux');

var _storeUtils = require('./store-utils');

'use babel';

var assign = function assign() {
  for (var _len = arguments.length, items = Array(_len), _key = 0; _key < _len; _key++) {
    items[_key] = arguments[_key];
  }

  return Object.assign.apply(Object, [{}].concat(items));
};

function updateArrayItem(array, index, o) {
  if (index === -1) {
    return array;
  }
  return array.slice(0, index).concat(assign(array[index], o), array.slice(index + 1));
}
function removeArrayItem(array, index) {
  return index === -1 ? array : array.slice(0, index).concat(array.slice(index + 1));
}

function stacktrace(state, action) {
  if (state === undefined) state = [];

  switch (action.type) {
    case 'RESTART':
    case 'STOP':
      return [];

    case 'UPDATE_STACKTRACE':
      // attempt to copy the variables over to the new stacktrace
      return action.stacktrace.map(function (stack) {
        var existingStack = state.find(function (st, i) {
          return i > 0 && st.id === stack.id;
        });
        if (!stack.variables && existingStack) {
          stack.variables = existingStack.variables;
        }
        return stack;
      });

    case 'UPDATE_VARIABLES':
      var variables = state[action.stacktraceIndex].variables;
      if (action.path) {
        // update the variable at "path" to loaded
        variables = assign(variables, _defineProperty({}, action.path, assign(variables[action.path], { loaded: true })));
      }

      variables = assign(variables, action.variables);
      return updateArrayItem(state, action.stacktraceIndex, { variables: variables });
  }
  return state;
}
function goroutines(state, action) {
  if (state === undefined) state = [];

  switch (action.type) {
    case 'RESTART':
    case 'STOP':
      return [];

    case 'UPDATE_GOROUTINES':
      return action.goroutines;
  }
  return state;
}
var bpNamePostfix = 0;
var breakpointSorter = function breakpointSorter(a, b) {
  var s = a.file.localeCompare(b.file);
  return s !== 0 ? s : a.line - b.line;
};
function breakpoints(state, action) {
  if (state === undefined) state = [];
  var bp = action.bp;

  var _ref2 = bp || {};

  var name = _ref2.name;
  var file = _ref2.file;
  var line = _ref2.line;

  var index = name ? (0, _storeUtils.indexOfBreakpointByName)(state, name) : (0, _storeUtils.indexOfBreakpoint)(state, file, line);
  switch (action.type) {
    case 'ADD_BREAKPOINT':
      if (index === -1) {
        bp.name = 'bp' + bpNamePostfix++;
        return state.concat(bp).sort(breakpointSorter);
      }
      return state;

    case 'REMOVE_BREAKPOINT':
      return removeArrayItem(state, index);

    case 'EDIT_BREAKPOINT':
      if (index !== -1) {
        if (bp.state !== 'error') {
          bp = assign(bp, { message: null });
        }
        return updateArrayItem(state, index, bp);
      }
      return state;

    case 'STOP':
      return state.map(function (bp) {
        var changes = { state: 'notStarted' };
        if (bp.state === 'error') {
          changes.message = null;
        }
        return assign(bp, changes);
      });

    case 'INIT_STORE':
      return state.map(function (bp) {
        return assign(bp, { name: 'bp' + bpNamePostfix++, state: 'notStarted' });
      }).sort(breakpointSorter);
  }

  return state;
}
function state(state, action) {
  if (state === undefined) state = 'notStarted';

  switch (action.type) {
    case 'STOP':
      return 'notStarted';

    case 'RESTART':
      return 'waiting';

    case 'SET_STATE':
      return action.state;
  }
  return state;
}
function selectedStacktrace(state, action) {
  if (state === undefined) state = 0;

  switch (action.type) {
    case 'RESTART':
    case 'STOP':
      return 0;

    case 'SET_SELECTED_STACKTRACE':
      return action.index;

    case 'UPDATE_STACKTRACE':
      return 0; // set back to the first function on each update
  }
  return state;
}
function selectedGoroutine(state, action) {
  if (state === undefined) state = 0;

  switch (action.type) {
    case 'RESTART':
    case 'STOP':
      return 0;

    case 'SET_SELECTED_GOROUTINE':
      return action.id;
  }
  return state;
}
var defaultWatchExpressionVariables = function defaultWatchExpressionVariables(expr) {
  return _defineProperty({}, expr, {
    name: expr,
    loaded: true,
    hasChildren: false,
    value: '<not available>',
    parentPath: '',
    type: 'string'
  });
};
function watchExpressions(state, action) {
  if (state === undefined) state = [];

  switch (action.type) {
    case 'RESTART':
    case 'STOP':
      return state.map(function (o) {
        return assign(o, { variables: defaultWatchExpressionVariables(o.expr) });
      });

    case 'ADD_WATCH_EXPRESSION':
      return state.concat({
        expr: action.expr,
        variables: defaultWatchExpressionVariables(action.expr)
      });

    case 'REMOVE_WATCH_EXPRESSION':
      {
        var index = state.findIndex(function (o) {
          return o.expr === action.expr;
        });
        return removeArrayItem(state, index);
      }

    case 'SET_WATCH_EXPRESSION_VARIABLES':
      {
        var index = state.findIndex(function (o) {
          return o.expr === action.expr;
        });
        return updateArrayItem(state, index, {
          variables: action.variables
        });
      }
  }
  return state;
}

var delve = (0, _redux.combineReducers)({
  stacktrace: stacktrace,
  goroutines: goroutines,
  breakpoints: breakpoints,
  state: state,
  selectedStacktrace: selectedStacktrace,
  selectedGoroutine: selectedGoroutine,
  watchExpressions: watchExpressions
});

function content(state, action) {
  if (state === undefined) state = [];

  switch (action.type) {
    case 'CLEAR_OUTPUT_CONTENT':
      return [];

    case 'ADD_OUTPUT_CONTENT':
      return state.concat(action.content);
  }
  return state;
}

var output = (0, _redux.combineReducers)({
  content: content
});

function selectedConfig(state, action) {
  if (state === undefined) state = '';

  switch (action.type) {
    case 'SET_SELECTED_CONFIG':
      return action.configName || '';
  }
  return state;
}
function configurations(state, action) {
  if (state === undefined) state = [];

  if (action.type === 'SET_CONFIGURATION') {
    return action.configurations;
  }
  return state;
}

exports['default'] = function (state) {
  if (state && state.panel) {
    delete state.panel;
  }

  var store = (0, _redux.createStore)((0, _redux.combineReducers)({
    delve: delve,
    output: output,
    selectedConfig: selectedConfig,
    configurations: configurations
  }), state);

  // init the store (upgrades the previous state so it is usable again)
  store.dispatch({ type: 'INIT_STORE' });

  return store;
};

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL215dWdhLy5hdG9tL3BhY2thZ2VzL2dvLWRlYnVnL2xpYi9zdG9yZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7cUJBRTZDLE9BQU87OzBCQUNPLGVBQWU7O0FBSDFFLFdBQVcsQ0FBQTs7QUFLWCxJQUFNLE1BQU0sR0FBRyxTQUFULE1BQU07b0NBQU8sS0FBSztBQUFMLFNBQUs7OztTQUFLLE1BQU0sQ0FBQyxNQUFNLE1BQUEsQ0FBYixNQUFNLEdBQVEsRUFBRSxTQUFLLEtBQUssRUFBQztDQUFBLENBQUE7O0FBRXhELFNBQVMsZUFBZSxDQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFO0FBQ3pDLE1BQUksS0FBSyxLQUFLLENBQUMsQ0FBQyxFQUFFO0FBQ2hCLFdBQU8sS0FBSyxDQUFBO0dBQ2I7QUFDRCxTQUFPLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FDakMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsRUFDdkIsS0FBSyxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQ3ZCLENBQUE7Q0FDRjtBQUNELFNBQVMsZUFBZSxDQUFFLEtBQUssRUFBRSxLQUFLLEVBQUU7QUFDdEMsU0FBTyxLQUFLLEtBQUssQ0FBQyxDQUFDLEdBQUcsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO0NBQ25GOztBQUVELFNBQVMsVUFBVSxDQUFFLEtBQUssRUFBTyxNQUFNLEVBQUU7TUFBcEIsS0FBSyxnQkFBTCxLQUFLLEdBQUcsRUFBRTs7QUFDN0IsVUFBUSxNQUFNLENBQUMsSUFBSTtBQUNqQixTQUFLLFNBQVMsQ0FBQztBQUNmLFNBQUssTUFBTTtBQUNULGFBQU8s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QUFFO0FBQ3ZDLFdBQU8sTUFBTSxDQUFDLGNBQWMsQ0FBQTtHQUM3QjtBQUNELFNBQU8sS0FBSyxDQUFBO0NBQ2I7O3FCQUVjLFVBQVUsS0FBSyxFQUFFO0FBQzlCLE1BQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUU7QUFDeEIsV0FBTyxLQUFLLENBQUMsS0FBSyxDQUFBO0dBQ25COztBQUVELE1BQU0sS0FBSyxHQUFHLHdCQUFZLDRCQUFnQjtBQUN4QyxTQUFLLEVBQUwsS0FBSztBQUNMLFVBQU0sRUFBTixNQUFNO0FBQ04sa0JBQWMsRUFBZCxjQUFjO0FBQ2Qsa0JBQWMsRUFBZCxjQUFjO0dBQ2YsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFBOzs7QUFHVixPQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUE7O0FBRXRDLFNBQU8sS0FBSyxDQUFBO0NBQ2IiLCJmaWxlIjoiL2hvbWUvbXl1Z2EvLmF0b20vcGFja2FnZXMvZ28tZGVidWcvbGliL3N0b3JlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCdcblxuaW1wb3J0IHsgY3JlYXRlU3RvcmUsIGNvbWJpbmVSZWR1Y2VycyB9IGZyb20gJ3JlZHV4J1xuaW1wb3J0IHsgaW5kZXhPZkJyZWFrcG9pbnQsIGluZGV4T2ZCcmVha3BvaW50QnlOYW1lIH0gZnJvbSAnLi9zdG9yZS11dGlscydcblxuY29uc3QgYXNzaWduID0gKC4uLml0ZW1zKSA9PiBPYmplY3QuYXNzaWduKHt9LCAuLi5pdGVtcylcblxuZnVuY3Rpb24gdXBkYXRlQXJyYXlJdGVtIChhcnJheSwgaW5kZXgsIG8pIHtcbiAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgIHJldHVybiBhcnJheVxuICB9XG4gIHJldHVybiBhcnJheS5zbGljZSgwLCBpbmRleCkuY29uY2F0KFxuICAgIGFzc2lnbihhcnJheVtpbmRleF0sIG8pLFxuICAgIGFycmF5LnNsaWNlKGluZGV4ICsgMSlcbiAgKVxufVxuZnVuY3Rpb24gcmVtb3ZlQXJyYXlJdGVtIChhcnJheSwgaW5kZXgpIHtcbiAgcmV0dXJuIGluZGV4ID09PSAtMSA/IGFycmF5IDogYXJyYXkuc2xpY2UoMCwgaW5kZXgpLmNvbmNhdChhcnJheS5zbGljZShpbmRleCArIDEpKVxufVxuXG5mdW5jdGlvbiBzdGFja3RyYWNlIChzdGF0ZSA9IFtdLCBhY3Rpb24pIHtcbiAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgIGNhc2UgJ1JFU1RBUlQnOlxuICAgIGNhc2UgJ1NUT1AnOlxuICAgICAgcmV0dXJuIFtdXG5cbiAgICBjYXNlICdVUERBVEVfU1RBQ0tUUkFDRSc6XG4gICAgICAvLyBhdHRlbXB0IHRvIGNvcHkgdGhlIHZhcmlhYmxlcyBvdmVyIHRvIHRoZSBuZXcgc3RhY2t0cmFjZVxuICAgICAgcmV0dXJuIGFjdGlvbi5zdGFja3RyYWNlLm1hcCgoc3RhY2spID0+IHtcbiAgICAgICAgY29uc3QgZXhpc3RpbmdTdGFjayA9IHN0YXRlLmZpbmQoKHN0LCBpKSA9PiBpID4gMCAmJiBzdC5pZCA9PT0gc3RhY2suaWQpXG4gICAgICAgIGlmICghc3RhY2sudmFyaWFibGVzICYmIGV4aXN0aW5nU3RhY2spIHtcbiAgICAgICAgICBzdGFjay52YXJpYWJsZXMgPSBleGlzdGluZ1N0YWNrLnZhcmlhYmxlc1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBzdGFja1xuICAgICAgfSlcblxuICAgIGNhc2UgJ1VQREFURV9WQVJJQUJMRVMnOlxuICAgICAgdmFyIHZhcmlhYmxlcyA9IHN0YXRlW2FjdGlvbi5zdGFja3RyYWNlSW5kZXhdLnZhcmlhYmxlc1xuICAgICAgaWYgKGFjdGlvbi5wYXRoKSB7XG4gICAgICAgIC8vIHVwZGF0ZSB0aGUgdmFyaWFibGUgYXQgXCJwYXRoXCIgdG8gbG9hZGVkXG4gICAgICAgIHZhcmlhYmxlcyA9IGFzc2lnbih2YXJpYWJsZXMsIHtcbiAgICAgICAgICBbYWN0aW9uLnBhdGhdOiBhc3NpZ24odmFyaWFibGVzW2FjdGlvbi5wYXRoXSwgeyBsb2FkZWQ6IHRydWUgfSlcbiAgICAgICAgfSlcbiAgICAgIH1cblxuICAgICAgdmFyaWFibGVzID0gYXNzaWduKHZhcmlhYmxlcywgYWN0aW9uLnZhcmlhYmxlcylcbiAgICAgIHJldHVybiB1cGRhdGVBcnJheUl0ZW0oc3RhdGUsIGFjdGlvbi5zdGFja3RyYWNlSW5kZXgsIHsgdmFyaWFibGVzOiB2YXJpYWJsZXMgfSlcbiAgfVxuICByZXR1cm4gc3RhdGVcbn1cbmZ1bmN0aW9uIGdvcm91dGluZXMgKHN0YXRlID0gW10sIGFjdGlvbikge1xuICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgY2FzZSAnUkVTVEFSVCc6XG4gICAgY2FzZSAnU1RPUCc6XG4gICAgICByZXR1cm4gW11cblxuICAgIGNhc2UgJ1VQREFURV9HT1JPVVRJTkVTJzpcbiAgICAgIHJldHVybiBhY3Rpb24uZ29yb3V0aW5lc1xuICB9XG4gIHJldHVybiBzdGF0ZVxufVxubGV0IGJwTmFtZVBvc3RmaXggPSAwXG5sZXQgYnJlYWtwb2ludFNvcnRlciA9IChhLCBiKSA9PiB7XG4gIGNvbnN0IHMgPSBhLmZpbGUubG9jYWxlQ29tcGFyZShiLmZpbGUpXG4gIHJldHVybiBzICE9PSAwID8gcyA6IChhLmxpbmUgLSBiLmxpbmUpXG59XG5mdW5jdGlvbiBicmVha3BvaW50cyAoc3RhdGUgPSBbXSwgYWN0aW9uKSB7XG4gIGxldCB7IGJwIH0gPSBhY3Rpb25cbiAgY29uc3QgeyBuYW1lLCBmaWxlLCBsaW5lIH0gPSBicCB8fCB7fVxuICBjb25zdCBpbmRleCA9IG5hbWUgPyBpbmRleE9mQnJlYWtwb2ludEJ5TmFtZShzdGF0ZSwgbmFtZSkgOiBpbmRleE9mQnJlYWtwb2ludChzdGF0ZSwgZmlsZSwgbGluZSlcbiAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgIGNhc2UgJ0FERF9CUkVBS1BPSU5UJzpcbiAgICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgICAgYnAubmFtZSA9ICdicCcgKyBicE5hbWVQb3N0Zml4KytcbiAgICAgICAgcmV0dXJuIHN0YXRlLmNvbmNhdChicCkuc29ydChicmVha3BvaW50U29ydGVyKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHN0YXRlXG5cbiAgICBjYXNlICdSRU1PVkVfQlJFQUtQT0lOVCc6XG4gICAgICByZXR1cm4gcmVtb3ZlQXJyYXlJdGVtKHN0YXRlLCBpbmRleClcblxuICAgIGNhc2UgJ0VESVRfQlJFQUtQT0lOVCc6XG4gICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgIGlmIChicC5zdGF0ZSAhPT0gJ2Vycm9yJykge1xuICAgICAgICAgIGJwID0gYXNzaWduKGJwLCB7IG1lc3NhZ2U6IG51bGwgfSlcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdXBkYXRlQXJyYXlJdGVtKHN0YXRlLCBpbmRleCwgYnApXG4gICAgICB9XG4gICAgICByZXR1cm4gc3RhdGVcblxuICAgIGNhc2UgJ1NUT1AnOlxuICAgICAgcmV0dXJuIHN0YXRlLm1hcCgoYnApID0+IHtcbiAgICAgICAgY29uc3QgY2hhbmdlcyA9IHsgc3RhdGU6ICdub3RTdGFydGVkJyB9XG4gICAgICAgIGlmIChicC5zdGF0ZSA9PT0gJ2Vycm9yJykge1xuICAgICAgICAgIGNoYW5nZXMubWVzc2FnZSA9IG51bGxcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYXNzaWduKGJwLCBjaGFuZ2VzKVxuICAgICAgfSlcblxuICAgIGNhc2UgJ0lOSVRfU1RPUkUnOlxuICAgICAgcmV0dXJuIHN0YXRlLm1hcCgoYnApID0+IHtcbiAgICAgICAgcmV0dXJuIGFzc2lnbihicCwgeyBuYW1lOiAnYnAnICsgYnBOYW1lUG9zdGZpeCsrLCBzdGF0ZTogJ25vdFN0YXJ0ZWQnIH0pXG4gICAgICB9KS5zb3J0KGJyZWFrcG9pbnRTb3J0ZXIpXG4gIH1cblxuICByZXR1cm4gc3RhdGVcbn1cbmZ1bmN0aW9uIHN0YXRlIChzdGF0ZSA9ICdub3RTdGFydGVkJywgYWN0aW9uKSB7XG4gIHN3aXRjaCAoYWN0aW9uLnR5cGUpIHtcbiAgICBjYXNlICdTVE9QJzpcbiAgICAgIHJldHVybiAnbm90U3RhcnRlZCdcblxuICAgIGNhc2UgJ1JFU1RBUlQnOlxuICAgICAgcmV0dXJuICd3YWl0aW5nJ1xuXG4gICAgY2FzZSAnU0VUX1NUQVRFJzpcbiAgICAgIHJldHVybiBhY3Rpb24uc3RhdGVcbiAgfVxuICByZXR1cm4gc3RhdGVcbn1cbmZ1bmN0aW9uIHNlbGVjdGVkU3RhY2t0cmFjZSAoc3RhdGUgPSAwLCBhY3Rpb24pIHtcbiAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgIGNhc2UgJ1JFU1RBUlQnOlxuICAgIGNhc2UgJ1NUT1AnOlxuICAgICAgcmV0dXJuIDBcblxuICAgIGNhc2UgJ1NFVF9TRUxFQ1RFRF9TVEFDS1RSQUNFJzpcbiAgICAgIHJldHVybiBhY3Rpb24uaW5kZXhcblxuICAgIGNhc2UgJ1VQREFURV9TVEFDS1RSQUNFJzpcbiAgICAgIHJldHVybiAwIC8vIHNldCBiYWNrIHRvIHRoZSBmaXJzdCBmdW5jdGlvbiBvbiBlYWNoIHVwZGF0ZVxuICB9XG4gIHJldHVybiBzdGF0ZVxufVxuZnVuY3Rpb24gc2VsZWN0ZWRHb3JvdXRpbmUgKHN0YXRlID0gMCwgYWN0aW9uKSB7XG4gIHN3aXRjaCAoYWN0aW9uLnR5cGUpIHtcbiAgICBjYXNlICdSRVNUQVJUJzpcbiAgICBjYXNlICdTVE9QJzpcbiAgICAgIHJldHVybiAwXG5cbiAgICBjYXNlICdTRVRfU0VMRUNURURfR09ST1VUSU5FJzpcbiAgICAgIHJldHVybiBhY3Rpb24uaWRcbiAgfVxuICByZXR1cm4gc3RhdGVcbn1cbmNvbnN0IGRlZmF1bHRXYXRjaEV4cHJlc3Npb25WYXJpYWJsZXMgPSAoZXhwcikgPT4ge1xuICByZXR1cm4ge1xuICAgIFtleHByXToge1xuICAgICAgbmFtZTogZXhwcixcbiAgICAgIGxvYWRlZDogdHJ1ZSxcbiAgICAgIGhhc0NoaWxkcmVuOiBmYWxzZSxcbiAgICAgIHZhbHVlOiAnPG5vdCBhdmFpbGFibGU+JyxcbiAgICAgIHBhcmVudFBhdGg6ICcnLFxuICAgICAgdHlwZTogJ3N0cmluZydcbiAgICB9XG4gIH1cbn1cbmZ1bmN0aW9uIHdhdGNoRXhwcmVzc2lvbnMgKHN0YXRlID0gW10sIGFjdGlvbikge1xuICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgY2FzZSAnUkVTVEFSVCc6XG4gICAgY2FzZSAnU1RPUCc6XG4gICAgICByZXR1cm4gc3RhdGUubWFwKChvKSA9PiBhc3NpZ24obywgeyB2YXJpYWJsZXM6IGRlZmF1bHRXYXRjaEV4cHJlc3Npb25WYXJpYWJsZXMoby5leHByKSB9KSlcblxuICAgIGNhc2UgJ0FERF9XQVRDSF9FWFBSRVNTSU9OJzpcbiAgICAgIHJldHVybiBzdGF0ZS5jb25jYXQoe1xuICAgICAgICBleHByOiBhY3Rpb24uZXhwcixcbiAgICAgICAgdmFyaWFibGVzOiBkZWZhdWx0V2F0Y2hFeHByZXNzaW9uVmFyaWFibGVzKGFjdGlvbi5leHByKVxuICAgICAgfSlcblxuICAgIGNhc2UgJ1JFTU9WRV9XQVRDSF9FWFBSRVNTSU9OJzoge1xuICAgICAgY29uc3QgaW5kZXggPSBzdGF0ZS5maW5kSW5kZXgoKG8pID0+IG8uZXhwciA9PT0gYWN0aW9uLmV4cHIpXG4gICAgICByZXR1cm4gcmVtb3ZlQXJyYXlJdGVtKHN0YXRlLCBpbmRleClcbiAgICB9XG5cbiAgICBjYXNlICdTRVRfV0FUQ0hfRVhQUkVTU0lPTl9WQVJJQUJMRVMnOiB7XG4gICAgICBjb25zdCBpbmRleCA9IHN0YXRlLmZpbmRJbmRleCgobykgPT4gby5leHByID09PSBhY3Rpb24uZXhwcilcbiAgICAgIHJldHVybiB1cGRhdGVBcnJheUl0ZW0oc3RhdGUsIGluZGV4LCB7XG4gICAgICAgIHZhcmlhYmxlczogYWN0aW9uLnZhcmlhYmxlc1xuICAgICAgfSlcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHN0YXRlXG59XG5cbmNvbnN0IGRlbHZlID0gY29tYmluZVJlZHVjZXJzKHtcbiAgc3RhY2t0cmFjZSxcbiAgZ29yb3V0aW5lcyxcbiAgYnJlYWtwb2ludHMsXG4gIHN0YXRlLFxuICBzZWxlY3RlZFN0YWNrdHJhY2UsXG4gIHNlbGVjdGVkR29yb3V0aW5lLFxuICB3YXRjaEV4cHJlc3Npb25zXG59KVxuXG5mdW5jdGlvbiBjb250ZW50IChzdGF0ZSA9IFtdLCBhY3Rpb24pIHtcbiAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgIGNhc2UgJ0NMRUFSX09VVFBVVF9DT05URU5UJzpcbiAgICAgIHJldHVybiBbXVxuXG4gICAgY2FzZSAnQUREX09VVFBVVF9DT05URU5UJzpcbiAgICAgIHJldHVybiBzdGF0ZS5jb25jYXQoYWN0aW9uLmNvbnRlbnQpXG4gIH1cbiAgcmV0dXJuIHN0YXRlXG59XG5cbmNvbnN0IG91dHB1dCA9IGNvbWJpbmVSZWR1Y2Vycyh7XG4gIGNvbnRlbnRcbn0pXG5cbmZ1bmN0aW9uIHNlbGVjdGVkQ29uZmlnIChzdGF0ZSA9ICcnLCBhY3Rpb24pIHtcbiAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgIGNhc2UgJ1NFVF9TRUxFQ1RFRF9DT05GSUcnOlxuICAgICAgcmV0dXJuIGFjdGlvbi5jb25maWdOYW1lIHx8ICcnXG4gIH1cbiAgcmV0dXJuIHN0YXRlXG59XG5mdW5jdGlvbiBjb25maWd1cmF0aW9ucyAoc3RhdGUgPSBbXSwgYWN0aW9uKSB7XG4gIGlmIChhY3Rpb24udHlwZSA9PT0gJ1NFVF9DT05GSUdVUkFUSU9OJykge1xuICAgIHJldHVybiBhY3Rpb24uY29uZmlndXJhdGlvbnNcbiAgfVxuICByZXR1cm4gc3RhdGVcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKHN0YXRlKSB7XG4gIGlmIChzdGF0ZSAmJiBzdGF0ZS5wYW5lbCkge1xuICAgIGRlbGV0ZSBzdGF0ZS5wYW5lbFxuICB9XG5cbiAgY29uc3Qgc3RvcmUgPSBjcmVhdGVTdG9yZShjb21iaW5lUmVkdWNlcnMoe1xuICAgIGRlbHZlLFxuICAgIG91dHB1dCxcbiAgICBzZWxlY3RlZENvbmZpZyxcbiAgICBjb25maWd1cmF0aW9uc1xuICB9KSwgc3RhdGUpXG5cbiAgLy8gaW5pdCB0aGUgc3RvcmUgKHVwZ3JhZGVzIHRoZSBwcmV2aW91cyBzdGF0ZSBzbyBpdCBpcyB1c2FibGUgYWdhaW4pXG4gIHN0b3JlLmRpc3BhdGNoKHsgdHlwZTogJ0lOSVRfU1RPUkUnIH0pXG5cbiAgcmV0dXJuIHN0b3JlXG59XG4iXX0=